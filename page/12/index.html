<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="baidu-site-verification" content="codeva-6wmKWl5hmx" />
<meta name="bytedance-verification-code" content="GcOf/MpQ8shZ5Hh/2hvr" />
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.1.1">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-33RJLY0818"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-33RJLY0818');
</script>

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha256-yIDrPSXHZdOZhAqiBP7CKzIwMQmRCJ8UeB8Jo17YC4o=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.sovdating.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.19.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Hello dev">
<meta property="og:type" content="website">
<meta property="og:title" content="Sovdating Linux">
<meta property="og:url" content="https://www.sovdating.com/page/12/index.html">
<meta property="og:site_name" content="Sovdating Linux">
<meta property="og:description" content="Hello dev">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="DJY">
<meta property="article:tag" content="golang python linux ubuntu centos rust">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://www.sovdating.com/page/12/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/12/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Sovdating Linux - some code for program</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Sovdating Linux</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">some code for program</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>Sitemap</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">DJY</p>
  <div class="site-description" itemprop="description">Hello dev</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">554</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">94</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">389</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.sovdating.com/%E9%A5%BF%E5%8A%A0%E8%BD%BD%E5%8D%95%E4%BE%8B%E7%9A%84%E8%AF%AF%E8%A7%A3-%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="DJY">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sovdating Linux">
      <meta itemprop="description" content="Hello dev">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Sovdating Linux">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E9%A5%BF%E5%8A%A0%E8%BD%BD%E5%8D%95%E4%BE%8B%E7%9A%84%E8%AF%AF%E8%A7%A3-%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/" class="post-title-link" itemprop="url">饿加载单例的误解-类加载机制</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-07-07 00:00:03" itemprop="dateCreated datePublished" datetime="2017-07-07T00:00:03+00:00">2017-07-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-01-26 12:42:24" itemprop="dateModified" datetime="2024-01-26T12:42:24+00:00">2024-01-26</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="饿加载单例-期望是系统启动就自动初始化类-实际并不然"><a href="#饿加载单例-期望是系统启动就自动初始化类-实际并不然" class="headerlink" title="饿加载单例-期望是系统启动就自动初始化类(实际并不然)"></a>饿加载单例-期望是<code>系统启动就自动初始化类</code>(实际并不然)</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">class MySingleton_Static &#123;</span><br><span class="line"> </span><br><span class="line">    // 初始化时机：当任意static被被访问时,会初始化实例(建议initInstall)。否则将在getInstall访问时才创建(非饿加载)</span><br><span class="line">    public static int initInstall = 1;// (理解并不直观,所以不见得好/ 避免此类影响可结合内部类实例化当前类,getInstall中触发.如下文)</span><br><span class="line"> </span><br><span class="line">    /* 考虑类加载机制的初始化条件(被new或内部static被访问),所以启动时并不会实例化*/</span><br><span class="line">    private static MySingleton_Static mySingleton = new MySingleton_Static();</span><br><span class="line"> </span><br><span class="line">    private MySingleton_Static() &#123;</span><br><span class="line">        System.out.println(&quot;Loader&quot;);// 监控实例化时机</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    public static MySingleton_Static getInstance() &#123;</span><br><span class="line">        return mySingleton;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">class MySingleton_Static_test &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        System.out.println(&quot;test classLoader &quot;);// test classLoader (并非第一时间初始化对象)</span><br><span class="line">        System.out.println(&quot;test classLoader &quot; + MySingleton_Static.initInstall);// Loader &gt; test classLoader 1</span><br><span class="line">        System.out.println(&quot;test classLoader &quot; + MySingleton_Static.getInstance());// [Loader] &gt; test classLoader **@14ae5a5</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h1 id="通过内部类，避免访问静态变量，导致实例被动初始化"><a href="#通过内部类，避免访问静态变量，导致实例被动初始化" class="headerlink" title="通过内部类，避免访问静态变量，导致实例被动初始化"></a>通过内部类，避免访问静态变量，导致实例被动初始化</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">class Singleton &#123;</span><br><span class="line"></span><br><span class="line">    private Singleton() &#123;</span><br><span class="line">        System.out.println(&quot;Loader&quot;);// 监控实例化时机</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    // 注意：static属性不是对象信息,而是在`方法区-运行时常量池`中。与类对象无关(同理类的序列化也不包含static属性)</span><br><span class="line">    public static int initInstall = 1;// 避免访问static触发类的初始化(仅能通过getInstance方法初始化)</span><br><span class="line"> </span><br><span class="line">    private static class SingletonHolder &#123;</span><br><span class="line">        private static final Singleton INSTANCE = new Singleton();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    public static Singleton getInstance() &#123;</span><br><span class="line">        return SingletonHolder.INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">class Singleton_test &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        System.out.println(&quot;test classLoader &quot;);// test classLoader (此时还没有初始化,如上文是合理的)</span><br><span class="line">        System.out.println(&quot;test classLoader &quot; + Singleton.initInstall);// test classLoader 1 (没有触发类的初始化,因为没有new)</span><br><span class="line">        System.out.println(&quot;test classLoader &quot; + Singleton.getInstance());// Loader &gt; test classLoader **@14ae5a5</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h1 id="结论："><a href="#结论：" class="headerlink" title="结论："></a>结论：</h1><p>类在<code>堆中的实例化</code>依赖<code>虚拟机栈</code>的执行，而<code>虚拟机栈的执行</code>依赖<code>类的初始化</code>。<code> 饿加载单例</code>本身已经违背了<code>类的初始化条件</code>，所以基本不存在真正意义的饿加载。</p>
<hr>
<h1 id="饿加载-与-懒加载的区别"><a href="#饿加载-与-懒加载的区别" class="headerlink" title="饿加载  与 懒加载的区别"></a>饿加载  与 懒加载的区别</h1><p><code>饿加载</code> - 实例化交给了<code>static</code>，static的指令在<code>访问前并不会执行</code>，当<code>任意static</code>被访问时 <code>虚拟机</code>会将先初始化该类的<code>运行时常量池</code>执行该类中所有的static属性指令。其中如有<code>new Object()</code>也将被执行 ，并通过   <code>虚拟机栈-动态链接</code>  获得类的<code>具体实例</code></p>
<p><code>懒加载</code> - 在static方法getInstance()访问时， 先是通过 <code>虚拟机栈-动态链接</code>找到<code>方法区-flags: ACC_STATIC mathod</code>并立即执行.其中指令将被<code>虚拟机-操作栈</code>执行, 并通过   <code>虚拟机栈-动态链接</code>  获得类的<code>具体实例</code></p>
<ul>
<li><code>flags: ACC_STATIC   mathod</code> (如main&#x2F; utilMathod )<br>static归属于方法区,虚拟机允许static方法在没有类的初始化前直接访问.<br>作用: <ul>
<li>[main,getInstance]-用于类的初始化</li>
<li>[utilMathod]-<code>无状态要求</code>的代码集(<code>调用方法本身,无需产生新对象  性能更好</code>.  直接从方法区中获取指令代码-当然初始化的对象也是从方法区获取指令代码)</li>
</ul>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.sovdating.com/%E9%A5%BF%E5%8A%A0%E8%BD%BD%E5%8D%95%E4%BE%8B%E7%9A%84%E5%8D%B1%E9%99%A9-jvm%E6%93%8D%E4%BD%9C%E6%95%B0%E6%A0%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="DJY">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sovdating Linux">
      <meta itemprop="description" content="Hello dev">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Sovdating Linux">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E9%A5%BF%E5%8A%A0%E8%BD%BD%E5%8D%95%E4%BE%8B%E7%9A%84%E5%8D%B1%E9%99%A9-jvm%E6%93%8D%E4%BD%9C%E6%95%B0%E6%A0%88/" class="post-title-link" itemprop="url">饿加载单例的危险-jvm操作数栈</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-07-07 00:00:02" itemprop="dateCreated datePublished" datetime="2017-07-07T00:00:02+00:00">2017-07-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-01-26 12:42:23" itemprop="dateModified" datetime="2024-01-26T12:42:23+00:00">2024-01-26</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="疑惑性强的示例"><a href="#疑惑性强的示例" class="headerlink" title="疑惑性强的示例"></a>疑惑性强的示例</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">class SingleTon &#123; </span><br><span class="line">    private static SingleTon singleTon = new SingleTon(); </span><br><span class="line">    public static int count1; </span><br><span class="line">    public static int count2 = 0; </span><br><span class="line"> </span><br><span class="line">    private SingleTon() &#123; </span><br><span class="line">        count1++; </span><br><span class="line">        count2++; </span><br><span class="line">    &#125; </span><br><span class="line"> </span><br><span class="line">    public static SingleTon getInstance() &#123; </span><br><span class="line">        return singleTon; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"> </span><br><span class="line">public class Test &#123; </span><br><span class="line">    public static void main(String[] args) &#123; </span><br><span class="line">        SingleTon singleTon = SingleTon.getInstance(); </span><br><span class="line">        System.out.println(&quot;count1=&quot; + singleTon.count1); // 1</span><br><span class="line">        System.out.println(&quot;count2=&quot; + singleTon.count2); // 0</span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p>简单构想的结果应该是: <code>count=1</code> <code>count2=1</code> 实际的结果是:  <code> count=1</code> <code> count2=0</code></p>
<hr>
<h1 id="方便的看懂原理-要换个例子"><a href="#方便的看懂原理-要换个例子" class="headerlink" title="方便的看懂原理,要换个例子"></a>方便的看懂原理,要换个例子</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">public class SingleTon &#123;</span><br><span class="line"> </span><br><span class="line">    public static int count1 = 170;// 在第5行(即类初始化)前,将数值加入`方法区-运行时常量池`</span><br><span class="line"> </span><br><span class="line">    private static SingleTon singleTon = new SingleTon();</span><br><span class="line"> </span><br><span class="line">    public static int count;// 此时虽然已经完成了初始化,但无赋值操作,将保持`方法区-运行时常量池`中的数值</span><br><span class="line">    public static int count2 = 188;// 此时已经完成了类初始化,再将188赋值,将会覆盖原值</span><br><span class="line"> </span><br><span class="line">    private SingleTon() &#123;</span><br><span class="line">        count++;</span><br><span class="line">        System.out.println(&quot; count++; &quot; + count);// 1</span><br><span class="line">        count1++;</span><br><span class="line">        System.out.println(&quot; count1++; &quot; + count1);// 171</span><br><span class="line">        count2++;</span><br><span class="line">        System.out.println(&quot; count2++; &quot; + count2);// 1(栈帧中的操作数栈,此时还在第5行,还未执行count2的赋值)</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    public static SingleTon getInstance() &#123;</span><br><span class="line">        return singleTon;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">class SingleTon_Test &#123;</span><br><span class="line"> </span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        System.out.println(&quot;count =&quot; + SingleTon.count);// 1 因无赋值操作,所以保持了`方法区-运行时常量池`中的数值</span><br><span class="line">        System.out.println(&quot;count1=&quot; + SingleTon.count1);// 171 count1已经在类初始化前将数值放入了`方法区-运行时常量池`,所以感觉无恙</span><br><span class="line">        System.out.println(&quot;count2=&quot; + SingleTon.count2);// 188 在已经完成了类初始化后,再将188赋值到 `方法区-运行时常量池` ,将会覆盖原值</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>简单构想的结果应该是:    <code> count=1</code>  <code> count1  =171</code>   <code> count2=189</code><br>实际上 <code> count2=188</code> 为什么?</p>
<ul>
<li><p>通过构造函数的日志可以推断,影响到<code>count2数值</code>的关键确定<code>count2=188</code>是否在类实例化后进行了覆盖<br>如何确定? 这时就可以想到<code>方法区-操作数栈信息</code>这里能直接体现程序在实际运行中 (<code>虚拟机栈-栈帧-操作数帧</code>)的轨迹.</p>
</li>
<li><p>如图(方法区信息) :<br><img src="http://7xnbs3.com1.z0.glb.clouddn.com/17-7-7/95411964.jpg"></p>
</li>
<li><p>new SingleTon()何时被执行? [即 <code>static属性在方法区的结构</code> ]<br>情况一:<code>所有的static变量</code>在方法区会包装成一个<code>static&#123;&#125;方法</code>,会有自己的<code>虚拟机-操作栈</code>,当其中任何变量被访问.<br>就会执行整个<code>static方法</code>,最终再将返回原访问的<code>static变量</code><br>情况二:主动<code>new Object()</code>时,在执行构造方法前,会先执行<code>static变量的static&#123;&#125;方法</code>.</p>
</li>
<li><p>完整方法区信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line">G:\liuxiang_code_git\myServer\@jvm\demo-classLoader\target\classes&gt;javap -v SingleTon.class</span><br><span class="line">Classfile /G:/liuxiang_code_git/myServer/@jvm/demo-classLoader/target/classes/SingleTon.class</span><br><span class="line">  Last modified 2017-7-7; size 1023 bytes</span><br><span class="line">  MD5 checksum afb31d9e86dc5fe19907b4d4d78d38e9</span><br><span class="line">  Compiled from &quot;SingleTon.java&quot;</span><br><span class="line">public class SingleTon</span><br><span class="line">  minor version: 0</span><br><span class="line">  major version: 52</span><br><span class="line">  flags: ACC_PUBLIC, ACC_SUPER</span><br><span class="line">Constant pool:</span><br><span class="line">   #1 = Methodref          #18.#36        // java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">   #2 = Fieldref           #16.#37        // SingleTon.count:I</span><br><span class="line">   #3 = Fieldref           #38.#39        // java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">   #4 = Class              #40            // java/lang/StringBuilder</span><br><span class="line">   #5 = Methodref          #4.#36         // java/lang/StringBuilder.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">   #6 = String             #41            //  count++;</span><br><span class="line">   #7 = Methodref          #4.#42         // java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;</span><br><span class="line">   #8 = Methodref          #4.#43         // java/lang/StringBuilder.append:(I)Ljava/lang/StringBuilder;</span><br><span class="line">   #9 = Methodref          #4.#44         // java/lang/StringBuilder.toString:()Ljava/lang/String;</span><br><span class="line">  #10 = Methodref          #45.#46        // java/io/PrintStream.println:(Ljava/lang/String;)V</span><br><span class="line">  #11 = Fieldref           #16.#47        // SingleTon.count1:I</span><br><span class="line">  #12 = String             #48            //  count1++;</span><br><span class="line">  #13 = Fieldref           #16.#49        // SingleTon.count2:I</span><br><span class="line">  #14 = String             #50            //  count2++;</span><br><span class="line">  #15 = Fieldref           #16.#51        // SingleTon.singleTon:LSingleTon;</span><br><span class="line">  #16 = Class              #52            // SingleTon</span><br><span class="line">  #17 = Methodref          #16.#36        // SingleTon.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">  #18 = Class              #53            // java/lang/Object</span><br><span class="line">  #19 = Utf8               count1</span><br><span class="line">  #20 = Utf8               I</span><br><span class="line">  #21 = Utf8               singleTon</span><br><span class="line">  #22 = Utf8               LSingleTon;</span><br><span class="line">  #23 = Utf8               count</span><br><span class="line">  #24 = Utf8               count2</span><br><span class="line">  #25 = Utf8               &lt;init&gt;</span><br><span class="line">  #26 = Utf8               ()V</span><br><span class="line">  #27 = Utf8               Code</span><br><span class="line">  #28 = Utf8               LineNumberTable</span><br><span class="line">  #29 = Utf8               LocalVariableTable</span><br><span class="line">  #30 = Utf8               this</span><br><span class="line">  #31 = Utf8               getInstance</span><br><span class="line">  #32 = Utf8               ()LSingleTon;</span><br><span class="line">  #33 = Utf8               &lt;clinit&gt;</span><br><span class="line">  #34 = Utf8               SourceFile</span><br><span class="line">  #35 = Utf8               SingleTon.java</span><br><span class="line">  #36 = NameAndType        #25:#26        // &quot;&lt;init&gt;&quot;:()V</span><br><span class="line">  #37 = NameAndType        #23:#20        // count:I</span><br><span class="line">  #38 = Class              #54            // java/lang/System</span><br><span class="line">  #39 = NameAndType        #55:#56        // out:Ljava/io/PrintStream;</span><br><span class="line">  #40 = Utf8               java/lang/StringBuilder</span><br><span class="line">  #41 = Utf8                count++;</span><br><span class="line">  #42 = NameAndType        #57:#58        // append:(Ljava/lang/String;)Ljava/lang/StringBuilder;</span><br><span class="line">  #43 = NameAndType        #57:#59        // append:(I)Ljava/lang/StringBuilder;</span><br><span class="line">  #44 = NameAndType        #60:#61        // toString:()Ljava/lang/String;</span><br><span class="line">  #45 = Class              #62            // java/io/PrintStream</span><br><span class="line">  #46 = NameAndType        #63:#64        // println:(Ljava/lang/String;)V</span><br><span class="line">  #47 = NameAndType        #19:#20        // count1:I</span><br><span class="line">  #48 = Utf8                count1++;</span><br><span class="line">  #49 = NameAndType        #24:#20        // count2:I</span><br><span class="line">  #50 = Utf8                count2++;</span><br><span class="line">  #51 = NameAndType        #21:#22        // singleTon:LSingleTon;</span><br><span class="line">  #52 = Utf8               SingleTon</span><br><span class="line">  #53 = Utf8               java/lang/Object</span><br><span class="line">  #54 = Utf8               java/lang/System</span><br><span class="line">  #55 = Utf8               out</span><br><span class="line">  #56 = Utf8               Ljava/io/PrintStream;</span><br><span class="line">  #57 = Utf8               append</span><br><span class="line">  #58 = Utf8               (Ljava/lang/String;)Ljava/lang/StringBuilder;</span><br><span class="line">  #59 = Utf8               (I)Ljava/lang/StringBuilder;</span><br><span class="line">  #60 = Utf8               toString</span><br><span class="line">  #61 = Utf8               ()Ljava/lang/String;</span><br><span class="line">  #62 = Utf8               java/io/PrintStream</span><br><span class="line">  #63 = Utf8               println</span><br><span class="line">  #64 = Utf8               (Ljava/lang/String;)V</span><br><span class="line">&#123;</span><br><span class="line">  public static int count1;</span><br><span class="line">    descriptor: I</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line"> </span><br><span class="line">  public static int count;</span><br><span class="line">    descriptor: I</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line"> </span><br><span class="line">  public static int count2;</span><br><span class="line">    descriptor: I</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line"> </span><br><span class="line">  public static SingleTon getInstance();</span><br><span class="line">    descriptor: ()LSingleTon;</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=1, locals=0, args_size=0</span><br><span class="line">         0: getstatic     #15                 // Field singleTon:LSingleTon;</span><br><span class="line">         3: areturn</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 20: 0</span><br><span class="line"> </span><br><span class="line">  static &#123;&#125;;</span><br><span class="line">    descriptor: ()V</span><br><span class="line">    flags: ACC_STATIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=2, locals=0, args_size=0</span><br><span class="line">         0: sipush        170</span><br><span class="line">         3: putstatic     #11                 // Field count1:I</span><br><span class="line">         6: new           #16                 // class SingleTon</span><br><span class="line">         9: dup</span><br><span class="line">        10: invokespecial #17                 // Method &quot;&lt;init&gt;&quot;:()V</span><br><span class="line">        13: putstatic     #15                 // Field singleTon:LSingleTon;</span><br><span class="line">        16: sipush        188</span><br><span class="line">        19: putstatic     #13                 // Field count2:I</span><br><span class="line">        22: return</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 3: 0</span><br><span class="line">        line 5: 6</span><br><span class="line">        line 8: 16</span><br><span class="line">&#125;</span><br><span class="line">SourceFile: &quot;SingleTon.java&quot;</span><br><span class="line"> </span><br></pre></td></tr></table></figure></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.sovdating.com/%E7%BD%91%E7%BB%9C%E7%9B%B8%E5%85%B3%EF%BC%88tcp%E6%8F%A1%E6%89%8B%E9%87%8D%E4%BC%A0,http%E9%95%BF%E7%9F%AD%E9%93%BE%E6%8E%A5,Header%E5%88%86%E7%B1%BB%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="DJY">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sovdating Linux">
      <meta itemprop="description" content="Hello dev">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Sovdating Linux">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E7%BD%91%E7%BB%9C%E7%9B%B8%E5%85%B3%EF%BC%88tcp%E6%8F%A1%E6%89%8B%E9%87%8D%E4%BC%A0,http%E9%95%BF%E7%9F%AD%E9%93%BE%E6%8E%A5,Header%E5%88%86%E7%B1%BB%EF%BC%89/" class="post-title-link" itemprop="url">网络相关（tcp握手重传,http长短链接,Header分类）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-07-05 00:00:00" itemprop="dateCreated datePublished" datetime="2017-07-05T00:00:00+00:00">2017-07-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-01-26 12:42:19" itemprop="dateModified" datetime="2024-01-26T12:42:19+00:00">2024-01-26</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="TCP"><a href="#TCP" class="headerlink" title="TCP"></a>TCP</h1><p>特点：三次握手 &#x2F;  四次挥手 &#x2F;  可靠连接 &#x2F;  丢包重传<br>核心的： tcp是可以可靠传输协议，它的所有特点都为这个可靠传输服务</p>
<hr>
<p>位码即tcp标志位，有6种标示：<br><code>SYN(synchronous建立联机)</code><br><code>ACK(acknowledgement 确认)</code><br><code>PSH(push传送)</code><br><code>FIN(finish结束)</code><br><code>RST(reset重置)</code><br><code>URG(urgent紧急)</code></p>
<p><code>Sequence number(顺序号码)</code><br><code>Acknowledge number(确认号码)</code></p>
<hr>
<p>ack&#x3D;seq+<code>len</code><br>ack总是seq+<code>len（包的大小）</code>，这样发送方明确知道server收到那些东西了。<br>但是特例是三次握手和四次挥手，虽然len都是0，但是<code>syn和fin都要占用一个seq号</code>，<code>所以这里的ack都是seq+1</code></p>
<hr>
<p>那么tcp是怎么样来保障可靠传输呢？</p>
<p>tcp在传输过程中都有一个ack，接收方通过ack告诉发送方收到那些包了。这样发送方能知道有没有丢包，进而确定重传。</p>
<h1 id="tcp建连接的三次握手"><a href="#tcp建连接的三次握手" class="headerlink" title="tcp建连接的三次握手"></a>tcp建连接的三次握手</h1><p><img src="http://7xnbs3.com1.z0.glb.clouddn.com/17-7-5/44504274.jpg"></p>
<ul>
<li>三个红框表示建立连接的三次握手：<br>第一步：client 发送 <code>syn</code> 到server 发起握手；<code>client-seq随机数</code><br>第二步：server 收到 syn后回复<code>syn+ack</code>给client； <code>server-seq随机数``ack确认（client seq）</code><br>第三步：client 收到<code>syn+ack</code>后，回复server一个<code>ack表示收到</code>了server的<code>syn</code>（此时client的<code>48287端口</code>的连接已经是<code>established</code>） <code>server-ack</code></li>
</ul>
<p>握手的<code>核心目的</code>是告知对方seq（绿框是client的初始seq，蓝色框是server 的初始seq），对方回复ack（收到的seq+包的大小），这样发送端就知道有没有丢包了。</p>
<p>握手的<code>次要目的</code>是告知和<code>协商一些信息</code>，图中黄框。<br><code>MSS–最大传输包</code><br><code>SACK_PERM–是否支持Selective ack(用户优化重传效率）</code><br><code>WS–窗口计算指数</code>（有点复杂的话先不用管）</p>
<p><strong>这就是tcp为什么要握手建立连接，就是为了解决tcp的可靠传输。</strong></p>
<h1 id="tcp断开连接的四次挥手"><a href="#tcp断开连接的四次挥手" class="headerlink" title="tcp断开连接的四次挥手"></a>tcp断开连接的四次挥手</h1><p><img src="http://7xnbs3.com1.z0.glb.clouddn.com/17-7-5/1347664.jpg"></p>
<ul>
<li>四个红框表示断开连接的四次挥手：<br>第一步： client主动发送<code>fin</code>包给server<br>第二步： server回复ack（对应第一步fin包的ack）给client，表示<code>server知道client要断开了</code><br>第三步： server发送<code>fin</code>包给client，表示<code>server也可以断开了</code><br>第四部： client回复<code>ack</code>给server，表示既然<code>双发都发送fin包表示断开</code>，<code>那么就真的断开吧</code></li>
</ul>
<hr>
<h1 id="三次握手中协商的其它信息"><a href="#三次握手中协商的其它信息" class="headerlink" title="三次握手中协商的其它信息"></a>三次握手中协商的其它信息</h1><p><code>MSS 最大一个包中能传输的信息</code>（不含tcp、ip包头）<br><code>MSS+包头就是MTU（最大传输单元）</code>，如果<code>MTU过大可能在传输的过程中被卡住过不去造成卡死</code>（这个大小的包一直传输不过去），跟丢包还不一样。</p>
<hr>
<table>
<thead>
<tr>
<th align="center">请求的三次握手</th>
<th>端到端</th>
<th>目的</th>
<th>内容</th>
</tr>
</thead>
<tbody><tr>
<td align="center">第一次</td>
<td>Client-&gt;Server</td>
<td>1.建立连接+丢包保障(包大小) <br> 2.协商:MSS最大传输包+SACK_perm重传效率</td>
<td>1.[SYN]seq&#x3D;* len&#x3D;* <br>2.MSS&#x3D;* SACK_perm&#x3D;*</td>
</tr>
<tr>
<td align="center">第二次</td>
<td>Server-&gt;Client</td>
<td>收到&amp;并确认</td>
<td>[SYN,ACK]seq&#x3D;* ACK&#x3D;c-seq+len len&#x3D;* MSS&#x3D;*</td>
</tr>
<tr>
<td align="center">第三次</td>
<td>Client-&gt;Server</td>
<td>收到&amp;并确认</td>
<td>[SYN,ACK]seq&#x3D;* ACK&#x3D;s-seq</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th align="center">断开的四次握手</th>
<th>端到端</th>
<th>目的</th>
<th>内容</th>
</tr>
</thead>
<tbody><tr>
<td align="center">第一次</td>
<td>Client-&gt;Server</td>
<td>client请求断线</td>
<td>[FIN,ACK]</td>
</tr>
<tr>
<td align="center">第二次</td>
<td>Server-&gt;Client</td>
<td>收到&amp;并确认</td>
<td>[ACK]</td>
</tr>
<tr>
<td align="center">第三次</td>
<td>Server-&gt;Client</td>
<td>server请求断线</td>
<td>[FIN,ACK]</td>
</tr>
<tr>
<td align="center">第四次</td>
<td>Client-&gt;Server</td>
<td>收到&amp;并确认</td>
<td>[ACK]</td>
</tr>
</tbody></table>
<hr>
<h1 id="重传策略"><a href="#重传策略" class="headerlink" title="重传策略"></a>重传策略</h1><p>场景:client[1,2,3,4,5] server[1,2,4,5] <code>数据包3</code>丢了</p>
<h2 id="超时重传机制-client没有收到server回复的数据包3的ack-超时就重传"><a href="#超时重传机制-client没有收到server回复的数据包3的ack-超时就重传" class="headerlink" title="超时重传机制: client没有收到server回复的数据包3的ack,超时就重传"></a>超时重传机制: client没有收到server回复的数据包3的ack,超时就重传</h2><p><code> 关于建连接时SYN超时</code>  在Linux下，默认重试次数为5次，重试的间隔时间从1s开始每次都翻售，5次的重试时间间隔为1s, 2s, 4s, 8s, 16s，总共31s，第5次发出后还要等32s都知道第5次也超时了，所以，总共需要 1s + 2s + 4s+ 8s+ 16s + 32s &#x3D; 2^6 -1 &#x3D; 63s，TCP才会把断开这个连接<br><code>关于SYN Flood攻击</code> 一些恶意的人就为此制造了SYN Flood攻击——给服务器发了一个SYN后，就下线了，于是服务器需要默认等63s才会断开连接，这样，攻击者就可以把服务器的syn连接的队列耗尽，让正常的连接请求不能处理。于是，Linux下给了一个叫tcp_syncookies的参数来应对这个事——当SYN队列满了后，TCP会通过源地址端口、目标地址端口和时间戳打造出一个特别的Sequence Number发回去（又叫cookie），如果是攻击者则不会有响应，如果是正常连接，则会把这个 SYN Cookie发回来，然后服务端可以通过cookie建连接（即使你不在SYN队列中）。</p>
<h2 id="快速重传机制"><a href="#快速重传机制" class="headerlink" title="快速重传机制"></a>快速重传机制</h2><p>于是，TCP引入了一种叫Fast Retransmit 的算法，不以时间驱动，而以数据驱动重传。也就是说，如果，包没有连续到达，就ack最后那个可能被丢了的包，如果发送方连续收到3次相同的ack，就重传。Fast Retransmit的好处是不用等timeout了再重传</p>
<h2 id="SACK-方法-数据碎版"><a href="#SACK-方法-数据碎版" class="headerlink" title="SACK 方法 [ 数据碎版 ]"></a>SACK 方法 [<code> 数据碎版</code> ]</h2><p>另外一种更好的方式叫：Selective Acknowledgment (SACK)（参看RFC 2018），这种方式需要在TCP头里加一个SACK的东西，ACK还是Fast Retransmit的ACK，SACK则是汇报收到的数据碎版<br>这样，在发送端就可以根据回传的SACK来知道哪些数据到了，哪些没有到。于是就优化了Fast Retransmit的算法。当然，这个协议需要两边都支持。在 Linux下，可以通过tcp_sack参数打开这个功能（linux 2.4后默认打开）。</p>
<p><img src="http://7xnbs3.com1.z0.glb.clouddn.com/17-7-5/6094124.jpg"></p>
<p>这里还需要注意一个问题——接收方<code>Reneging</code>，所谓Reneging的意思就是接收方有权把已经报给发送端<code>SACK里的数据给丢了</code>。这样干是不被鼓励的，因为这个事会把问题复杂化了，但是，接收方这么做可能会有些极端情况，比如要把内存给别的更重要的东西。所以，发送方也不能完全依赖SACK，还是要依赖ACK，并维护Time-Out，如果后续的ACK没有增长，那么还是<code>要把SACK的东西重传</code>，另外，接收端这边永远不能把SACK的包标记为Ack。</p>
<p>注意：<code>SACK会消费发送方的资源</code>，试想，如果一个攻击者给数据发送方发<code>一堆SACK的选项</code>，这会导致发送方开始要重传甚至遍历已经发出的数据，这会消耗很多发送端的资源。详细的东西请参看《TCP SACK的性能权衡》</p>
<h1 id="Duplicate-SACK-–-重复收到数据的问题"><a href="#Duplicate-SACK-–-重复收到数据的问题" class="headerlink" title="Duplicate SACK – 重复收到数据的问题"></a>Duplicate SACK – 重复收到数据的问题</h1><p>Duplicate SACK又称D-SACK，其主要<code>使用了SACK来告诉发送方有哪些数据被重复接收了</code></p>
<p>示例一：ACK丢包 <code>[ACK( 4000) &gt; SACK( 3000-3500) ]</code><br>下面的示例中，丢了两个ACK，所以，发送端重传了第一个数据包（3000-3499），于是接收端发现重复收到，于是回了一个<code>SACK=3000-3500</code>，因为<code>ACK都到了4000</code>意味着收到了4000之前的所有数据，所以这个SACK就是D-SACK——<code>旨在告诉发送端我收到了重复的数据</code>，而且我们的发送端<br>还知道，数据包没有丢，丢的是ACK包。</p>
<table>
<thead>
<tr>
<th align="center">Transmitted     Segment</th>
<th>Received     Segment</th>
<th>ACK Sent     (Including SACK Blocks)</th>
</tr>
</thead>
<tbody><tr>
<td align="center">3000-3499</td>
<td>3000-3499</td>
<td>3500 (ACK dropped)</td>
</tr>
<tr>
<td align="center">3500-3999</td>
<td>3500-3999</td>
<td>4000 (ACK dropped)</td>
</tr>
<tr>
<td align="center">3000-3499</td>
<td>3000-3499</td>
<td>4000, SACK&#x3D;3000-3500</td>
</tr>
</tbody></table>
<p>示例二，网络延误 <code>[ACK(3000) &gt; SACK(1000-1500)]</code> (+ACK重复,SACK碎片补偿)<br>下面的示例中，网络包（1000-1499）被网络给延误了，导致发送方没有收到ACK，而后面到达的三个包触发了“Fast Retransmit算法”，所以重传，但重传时，被延误的包又到了，所以，回了一个<code>SACK=1000-1500</code>，因为<code>ACK已到了3000</code>，所以，<code>这个SACK是D-SACK——标识收到了重复的包</code>。<br>这个案例下，发送端知道之前因为“Fast Retransmit算法”触发的重传不是因为发出去的包丢了，也不是因为回应的ACK包丢了，而是因为网络延时<br>了。</p>
<table>
<thead>
<tr>
<th align="center">Transmitted     Segment</th>
<th>Received     Segment</th>
<th>ACK Sent     (Including SACK Blocks)</th>
</tr>
</thead>
<tbody><tr>
<td align="center">500-999</td>
<td>500-999</td>
<td>1000</td>
</tr>
<tr>
<td align="center">1000-1499</td>
<td>(delayed)</td>
<td></td>
</tr>
<tr>
<td align="center">1500-1999</td>
<td>1500-1999</td>
<td>1000, SACK&#x3D;1500-2000</td>
</tr>
<tr>
<td align="center">2000-2499</td>
<td>2000-2499</td>
<td>1000, SACK&#x3D;1500-2500</td>
</tr>
<tr>
<td align="center">2500-2999</td>
<td>2500-2999</td>
<td>1000, SACK&#x3D;1500-3000</td>
</tr>
<tr>
<td align="center">1000-1499</td>
<td>1000-1499</td>
<td>3000</td>
</tr>
<tr>
<td align="center"></td>
<td>1000-1499</td>
<td>3000, SACK&#x3D;1000-1500</td>
</tr>
</tbody></table>
<p><code>引入了D-SACK，有这么几个好处</code>：<br>1）可以让发送方知道，是发出去的包丢了，还是回来的ACK包丢了。<br>2）是不是自己的timeout太小了，导致重传。<br>3）网络上出现了先发的包后到的情况（又称reordering）<br>4）网络上是不是把我的数据包给复制了。<br><code>Linux下的tcp_dsack参数用于开启这个功能（Linux 2.4后默认打开）</code></p>
<hr>
<h1 id="TCP-HTTP-长连接和短连接区别和怎样维护长连接"><a href="#TCP-HTTP-长连接和短连接区别和怎样维护长连接" class="headerlink" title="TCP(HTTP)长连接和短连接区别和怎样维护长连接"></a>TCP(HTTP)长连接和短连接区别和怎样维护长连接</h1><p>在<code>HTTP/1.0中，默认使用的是短连接</code>。也就是说，浏览器和服务器每进行一次HTTP操作，就建立一次连接，但任务结束就中断连接<br>从 <code>HTTP/1.1起，默认使用长连接</code>，用以保持连接特性。使用长连接的HTTP协议，会在<code>响应头</code>有加入这行代码： <code>Connection:keep-alive</code></p>
<p><code>模拟一下长连接的情况</code>，client向server发起连接，server接受client连接，双方建立连接。Client与server完成一次读写之后，它们之间的连接并不会主动关闭，后续的读写操作会继续使用这个连接</p>
<p>首先说一下TCP&#x2F;IP详解上讲到的TCP保活功能，保活功能主要为服务器应用提供，服务器应用希望知道客户主机是否崩溃，从而可以代表客户使用资源。如果客户已经消失，使得服务器上保留一个半开放的连接，而服务器又在等待来自客户端的数据，则服务器将<code>永远等待客户端的数据</code>，<code>保活</code>功能就是<code>试图在服务器端检测到这种半开放的连接</code>。</p>
<ul>
<li>tomcat&#x2F;conf&#x2F;service.xml<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;Connector port=&quot;8080&quot; protocol=&quot;HTTP/1.1&quot; connectionTimeout=&quot;20000&quot; redirectPort=&quot;8443&quot; /&gt;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>— #  HTTP 协议格式 和 HTTP Header</p>
<p><img src="http://7xnbs3.com1.z0.glb.clouddn.com/17-7-5/90636666.jpg"></p>
<p>请求字段(Request)<br>能够接受</p>
<p><code>DevDocs — HTTP / Headers</code></p>
<p><a target="_blank" rel="noopener" href="http://devdocs.io/http-headers/">http://devdocs.io/http-headers/</a></p>
<p>** 请求字段(Request) **</p>
<table>
<thead>
<tr>
<th>Header</th>
<th>描述</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>Accept-?</td>
<td>自 方 支持说明 <br> (类型,字符集,编码,语言,时间版本)</td>
<td>Accept-Charset: utf-8     <br>Accept-Encoding:gzip, deflate     <br>Accept-Language: en-US     <br>Accept-Datetime: Thu, 31 May 2007 20:35:00 GMT     <br>TE: trailers, deflate</td>
</tr>
<tr>
<td></td>
<td>告知对方(安全,cookie,要求匹配,跨域)</td>
<td>Authorization: Basic   QWxhZGRpbjpvcGVuIHNlc2FtZQ&#x3D;&#x3D;     <br>Cookie: $Version&#x3D;1; Skin&#x3D;new;     <br>Cache-Control: no-cache     <br>If-Match: “737060cd8c284d8af7ad3082f209582d”     <br>If-Modified-Since: Sat, 29 Oct 1994 19:43:31 GMT     <br>If-None-Match: “737060cd8c284d8af7ad3082f209582d”     <br>If-Range: “737060cd8c284d8af7ad3082f209582d”     <br>If-Unmodified-Since: Sat, 29 Oct 1994 19:43:31 GMT     <br>Origin: <a target="_blank" rel="noopener" href="http://www.example-social-network.com/">http://www.example-social-network.com</a></td>
</tr>
<tr>
<td>Connection</td>
<td>连接预期</td>
<td>Connection:   keep-alive     <br>Connection: Upgrade</td>
</tr>
<tr>
<td>Content-?</td>
<td>交换信息(长度,编码,类型)</td>
<td>Content-Length:   348     <br>Content-MD5: Q2hlY2sgSW50ZWdyaXR5IQ&#x3D;&#x3D;     <br>Content-Type: application&#x2F;x-www-form-urlencoded</td>
</tr>
<tr>
<td></td>
<td>自方信息 <br> (时间,期望,请求方信息,目标域,设备,代理)</td>
<td>Date: Tue, 15 Nov 1994 08:12:31   GMT     <br>Expect: 100-continue     <br>From: <a href="mailto:&#x75;&#x73;&#101;&#114;&#x40;&#101;&#x78;&#97;&#109;&#x70;&#x6c;&#x65;&#x2e;&#x63;&#x6f;&#x6d;">&#x75;&#x73;&#101;&#114;&#x40;&#101;&#x78;&#97;&#109;&#x70;&#x6c;&#x65;&#x2e;&#x63;&#x6f;&#x6d;</a>     <br>Host:en.wikipedia.org:80     <br>Host: en.wikipedia.org     <br>Referer: <a target="_blank" rel="noopener" href="http://en.wikipedia.org/wiki/Main_Page">http://en.wikipedia.org/wiki/Main_Page</a>     <br>User-Agent: Mozilla&#x2F;5.0 (X11; Linux x86_64; rv:12.0)   Gecko&#x2F;20100101 Firefox&#x2F;21.0     <br>     <br>Max-Forwards: 10     <br>Proxy-Authorization: Basic QWxhZGRpbjpvcGVuIHNlc2FtZQ&#x3D;&#x3D;     <br>Via: 1.0 fred, 1.1 example.com (Apache&#x2F;1.1)     <br>     <br>Range: bytes&#x3D;500-999     <br>Pragma: no-cache     <br>Warning: 199 Miscellaneous warning</td>
</tr>
</tbody></table>
<p>**响应 字段(Response) **</p>
<table>
<thead>
<tr>
<th>Header</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>Access-?</td>
<td>自 方 支持说明(域,编码,动作)</td>
<td>Access-Control-Allow-Origin: *     <br>Accept-Patch: text&#x2F;example;charset&#x3D;utf-8     <br>Accept-Ranges: bytes     <br>Allow: GET, HEAD</td>
</tr>
<tr>
<td></td>
<td>缓存相关</td>
<td>Age: 12     <br>Cache-Control: max-age&#x3D;3600</td>
</tr>
<tr>
<td></td>
<td>连接预期</td>
<td>Connection: close</td>
</tr>
<tr>
<td></td>
<td>交换信息(内容,状态)</td>
<td>Content-Disposition:   attachment; filename&#x3D;”fname.ext”     <br>Content-Encoding: gzip     <br>Content-Language: da     <br>Content-Length: 348     <br>Content-Location: &#x2F;index.htm     <br>Content-MD5: Q2hlY2sgSW50ZWdyaXR5IQ&#x3D;&#x3D;     <br>Content-Range: bytes 21010-47021&#x2F;47022     <br>Content-Type: text&#x2F;html; charset&#x3D;utf-8     <br>Status: 200 OK</td>
</tr>
<tr>
<td></td>
<td>自 方信息<br>(时间,tag版本,失效时,代理,服务容器)</td>
<td>Date:   Tue, 15 Nov 1994 08:12:31 GMT     <br>ETag: “737060cd8c284d8af7ad3082f209582d”     <br>Expires: Thu, 01 Dec 1994 16:00:00 GMT     <br>Last-Modified: Tue, 15 Nov 1994 12:45:26 GMT     <br>Link: </feed>; rel&#x3D;”alternate”     <br>Location: <a target="_blank" rel="noopener" href="http://www.w3.org/pub/WWW/People.html">http://www.w3.org/pub/WWW/People.html</a>     <br>Pragma: no-cache     <br>Proxy-Authenticate: Basic     <br>Public-Key-Pins: max-age&#x3D;2592000; pin-<br>sha256&#x3D;”E9CZ9INDbd+2eRQozYqqbQ2yXLVKB9+xcprMF+44U1g&#x3D;”;     <br>Refresh: 5; url&#x3D;<a target="_blank" rel="noopener" href="http://www.w3.org/pub/WWW/People.html">http://www.w3.org/pub/WWW/People.html</a>     <br>Server: Apache&#x2F;2.4.1 (Unix)</td>
</tr>
<tr>
<td></td>
<td>告知对方<br> (cookie,传输, 重定向, 协议头,途径要求,警告,认证模式 )</td>
<td>Set-Cookie:   UserID&#x3D;JohnDoe; Max-Age&#x3D;3600; Version&#x3D;1 <br>Location: <a target="_blank" rel="noopener" href="http://www.w3.org/pub/WWW/People.html">http://www.w3.org/pub/WWW/People.html</a> <br>Transfer-Encoding: chunked     <br>Upgrade: HTTP&#x2F;2.0, SHTTP&#x2F;1.3, IRC&#x2F;6.9, RTA&#x2F;x11     <br>Vary: *     <br>Via: 1.0 fred, 1.1 example.com (Apache&#x2F;1.1)     <br>Warning: 199 Miscellaneous warning     <br>WWW-Authenticate: Basic     <br>X-Frame-Options: deny</td>
</tr>
</tbody></table>
<p>完整见： <a target="_blank" rel="noopener" href="http://www.jianshu.com/p/b963643ffe72">http://www.jianshu.com/p/b963643ffe72</a></p>
<hr>
<p><strong>参考</strong><br><code>就是要你懂 TCP</code> -  <code> 什么是工程效率，什么是知识效率</code></p>
<p><a target="_blank" rel="noopener" href="http://www.tuicool.com/articles/rUzEJ3">http://www.tuicool.com/articles/rUzEJ3</a></p>
<p><code>关于TCP 半连接队列和全连接队列 | 阿里中间件团队博客</code><br><a target="_blank" rel="noopener" href="http://jm.taobao.org/2017/05/25/525-1/">http://jm.taobao.org/2017/05/25/525-1/</a><br><code>另外每个具体问题都是最好学习的机会，光看书理解肯定是不够深刻的，请珍惜每个具体问题，碰到后能够把来龙去脉弄清楚。</code></p>
<p><code>tcp/ip 上，丢包重传机制 - DBC12345666的专栏 - 博客频道 - CSDN.NET</code><br><a target="_blank" rel="noopener" href="http://blog.csdn.net/dbc12345666/article/details/42499889">http://blog.csdn.net/dbc12345666/article/details/42499889</a></p>
<p><code>TCP(HTTP)长连接和短连接区别和怎样维护长连接 - jayxu无捷之径的博客 - 博客频道 - CSDN.NET</code><br><a target="_blank" rel="noopener" href="http://blog.csdn.net/ls5718/article/details/51757467">http://blog.csdn.net/ls5718/article/details/51757467</a></p>
<p><code>HTTP 协议格式 和 HTTP Header</code><br><a target="_blank" rel="noopener" href="http://www.tuicool.com/articles/jMFfIv">www.tuicool.com/articles/jMFfIv</a></p>
<p><code>HTTP Header简介 - 简书</code><br><a target="_blank" rel="noopener" href="http://www.jianshu.com/p/b963643ffe72">http://www.jianshu.com/p/b963643ffe72</a><br><a target="_blank" rel="noopener" href="http://kb.cnblogs.com/page/92320/">http://kb.cnblogs.com/page/92320/</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.sovdating.com/jvm%E7%9B%B8%E5%85%B3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="DJY">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sovdating Linux">
      <meta itemprop="description" content="Hello dev">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Sovdating Linux">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/jvm%E7%9B%B8%E5%85%B3/" class="post-title-link" itemprop="url">jvm相关</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-07-02 00:00:00" itemprop="dateCreated datePublished" datetime="2017-07-02T00:00:00+00:00">2017-07-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-01-26 12:42:28" itemprop="dateModified" datetime="2024-01-26T12:42:28+00:00">2024-01-26</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>详见 : <code>jvm相关.xmind</code></p>
<hr>
<p><img src="http://7xnbs3.com1.z0.glb.clouddn.com/17-7-3/81372067.jpg"><br><img src="http://7xnbs3.com1.z0.glb.clouddn.com/17-7-3/34371066.jpg"><br><img src="http://7xnbs3.com1.z0.glb.clouddn.com/17-7-3/44918091.jpg"><br><img src="http://7xnbs3.com1.z0.glb.clouddn.com/17-7-3/10451692.jpg"><br><img src="http://7xnbs3.com1.z0.glb.clouddn.com/17-7-3/97280524.jpg"></p>
<hr>
<p><code>JVM运行时内存结构 - 格物致知的个人页面 - 开源中国社区</code> - 见笔记<br><img src="http://7xnbs3.com1.z0.glb.clouddn.com/17-7-22/95515055.jpg"><br><img src="http://7xnbs3.com1.z0.glb.clouddn.com/17-7-22/11395610.jpg"><br><img src="http://7xnbs3.com1.z0.glb.clouddn.com/17-7-22/57895078.jpg"><br><img src="http://7xnbs3.com1.z0.glb.clouddn.com/17-7-22/38375267.jpg"></p>
<hr>
<p><strong>参考</strong><br><code>★  Java虚拟机规范（Java SE 7）.pdf </code></p>
<p><code>JVM内幕：Java虚拟机详解 - ImportNew</code><br><a target="_blank" rel="noopener" href="http://www.importnew.com/17770.html">http://www.importnew.com/17770.html</a><br><a target="_blank" rel="noopener" href="http://www.jianshu.com/p/c63a8b5a84f9">http://www.jianshu.com/p/c63a8b5a84f9</a></p>
<p><code>JVM内存模型 - 简书</code>  - <code> jijs</code></p>
<p><a target="_blank" rel="noopener" href="http://www.jianshu.com/p/a60d6ef0771b">http://www.jianshu.com/p/a60d6ef0771b</a></p>
<p><code>深入理解JVM--JVM垃圾回收机制 - jbutton - ITeye技术网站</code><br><a target="_blank" rel="noopener" href="http://jbutton.iteye.com/blog/1569746">http://jbutton.iteye.com/blog/1569746</a></p>
<p><code>JVM（HotSpot） 垃圾收集器 - 简书</code>  - <code> jijs</code><br><a target="_blank" rel="noopener" href="http://www.jianshu.com/p/b4a03b5de0d9">http://www.jianshu.com/p/b4a03b5de0d9</a></p>
<p><code>JVM垃圾回收算法 - 简书</code>  - <code> jijs</code><br><a target="_blank" rel="noopener" href="http://www.jianshu.com/p/114bf4d9e59e">http://www.jianshu.com/p/114bf4d9e59e</a></p>
<p><code>JVM 类加载机制深入浅出</code> - <code> jijs</code><br><a target="_blank" rel="noopener" href="http://www.jianshu.com/p/3cab74a189de">http://www.jianshu.com/p/3cab74a189de</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.sovdating.com/kafka%20%E7%9B%B8%E5%85%B3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="DJY">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sovdating Linux">
      <meta itemprop="description" content="Hello dev">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Sovdating Linux">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/kafka%20%E7%9B%B8%E5%85%B3/" class="post-title-link" itemprop="url">kafka 相关</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-06-30 00:00:00" itemprop="dateCreated datePublished" datetime="2017-06-30T00:00:00+00:00">2017-06-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-01-26 12:42:18" itemprop="dateModified" datetime="2024-01-26T12:42:18+00:00">2024-01-26</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>一句话：分布式环境下<code>生产者消费者** 解耦</code>的中间容器，使用在<code> 发布-订阅的消息服务</code>&#x2F;<code>log4j,nginx,mysql慢SQL各日志收集</code> 等场景中</p>
<p>作用 :   数据缓冲、异步通信、汇集日志、系统解耦</p>
<hr>
<h1 id="Kafka基本概念"><a href="#Kafka基本概念" class="headerlink" title="Kafka基本概念"></a>Kafka基本概念</h1><ul>
<li>Broker[<code>集群机器</code>]：消息中间件处理结点，一个Kafka节点就是一个broker，多个broker可以组成一个Kafka集群。</li>
<li>Topic[<code>主题</code>]：一类消息，例如page view日志、click日志等都可以以topic的形式存在，Kafka集群能够同时负责多个topic的分发。</li>
<li>Partition[<code> 主题的分目录存储</code> ]：topic物理上的分组，一个topic可以分为多个partition，每个partition是一个有序的队列。</li>
<li>Segment[<code> 主题消息的文件分组存储</code> ]：partition物理上由多个segment组成。</li>
<li>offset[<code>消息序号</code>]：每个partition都由一系列有序的、不可变的消息组成，这些消息被连续的追加到partition中。partition中的每个消息都有一个连续的序列号叫做offset,用于partition唯一标识一条消息。</li>
</ul>
<h1 id="Kafka消息发送的机制"><a href="#Kafka消息发送的机制" class="headerlink" title="Kafka消息发送的机制"></a>Kafka消息发送的机制</h1><p>首先获取topic的所有<code>Patition</code><br>生产者上线，将数据发布到topic（<code> 指定partition/未 指定 则 余数/自 算法</code> ），消息会路由到 Patition</p>
<h1 id="Kafka消息消费机制"><a href="#Kafka消息消费机制" class="headerlink" title="Kafka消息消费机制"></a>Kafka消息消费机制</h1><p><img src="https://static.oschina.net/uploads/space/2017/0227/154630_xHIL_1403215.png"></p>
<p>消费者通过pull的方式，定期从服务器拉取数据,当然在<code>pull数据</code>的时候，服务器会告诉consumer可消费的<code>消息offset</code><br><code>不同 Consumer Group下的消费者可以消费partition中相同的消息</code>，<code>相同的Consumer  Group下的消费者只能消费partition中不同的数据</code>。<br>服务器会记录每个consumer的在每个topic的每个partition下的消费的offset,然后每次去消费去拉取数据时，都会从上次记录的位置 （ 当consumer和partition增加或者删除时,需要重新执行一遍Consumer Rebalance算法 ）</p>
<h1 id="Kafka消息存储机制"><a href="#Kafka消息存储机制" class="headerlink" title="Kafka消息存储机制"></a>Kafka消息存储机制</h1><p>kafka的消息是存储在磁盘的，所以数据不易丢失<br>partition包含两部分： .index索引文件、.log消息内容文件<br><code>.index</code> 索引文件 (offset消息编号-消息在对应文件中的偏移量)</p>
<p><code>.log</code> 消息文件(完整消息，位置偏移量) <img src="https://static.oschina.net/uploads/space/2017/0227/192112_lUmB_1403215.png"></p>
<h1 id="消息检索过程示例"><a href="#消息检索过程示例" class="headerlink" title="消息检索过程示例"></a>消息检索过程示例</h1><p>例如读取<code>offset=368</code>的消息<br>（1）找到第368条消息在哪个<code>segment</code><br>根据<code>二分查找</code>，可以快速定位，第368条消息是在00000000000000000300.log文件中<br>（2）从<code>index文件</code>中找到其物理偏移量<br>读取 00000000000000000300.index 。以368为key，得到value，如299，就是消息的物理位置偏移量<br>（3）到<code>log文件</code>中读取消息内容<br>读取 00000000000000000300.log  从偏移量299开始读取消息内容。完成了消息的检索过程</p>
<p><code>Kafka消息生成，消费，存储机制 - - 博客频道 - CSDN.NET</code><br><a target="_blank" rel="noopener" href="http://blog.csdn.net/u013063153/article/details/73799951">http://blog.csdn.net/u013063153/article/details/73799951</a></p>
<p><code>Kafka学习之一 Kafka是什么，主要应用在什么场景? - 宝哥在路上 - 博客频道 - CSDN.NET</code><br><a target="_blank" rel="noopener" href="http://blog.csdn.net/code52/article/details/50475511">http://blog.csdn.net/code52/article/details/50475511</a></p>
<p><code>Kafka 高性能吞吐揭秘</code><br><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000003985468">https://segmentfault.com/a/1190000003985468</a></p>
<hr>
<h1 id="示例分析"><a href="#示例分析" class="headerlink" title="示例分析"></a>示例分析</h1><h2 id="生产者"><a href="#生产者" class="headerlink" title="生产者"></a>生产者</h2><ul>
<li><p>设置配置属性</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">// 设置配置属性</span><br><span class="line">Properties props = new Properties();</span><br><span class="line">//		props.put(&quot;metadata.broker.list&quot;,&quot;172.168.63.221:9092,172.168.63.233:9092,172.168.63.234:9092&quot;);</span><br><span class="line">props.put(&quot;metadata.broker.list&quot;,&quot;192.168.3.188:9092&quot;);</span><br><span class="line">props.put(&quot;serializer.class&quot;, &quot;kafka.serializer.StringEncoder&quot;);</span><br><span class="line">// key.serializer.class默认为serializer.class</span><br><span class="line">props.put(&quot;key.serializer.class&quot;, &quot;kafka.serializer.StringEncoder&quot;);</span><br><span class="line">// 可选配置，如果不配置，则使用默认的partitioner</span><br><span class="line">//		props.put(&quot;partitioner.class&quot;, &quot;com.catt.kafka.demo.PartitionerDemo&quot;);</span><br><span class="line">props.put(&quot;partitioner.class&quot;, &quot;example.PartitionerDemo&quot;);// 自算法实现partition选择(默认kafka会取余)</span><br><span class="line">// 触发acknowledgement机制，否则是fire and forget，可能会引起数据丢失</span><br><span class="line">// 值为0,1,-1,可以参考</span><br><span class="line">// http://kafka.apache.org/08/configuration.html</span><br><span class="line">props.put(&quot;request.required.acks&quot;, &quot;1&quot;);</span><br><span class="line">ProducerConfig config = new ProducerConfig(props);</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建producer</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 创建producer</span><br><span class="line">Producer&lt;String, String&gt; producer = new Producer&lt;String, String&gt;(config);</span><br></pre></td></tr></table></figure>
</li>
<li><p>产生并发送消息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">long start=System.currentTimeMillis();</span><br><span class="line">for (long i = 0; i &lt; events; i++) &#123;</span><br><span class="line">    long runtime = new Date().getTime();</span><br><span class="line">    String ip = &quot;192.168.3.&quot; + i;//rnd.nextInt(255);</span><br><span class="line">    String msg = runtime + &quot;,www.example.com,&quot; + ip;</span><br><span class="line">    //如果topic不存在，则会自动创建，默认replication-factor为1，partitions为0</span><br><span class="line">    KeyedMessage&lt;String, String&gt; data = new KeyedMessage&lt;String, String&gt;(</span><br><span class="line">            &quot;page_visits&quot;, ip, msg);</span><br><span class="line">    producer.send(data);</span><br><span class="line">&#125;</span><br><span class="line">System.out.println(&quot;耗时:&quot; + (System.currentTimeMillis() - start));</span><br><span class="line"></span><br><span class="line">// 关闭producer</span><br><span class="line">producer.close();</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="消费者（kafkaSDK接入zookeeper）"><a href="#消费者（kafkaSDK接入zookeeper）" class="headerlink" title="消费者（kafkaSDK接入zookeeper）"></a>消费者（kafkaSDK接入zookeeper）</h2><ul>
<li>topic 多路Stream消费<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, Integer&gt; topicCountMap = new HashMap&lt;String, Integer&gt;();</span><br><span class="line">topicCountMap.put(topic, new Integer(numThreads));</span><br><span class="line">Map&lt;String, List&lt;KafkaStream&lt;byte[], byte[]&gt;&gt;&gt; consumerMap = consumer.createMessageStreams(topicCountMap);// 多路Stream消费</span><br><span class="line">``` - 固定量线程池对应topic多路Stream 消费</span><br></pre></td></tr></table></figure>
List&lt;KafkaStream&lt;byte[], byte[]&gt;&gt; streams &#x3D; consumerMap.get(topic);<br>&#x2F;&#x2F; now launch all the threads<br>executor &#x3D; Executors.newFixedThreadPool(numThreads);<br>&#x2F;&#x2F; now create an object to consume the messages<br>int threadNumber &#x3D; 0;<br>for (final KafkaStream stream : streams) {<br> executor.submit(new ConsumerMsgTask(stream, threadNumber));<br> threadNumber++;<br>}<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- 消费线程  ConsumerMsgTask  </span><br></pre></td></tr></table></figure>
public class ConsumerMsgTask implements Runnable {<br> private KafkaStream m_stream;<br> private int m_threadNumber;<br> public ConsumerMsgTask(KafkaStream stream, int threadNumber) {<br> m_threadNumber &#x3D; threadNumber;<br> m_stream &#x3D; stream;<br> }<br> public void run() {<br> ConsumerIterator&lt;byte[], byte[]&gt; it &#x3D; m_stream.iterator();<br> while (it.hasNext())&#x2F;* 消费(在不消费者未shutdown前,会一直监听在此-即阻塞) *&#x2F;<br>     System.out.println(“Thread “ + m_threadNumber + “: “ + new String(it.next().message()));<br> System.out.println(“Shutting down Thread: “ + m_threadNumber);<br> }<br>}<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">`Kafka JAVA客户端代码示例 - 推酷`</span><br><span class="line"></span><br><span class="line">http://www.tuicool.com/articles/FRJzamq</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"># windows 练习</span><br><span class="line">- zookeeper服务启动</span><br><span class="line">&gt; zkServer</span><br><span class="line">- kafka服务启动</span><br><span class="line">&gt; .\bin\windows\kafka-server-start.bat .\config\server.properties</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="注册主题"><a href="#注册主题" class="headerlink" title="注册主题"></a>注册主题</h1><p>.\bin\windows\kafka-topics.bat –create –zookeeper localhost:2181 –replication-factor 1 –partitions 1 –topic test</p>
<h1 id="生产者上线"><a href="#生产者上线" class="headerlink" title="生产者上线"></a>生产者上线</h1><p>.\bin\windows\kafka-console-producer.bat –broker-list localhost:9092 –topic test</p>
<h1 id="消费者上线"><a href="#消费者上线" class="headerlink" title="消费者上线"></a>消费者上线</h1><p>.\bin\windows\kafka-console-consumer.bat –zookeeper localhost:2181 –topic test</p>
<h1 id="查看主题"><a href="#查看主题" class="headerlink" title="查看主题"></a>查看主题</h1><p>.\bin\windows\kafka-topics.bat –list –zookeeper localhost:2181<br>.\bin\windows\kafka-topics.bat –describe –zookeeper localhost:2181 –topic test &#96;&#96;&#96;</p>
<p>**效果： ** <code>生产者窗口</code>输入消息 &gt;&gt; <code>消费者窗口</code>可立即收到</p>
<hr>
<h2 id="linux-后台启动kafka"><a href="#linux-后台启动kafka" class="headerlink" title="linux 后台启动kafka"></a>linux 后台启动kafka</h2><p>前台启动kafka：</p>
<blockquote>
<p>.&#x2F;kafka-server-start.sh ..&#x2F;config&#x2F;server.properties</p>
</blockquote>
<p>后台启动kafka:</p>
<blockquote>
<p>.&#x2F;kafka-server-start.sh ..&#x2F;config&#x2F;server.properties 1&gt;&#x2F;dev&#x2F;null 2&gt;&amp;1 &amp;</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="http://blog.csdn.net/u013063153/article/details/72910748">http://blog.csdn.net/u013063153/article/details/72910748</a></p>
<hr>
<p><code>Kafka在Windows安装运行 - 林炳文Evankaka的专栏 - 博客频道 - CSDN.NET</code></p>
<p><a target="_blank" rel="noopener" href="http://blog.csdn.net/evankaka/article/details/52421314">http://blog.csdn.net/evankaka/article/details/52421314</a></p>
<p><code>kafka windows单机安装测试 - laputa73的专栏 - 博客频道 - CSDN.NET</code><br><a target="_blank" rel="noopener" href="http://blog.csdn.net/laputa73/article/details/48826167">http://blog.csdn.net/laputa73/article/details/48826167</a></p>
<p><code> Windows安装运行Kafka - OPEN 开发经验库</code><br><a target="_blank" rel="noopener" href="http://www.open-open.com/lib/view/open1455842080261.html">http://www.open-open.com/lib/view/open1455842080261.html</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.sovdating.com/markdown_tables%E8%A1%A8%E6%A0%BC%E5%B7%A5%E5%85%B7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="DJY">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sovdating Linux">
      <meta itemprop="description" content="Hello dev">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Sovdating Linux">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/markdown_tables%E8%A1%A8%E6%A0%BC%E5%B7%A5%E5%85%B7/" class="post-title-link" itemprop="url">markdown_tables表格工具</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-06-29 00:00:00" itemprop="dateCreated datePublished" datetime="2017-06-29T00:00:00+00:00">2017-06-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-01-26 12:42:17" itemprop="dateModified" datetime="2024-01-26T12:42:17+00:00">2024-01-26</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>在线： <a target="_blank" rel="noopener" href="http://www.tablesgenerator.com/markdown_tables">http://www.tablesgenerator.com/markdown_tables</a></p>
<p><img src="http://7xnbs3.com1.z0.glb.clouddn.com/17-7-3/97052676.jpg"></p>
<table>
<thead>
<tr>
<th align="center">&#x2F;</th>
<th>提供client请求目标的方式</th>
<th align="right">(反)序列化消息体</th>
<th>网络服务</th>
<th>暴露服务&#x2F;服务发现</th>
<th>(反)序列化消息体</th>
<th>提供server服务注册方式</th>
<th>RPC框架初始化</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Dubbo</td>
<td>spring-Bean</td>
<td align="right">Object-二进制</td>
<td>tcp(dubbo), nio</td>
<td>zookeeper</td>
<td>二进制-Object</td>
<td>spring-Bean</td>
<td>spring-Schema</td>
</tr>
<tr>
<td align="center">webService-Axis</td>
<td>axis.client.Call</td>
<td align="right">Object-soap(xml)</td>
<td>http</td>
<td>proName.wsdl描述</td>
<td>soap(xml)-Object</td>
<td>Apache Axis:deploy.wsdd部署<br>或 JAX-WS (注解) <br> @WebService,@WebMethod</td>
<td>servlet</td>
</tr>
<tr>
<td align="center">java.rmi</td>
<td>Naming.lookup</td>
<td align="right">Object-二进制</td>
<td>tcp(rmi)</td>
<td>rmi_doc</td>
<td>二进制-Object</td>
<td>LocateRegistry.createRegistry <br> Naming.rebind</td>
<td>thread</td>
</tr>
<tr>
<td align="center">RESTful</td>
<td>httpClient</td>
<td align="right">json</td>
<td>http</td>
<td>api_doc</td>
<td>json</td>
<td>spring mvc</td>
<td>servlet</td>
</tr>
</tbody></table>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.sovdating.com/Use-RAMDirectory-to-do-the-cache-to-improve-lucene-s-performance/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="DJY">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sovdating Linux">
      <meta itemprop="description" content="Hello dev">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Sovdating Linux">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Use-RAMDirectory-to-do-the-cache-to-improve-lucene-s-performance/" class="post-title-link" itemprop="url">用RAMDirectory做缓存提高Lucene性能</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-06-28 22:02:21" itemprop="dateCreated datePublished" datetime="2017-06-28T22:02:21+00:00">2017-06-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-01-26 12:42:25" itemprop="dateModified" datetime="2024-01-26T12:42:25+00:00">2024-01-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Programming-Notes/" itemprop="url" rel="index"><span itemprop="name">Programming Notes</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>RAMDirectory和FSDirectory都继承自BaseDirectory，而BaseDirectory继承自Directory，Directory是Lucene中设计的一个顶层抽象类，可以将其看做本地文件系统的一个目录。</p>
<p>RAMDirectory是基于内存实现的，具有较高的存储速度，但是受到内存大小的限制，而FSDirectory是基于文件系统实现的，针对不同的操作系统有不同的具体实现类，这些实现类无需用户操心，只需要调用FSDirectory.open(Path path)方法，它就会帮助我们选择最适合的子类，FSDirectory的瓶颈在于磁盘I&#x2F;O。</p>
<p>如果机器内存足够大的话，那么组合使用RAMDirectory和FSDirectory将能够极大地提高Lucene的性能。组合使用两者的应用场景很多，不同的场景可以分别解决不同的需求，仅列举如下</p>
<ul>
<li>批量索引，而无需检索的情况下，先把document存到RAMDirectory中，当达到一定数量之后，再把这些索引一次性加入FSDirectory里</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.lucene.analysis.core.WhitespaceAnalyzer;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.document.Document;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.document.Field;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.document.StringField;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.index.DirectoryReader;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.index.IndexWriter;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.index.IndexWriterConfig;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.search.IndexSearcher;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.search.MatchAllDocsQuery;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.store.FSDirectory;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.store.RAMDirectory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * Created by wangxu on 2017/06/19 15:31.</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * Description: 基于Lucene 6.5开发</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Wang Xu</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> V1.0.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> V1.0.0 &lt;br/&gt;</span></span><br><span class="line"><span class="comment"> * WebSite: http://codepub.cn &lt;br&gt;</span></span><br><span class="line"><span class="comment"> * Licence: Apache v2 License</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RamFSDirectoryDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">RAMDirectory</span> <span class="variable">ramDirectory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RAMDirectory</span>();</span><br><span class="line">        <span class="type">IndexWriter</span> <span class="variable">ramWriter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexWriter</span>(ramDirectory, <span class="keyword">new</span> <span class="title class_">IndexWriterConfig</span>(<span class="keyword">new</span> <span class="title class_">WhitespaceAnalyzer</span>()).setOpenMode(IndexWriterConfig.OpenMode.CREATE));</span><br><span class="line"></span><br><span class="line">        <span class="type">FSDirectory</span> <span class="variable">fsDirectory</span> <span class="operator">=</span> FSDirectory.open(Paths.get(<span class="string">&quot;F:/index_RAM_FS&quot;</span>));</span><br><span class="line">        <span class="type">IndexWriter</span> <span class="variable">fsWriter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexWriter</span>(fsDirectory, <span class="keyword">new</span> <span class="title class_">IndexWriterConfig</span>(<span class="keyword">new</span> <span class="title class_">WhitespaceAnalyzer</span>()).setOpenMode(IndexWriterConfig.OpenMode</span><br><span class="line">                .CREATE_OR_APPEND));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//简单起见，这里的数量都比较少，例如索引10000个document，每100个document作为一批</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">tempCount</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++) &#123;</span><br><span class="line">            <span class="type">Document</span> <span class="variable">document</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Document</span>();</span><br><span class="line">            document.add(<span class="keyword">new</span> <span class="title class_">StringField</span>(<span class="string">&quot;key&quot;</span>, String.valueOf(i), Field.Store.YES));</span><br><span class="line">            ramWriter.addDocument(document);</span><br><span class="line">            tempCount++;</span><br><span class="line">            <span class="keyword">if</span> (tempCount % <span class="number">100</span> == <span class="number">0</span>) &#123;</span><br><span class="line">                ramWriter.commit();</span><br><span class="line">                ramWriter.close();</span><br><span class="line">                fsWriter.addIndexes(ramDirectory);</span><br><span class="line">                ramDirectory.close();</span><br><span class="line">                fsWriter.commit();</span><br><span class="line">                ramDirectory = <span class="keyword">new</span> <span class="title class_">RAMDirectory</span>();</span><br><span class="line">                ramWriter = <span class="keyword">new</span> <span class="title class_">IndexWriter</span>(ramDirectory, <span class="keyword">new</span> <span class="title class_">IndexWriterConfig</span>(<span class="keyword">new</span> <span class="title class_">WhitespaceAnalyzer</span>()).setOpenMode(IndexWriterConfig.OpenMode.CREATE));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//退出时确保RAMDirectory中内容都被加入本地</span></span><br><span class="line">        <span class="keyword">if</span> (ramWriter != <span class="literal">null</span>) &#123;</span><br><span class="line">            ramWriter.commit();</span><br><span class="line">            ramWriter.close();</span><br><span class="line">            fsWriter.addIndexes(ramDirectory);</span><br><span class="line">            ramDirectory.close();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">IndexSearcher</span> <span class="variable">indexSearcher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexSearcher</span>(DirectoryReader.open(fsWriter.getDirectory()));</span><br><span class="line">        fsWriter.close();</span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> indexSearcher.count(<span class="keyword">new</span> <span class="title class_">MatchAllDocsQuery</span>());</span><br><span class="line">        System.out.println(count);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>索引的同时需要搜索，前提是内存总量大于索引文件总量，如果要求新加入的索引对搜索可见，即实时搜索，要怎么做呢？显然实时搜索需要writer和searcher共用同一份索引，同时要定时的将内存中索引备份到文件系统，否则机器一旦宕机，内存中所有的索引文件都将丢失。代码实现也很简单，在备份的时候，可以使用调度线程去进行备份操作，同时还不影响主线程继续接受索引请求；备份策略有两种：全量和增量，增量直接比较文件名，将新增文件拷贝到文件系统，同时删除已过时的索引文件即可。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.lucene.analysis.core.WhitespaceAnalyzer;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.document.Document;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.document.Field;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.document.StringField;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.index.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.search.IndexSearcher;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.search.MatchAllDocsQuery;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.store.Directory;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.store.FSDirectory;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.store.IOContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.store.RAMDirectory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Path;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ScheduledExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * Created by wangxu on 2017/06/19 15:31.</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * Description: 基于Lucene 6.5开发</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Wang Xu</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> V1.0.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> V1.0.0 &lt;br/&gt;</span></span><br><span class="line"><span class="comment"> * WebSite: http://codepub.cn &lt;br&gt;</span></span><br><span class="line"><span class="comment"> * Licence: Apache v2 License</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RamFSDirectoryDemo</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> IndexWriter ramWriter;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> RAMDirectory ramDirectory;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Backup</span> <span class="variable">backup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Backup</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">//将文件系统中索引文件加载到内存中</span></span><br><span class="line">        <span class="type">FSDirectory</span> <span class="variable">fsDirectory</span> <span class="operator">=</span> FSDirectory.open(Paths.get(<span class="string">&quot;F:/index_RAM_FS&quot;</span>));</span><br><span class="line">        ramDirectory = <span class="keyword">new</span> <span class="title class_">RAMDirectory</span>(fsDirectory, IOContext.READONCE);</span><br><span class="line">        fsDirectory.close();</span><br><span class="line"></span><br><span class="line">        <span class="type">IndexWriterConfig</span> <span class="variable">indexWriterConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexWriterConfig</span>(<span class="keyword">new</span> <span class="title class_">WhitespaceAnalyzer</span>());</span><br><span class="line">        indexWriterConfig.setIndexDeletionPolicy(<span class="keyword">new</span> <span class="title class_">SnapshotDeletionPolicy</span>(<span class="keyword">new</span> <span class="title class_">KeepOnlyLastCommitDeletionPolicy</span>()));</span><br><span class="line">        ramWriter = <span class="keyword">new</span> <span class="title class_">IndexWriter</span>(ramDirectory, indexWriterConfig);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//先添加一条记录</span></span><br><span class="line">        <span class="type">Document</span> <span class="variable">document</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Document</span>();</span><br><span class="line">        document.add(<span class="keyword">new</span> <span class="title class_">StringField</span>(<span class="string">&quot;first&quot;</span>, <span class="string">&quot;first&quot;</span>, Field.Store.YES));</span><br><span class="line">        ramWriter.addDocument(document);</span><br><span class="line">        ramWriter.commit();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//定时备份线程</span></span><br><span class="line">        <span class="type">ScheduledExecutorService</span> <span class="variable">backupThread</span> <span class="operator">=</span> Executors.newSingleThreadScheduledExecutor();</span><br><span class="line">        backupThread.scheduleAtFixedRate(backup, <span class="number">0</span>, <span class="number">2</span>, TimeUnit.SECONDS);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//可以继续接受索引请求</span></span><br><span class="line">        document = <span class="keyword">new</span> <span class="title class_">Document</span>();</span><br><span class="line">        document.add(<span class="keyword">new</span> <span class="title class_">StringField</span>(<span class="string">&quot;key&quot;</span>, <span class="string">&quot;key&quot;</span>, Field.Store.YES));</span><br><span class="line">        ramWriter.addDocument(document);</span><br><span class="line">        ramWriter.commit();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//等待索引拷贝完成</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">5</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//接受搜索请求，可实现实时搜索</span></span><br><span class="line">        <span class="type">IndexSearcher</span> <span class="variable">indexSearcher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexSearcher</span>(DirectoryReader.open(ramWriter.getDirectory()));</span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> indexSearcher.count(<span class="keyword">new</span> <span class="title class_">MatchAllDocsQuery</span>());</span><br><span class="line">        System.out.println(<span class="string">&quot;total hits: &quot;</span> + count);</span><br><span class="line">        System.out.println(<span class="string">&quot;内存中索引文件：&quot;</span> + Arrays.asList(ramDirectory.listAll()));</span><br><span class="line">        <span class="comment">//查看备份索引是否完整，此处有一个注意点，如果需要在备份索引上打开searcher，那么在备份索引文件的时候需要先备份其它文件，最后再备份segments_N文件</span></span><br><span class="line">        <span class="comment">//因为开searcher的时候，会先加载segments_N文件，这种方式可以保证加载完segments_N文件之后，再加载其它文件一定成功</span></span><br><span class="line"></span><br><span class="line">        fsDirectory = FSDirectory.open(Paths.get(<span class="string">&quot;F:/index_RAM_FS&quot;</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;备份中索引文件：&quot;</span> + Arrays.asList(fsDirectory.listAll()));</span><br><span class="line">        backupThread.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Backup</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            IndexWriterConfig config;</span><br><span class="line">            <span class="type">SnapshotDeletionPolicy</span> <span class="variable">indexDeletionPolicy</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="type">IndexCommit</span> <span class="variable">snapshot</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ramWriter.commit();</span><br><span class="line">                config = (IndexWriterConfig) ramWriter.getConfig();</span><br><span class="line">                indexDeletionPolicy = (SnapshotDeletionPolicy) config.getIndexDeletionPolicy();</span><br><span class="line">                snapshot = indexDeletionPolicy.snapshot();</span><br><span class="line">                config.setIndexCommit(snapshot);</span><br><span class="line">                Collection&lt;String&gt; fileNames = snapshot.getFileNames();</span><br><span class="line">                <span class="type">Path</span> <span class="variable">path</span> <span class="operator">=</span> Paths.get(<span class="string">&quot;F:/index_RAM_FS&quot;</span>);</span><br><span class="line">                <span class="comment">//全量增量任选一种即可</span></span><br><span class="line">                <span class="type">boolean</span> <span class="variable">b</span> <span class="operator">=</span> incrementalBackup(fileNames, path);</span><br><span class="line">                <span class="comment">//boolean b = fullBackup(fileNames, path);</span></span><br><span class="line">                <span class="keyword">if</span> (!b) &#123;</span><br><span class="line">                    System.err.println(<span class="string">&quot;Backup occurs error!&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                System.err.println(e.getMessage());</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    indexDeletionPolicy.release(snapshot);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                    System.err.println(e.getMessage());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">fullBackup</span><span class="params">(Collection&lt;String&gt; fileNames, Path path)</span> &#123;</span><br><span class="line">            Objects.requireNonNull(path);</span><br><span class="line">            Directory to;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                to = FSDirectory.open(path);</span><br><span class="line">                <span class="comment">// 全量备份，直接清空拷贝</span></span><br><span class="line">                <span class="keyword">for</span> (File file : path.toFile().listFiles()) &#123;</span><br><span class="line">                    file.delete();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> (String fileName : fileNames) &#123;</span><br><span class="line">                    to.copyFrom(ramDirectory, fileName, fileName, IOContext.DEFAULT);</span><br><span class="line">                &#125;</span><br><span class="line">                to.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">incrementalBackup</span><span class="params">(Collection&lt;String&gt; fileNames, Path path)</span> &#123;</span><br><span class="line">            <span class="comment">// 增量备份，稍微复杂一些，比较文件名，将ramDirectory中新增索引拷贝过去，同时将ramDirectory中不存在的索引但是在path中存在的旧索引删除</span></span><br><span class="line">            Objects.requireNonNull(path);</span><br><span class="line">            <span class="comment">//fileNames被IndexCommit引用，需要重新构造set集合，进行移除操作</span></span><br><span class="line">            Set&lt;String&gt; files = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;(fileNames);</span><br><span class="line">            <span class="keyword">for</span> (File file : path.toFile().listFiles()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (files.contains(file.getName())) &#123;</span><br><span class="line">                    <span class="comment">//该索引已存在，则不拷贝</span></span><br><span class="line">                    files.remove(file.getName());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//删除已经过时的索引</span></span><br><span class="line">                    file.delete();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//拷贝全部新增索引</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Directory</span> <span class="variable">to</span> <span class="operator">=</span> FSDirectory.open(path);</span><br><span class="line">                <span class="keyword">for</span> (String file : files) &#123;</span><br><span class="line">                    to.copyFrom(ramDirectory, file, file, IOContext.DEFAULT);</span><br><span class="line">                &#125;</span><br><span class="line">                to.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>如果内存不够大，不能够存放全部的本地文件系统索引，那么如何实现呢？这时候，需要两套IndexWriter，一套用来处理本地文件系统中的索引，另一套在内存中可以接受新的索引请求；对索引的操作无非就是新增、删除、更新这三种，下面分别论述</p>
</li>
<li><p>删除索引： 对于删除操作比较简单，两个IndexWriter都执行一次即可，如果其中一个IndexWriter中不存在待删除的索引的话，那么对索引文件不会有任何影响；这时候又分两种情况，一是待删除的索引在内存中，那么删除-提交-重新打开索引，耗时很短；二是待删除索引在硬盘上，这时候删除-提交，到底要不要重新打开，需要视业务而定，因为硬盘上的索引通常是很大的，如果频繁删除频繁重新打开的话，是很耗性能的，而如果不重新打开，这时候删除的索引对searcher是不可见的，也就是说用户仍然可以搜索到已删除的索引，比较好的方式是用一个后台线程去定时的重新打开硬盘索引，然后更新searcher即可，但是这样对于删除操作无法做到准实时，会有一定的延时。</p>
</li>
<li><p>新增索引：所有的新增操作都使用内存中的IndexWriter（称为A），然后提交-重新打开索引-更新searcher，一切都是在内存中操作，耗时极短，对于实时搜索是解决了，而且Lucene中已经提供了MultiReader可以组合多个子reader，很适合这种情况；但是当内存中索引尺寸达到一定大小之后，需要将其合并到文件系统中；在合并的时候还需要另外再开一个内存中的IndexWriter（称为B）用来接受索引合并期间的索引新增操作。不过这种方式实现起来很复杂，需要处理很多问题，例如在内存索引 A 和硬盘索引合并期间如果有更新删除操作怎么处理？在合并之后需要更新MultiReader，但是旧的MultiReader上面还挂有搜索请求怎么办？在新开一个内存索引 B 之后，如何让MultiReader覆盖住它？因为在 B 中必须先有索引，然后才能开Reader，进而才能更新MultiReader；若新增索引速度实在太快，在合并过程没有完成的时候，内存索引又满了，要怎么办？除此以外还有很多问题需要考虑。</p>
</li>
<li><p>更新索引：更新其实可以看作是两步操作，先删除后新增，这两步可以借鉴上面的论述。更新操作是无法同时应用于两个IndexWriter的，因为在Lucene中更新的逻辑是这样的，如果存在则更新，如果不存在则新增，那么假设一个IndexWriter中存在，另一个不存在，如果两个都应用更新，那么最后的结果很简单就是存在两份一样的document了。</p>
</li>
</ul>
<p>个人理解优雅的程序应该是简单的，越是简单的程序其实越是健壮，这种方案实现起来很复杂，即使这么复杂的程序实现了，其健壮性仍然值得担忧，所以不是特别推荐使用这种方案。比较好的方案当然是上Elasticsearch集群了，Elasticsearch的刷新时间默认是1s钟，也就是说，最迟1s之后，就可以看到新的数据。当然如果非要针对Lucene进行开发，可以参考<a target="_blank" rel="noopener" href="http://www.cnblogs.com/forfuture1978/archive/2010/11/29/1891476.html">Linked公司开源的Zoie搜索引擎</a>。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.sovdating.com/RPC%20%E7%9B%B8%E5%85%B3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="DJY">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sovdating Linux">
      <meta itemprop="description" content="Hello dev">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Sovdating Linux">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/RPC%20%E7%9B%B8%E5%85%B3/" class="post-title-link" itemprop="url">RPC 相关</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-06-28 00:00:00" itemprop="dateCreated datePublished" datetime="2017-06-28T00:00:00+00:00">2017-06-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-01-26 12:42:23" itemprop="dateModified" datetime="2024-01-26T12:42:23+00:00">2024-01-26</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="RPC"><a href="#RPC" class="headerlink" title="RPC"></a>RPC</h1><ul>
<li>远程调用过程<br>服务消费方（client）以本地调用方式调用远程服务 -<code>[...]</code>- server stub根据解码结果调用本地的服务并响应</li>
<li>所谓RPC框架即是完成中间过程的过程<br>【提供client请求目标的方式-(反)序列化消息体-网络客户端】【网络服务端-(反)序列化消息体-调用服务端-提供服务注册方式】</li>
</ul>
<p>序列化方式：json、xml、hession、protobuf、thrift、text、bytes</p>
<p><img src="http://img0.tuicool.com/qaiMFfA.png!web"></p>
<p>| | | 提供client请求目标的方式 | (反)序列化消息体 | 网络服务 | 暴露服务&#x2F;服务发现 | (反)序列化消息体 | 提供server服务注册方式 | RPC框架初始化 |<br>|:—————:|————————–|—————–|——————-|——————-|——————|—————————|—————|<br>| Dubbo | spring-Bean |  类方法属性(行为)-&gt; <br> Object&lt;-二进制  | tcp(dubbo), nio | zookeeper |  类方法属性(行为)-&gt;反射 <br> 二进制&lt;-Object  | spring-Bean(&gt;ZK) | spring-Schema |<br>| webService-Axis | axis.client.Call | Object-soap(xml) | http | proName.wsdl描述 | soap(xml)-Object | Apache Axis:deploy.wsdd部署<br>或 JAX-WS (注解)   <br>   @WebService,@WebMethod | servlet |<br>| java.rmi | Naming.lookup | 类方法属性(行为)-&gt; <br> Object&lt;-二进制  | tcp(rmi) | rmi_doc | 类方法属性(行为)-&gt;反射 <br> 二进制&lt;-Object  | LocateRegistry.createRegistry <br> Naming.rebind | thread |<br>| RESTful | httpClient | json | http | api_doc | json | spring mvc | servlet |</p>
<p><code>你应该知道的RPC原理 - 推酷</code><br><a target="_blank" rel="noopener" href="http://www.tuicool.com/articles/Z3QBVv">http://www.tuicool.com/articles/Z3QBVv</a></p>
<hr>
<p><code>一个虐你千百遍的问题：“RPC好，还是RESTful好？” - 王启军 - 博客频道 - CSDN.NET</code><br><a target="_blank" rel="noopener" href="http://blog.csdn.net/douliw/article/details/52592188---">http://blog.csdn.net/douliw/article/details/52592188---</a></p>
<hr>
<h1 id="Dubbo"><a href="#Dubbo" class="headerlink" title="Dubbo"></a>Dubbo</h1><ul>
<li><p>节点角色说明<br>Provider:  暴露服务的服务提供方。<br>Consumer:  调用远程服务的服务消费方。<br>Registry:  服务注册与发现的注册中心。<br>Monitor:  统计服务的调用次调和调用时间的监控中心。<br>Container:  服务运行容器</p>
</li>
<li><p>核心部分<br>远程通讯: 提供对多种基于长连接的<code>NIO框架</code>抽象封装，包括多种线程模型，<code>序列化</code>，以及“请求-响应”模式的信息交换方式。<br>集群容错: 提供基于接口方法的透明远程过程调用，包括多协议支持，以及<code>软负载均衡</code>，失败容错，地址路由，动态配置等集群支持。<br>自动发现: 基于<code>注册中心</code>目录服务，使服务消费方能动态的查找服务提供方，使地址透明，使服务提供方可以平滑增加或减少机器。</p>
</li>
</ul>
<h2 id="Dubbo-负载均衡策略提供下列四种方式"><a href="#Dubbo-负载均衡策略提供下列四种方式" class="headerlink" title="Dubbo 负载均衡策略提供下列四种方式"></a>Dubbo 负载均衡策略提供下列四种方式</h2><ul>
<li>Random LoadBalance <code>随机[ 权重 ]</code>，按权重设置随机概率。 Dubbo的默认负载均衡策略</li>
</ul>
<p>在一个截面上碰撞的概率高，但调用量越大分布越均匀，而且按概率使用权重后也比较均匀，有利于动态调整提供者权重。</p>
<ul>
<li>RoundRobin LoadBalance <code>轮循</code>，按公约后的权重设置轮循比率。</li>
</ul>
<p>存在慢的提供者累积请求问题，比如：第二台机器很慢，但没挂，当请求调到第二台时就卡在那，久而久之，所有请求都卡在调到第二台上。</p>
<ul>
<li>LeastActive LoadBalance <code>最少活跃调用数</code>，相同活跃数的随机，活跃数指调用前后计数差。</li>
</ul>
<p>使慢的提供者收到更少请求，因为越慢的提供者的调用前后计数差会越大。</p>
<ul>
<li>ConsistentHash LoadBalance <code>一致性Hash</code>，相同参数的请求总是发到同一提供者。</li>
</ul>
<p>当某一台提供者挂时，原本发往该提供者的请求，基于虚拟节点，平摊到其它提供者，不会引起剧烈变动。</p>
<p><code>Dubbo负载均衡策略 - 清风部落 - 博客园</code><br><a target="_blank" rel="noopener" href="http://www.cnblogs.com/qingfengbuluo/p/5527930.html">http://www.cnblogs.com/qingfengbuluo/p/5527930.html</a></p>
<h2 id="Dubbo的Spring初始化"><a href="#Dubbo的Spring初始化" class="headerlink" title="Dubbo的Spring初始化"></a>Dubbo的Spring初始化</h2><blockquote>
<p>dubbo使用了spring的自定义的Schema完成了dubbo配置的初始化<br><code>dubbo-2.5.3.jar!\META-INF\spring.handlers</code></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http\://code.alibabatech.com/schema/dubbo=com.alibaba.dubbo.config.spring.schema.DubboNamespaceHandler ```</span><br></pre></td></tr></table></figure>
<p>public class DubboNamespaceHandler extends NamespaceHandlerSupport {<br>    public DubboNamespaceHandler() {<br>}</p>
<p>public void init() {<br>    this.registerBeanDefinitionParser(“application”, new DubboBeanDefinitionParser(ApplicationConfig.class, true));<br>    this.registerBeanDefinitionParser(“module”, new DubboBeanDefinitionParser(ModuleConfig.class, true));<br>    this.registerBeanDefinitionParser(“registry”, new DubboBeanDefinitionParser(RegistryConfig.class, true));<br>    this.registerBeanDefinitionParser(“monitor”, new DubboBeanDefinitionParser(MonitorConfig.class, true));<br>    this.registerBeanDefinitionParser(“provider”, new DubboBeanDefinitionParser(ProviderConfig.class, true));<br>    this.registerBeanDefinitionParser(“consumer”, new DubboBeanDefinitionParser(ConsumerConfig.class, true));<br>    this.registerBeanDefinitionParser(“protocol”, new DubboBeanDefinitionParser(ProtocolConfig.class, true));<br>    this.registerBeanDefinitionParser(“service”, new DubboBeanDefinitionParser(ServiceBean.class, true));<br>    this.registerBeanDefinitionParser(“reference”, new DubboBeanDefinitionParser(ReferenceBean.class, false));<br>    this.registerBeanDefinitionParser(“annotation”, new DubboBeanDefinitionParser(AnnotationBean.class, true));<br>}</p>
<p>static {</p>
<pre><code>Version.checkDuplicate(DubboNamespaceHandler.class);
</code></pre>
<p>}<br>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">```</span><br><span class="line">this.finishRefresh();</span><br><span class="line">this.invokeListener(listener, event);// 对 ApplicationListeners触发 Event  </span><br><span class="line">listener.onApplicationEvent(event);</span><br></pre></td></tr></table></figure>
<p><code>com.alibaba.dubbo.config.spring.ServiceBean</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public void onApplicationEvent(ApplicationEvent event) &#123;</span><br><span class="line">    if (ContextRefreshedEvent.class.getName().equals(event.getClass().getName()) &amp;&amp; this.isDelay() &amp;&amp; !this.isExported() &amp;&amp; !this.isUnexported()) &#123;</span><br><span class="line">        if (logger.isInfoEnabled()) &#123;</span><br><span class="line">            logger.info(&quot;The service ready on spring started. service: &quot; + this.getInterface());</span><br><span class="line">        &#125;</span><br><span class="line">        this.export();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p><code>4. dubbo在spring中的初始代</code><br><a target="_blank" rel="noopener" href="http://blog.csdn.net/u012325403/article/details/55261916">http://blog.csdn.net/u012325403/article/details/55261916</a></p>
<hr>
<h1 id="Dubbo-使用示例"><a href="#Dubbo-使用示例" class="headerlink" title="Dubbo 使用示例"></a>Dubbo 使用示例</h1><ul>
<li><p>Service</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 提供方应用信息，用于计算依赖关系 --&gt;</span><br><span class="line">&lt;dubbo:application name=&quot;dubbo-server&quot;/&gt;</span><br><span class="line">&lt;!-- 使用multicast广播注册中心暴露服务地址 --&gt;</span><br><span class="line">&lt;dubbo:registry address=&quot;zookeeper://localhost:2181&quot;/&gt;</span><br><span class="line">&lt;!-- 用dubbo协议在20880端口暴露服务 --&gt;</span><br><span class="line">&lt;dubbo:protocol name=&quot;dubbo&quot; port=&quot;20880&quot;/&gt;</span><br><span class="line">&lt;!-- 声明需要暴露的服务接口 --&gt;</span><br><span class="line">&lt;dubbo:service interface=&quot;com.fengjx.dubbo.service.HelloService&quot; ref=&quot;helloService&quot;/&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">    &lt;!-- 和本地bean一样实现服务 --&gt;</span><br><span class="line">    &lt;bean id=&quot;helloService&quot; class=&quot;com.fengjx.dubbo.service.impl.HelloServiceImpl&quot;/&gt;</span><br><span class="line">``` ```</span><br><span class="line">public class HelloServiceImpl implements HelloService &#123;</span><br><span class="line">    /**</span><br><span class="line">     * 暴露的接口</span><br><span class="line">     *</span><br><span class="line">     * @param name</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public String sayHello(String name) &#123;</span><br><span class="line">        System.out.println(&quot;call sayHello&quot;);</span><br><span class="line">        return &quot;Hello &quot; + name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
<li><p>Client</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 消费方应用名，用于计算依赖关系，不是匹配条件，不要与提供方一样 --&gt;</span><br><span class="line">&lt;dubbo:application name=&quot;dubbo-client&quot;/&gt;</span><br><span class="line">&lt;!-- 使用multicast广播注册中心暴露发现服务地址 --&gt;</span><br><span class="line">&lt;dubbo:registry address=&quot;zookeeper://localhost:2181&quot;/&gt;</span><br><span class="line">&lt;!-- 生成远程服务代理，可以和本地bean一样使用demoService --&gt;</span><br><span class="line">&lt;dubbo:reference id=&quot;helloService&quot; interface=&quot;com.fengjx.dubbo.service.HelloService&quot;/&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;bean id=&quot;helloServiceConsumer&quot; class=&quot;com.fengjx.dubbo.service.HelloServiceConsumer&quot;&gt;</span><br><span class="line">    &lt;property name=&quot;helloService&quot; ref=&quot;helloService&quot;/&gt;</span><br><span class="line">&lt;/bean&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@RunWith(SpringJUnit4ClassRunner.class)</span><br><span class="line">@ContextConfiguration(&quot;/spring.xml&quot;)</span><br><span class="line">public class HelloServiceConsumerTest &#123;</span><br><span class="line">    @Autowired</span><br><span class="line">    private HelloServiceConsumer helloServiceConsumer;</span><br><span class="line">    @Test</span><br><span class="line">    public void test()&#123;</span><br><span class="line">        String res = helloServiceConsumer.helloFjx();</span><br><span class="line">        System.out.println(res);</span><br><span class="line">        assertEquals(&quot;Hello fengjx&quot;,res);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p><code>dubbo接口简单示例，maven + intellj构建</code><br><a target="_blank" rel="noopener" href="https://git.oschina.net/fengjx/dubbo-demo.git">https://git.oschina.net/fengjx/dubbo-demo.git</a></p>
<p><code>Spring+Dubbo+TestNG接口测试 - LangSand的博客 - CSDN博客 </code><br><a target="_blank" rel="noopener" href="http://blog.csdn.net/langsand/article/details/72470720">http://blog.csdn.net/langsand/article/details/72470720</a></p>
<hr>
<h1 id="webService"><a href="#webService" class="headerlink" title="webService"></a>webService</h1><ul>
<li>HelloWorld.java [ JAX-WS ]<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">import javax.jws.WebMethod;</span><br><span class="line">import javax.jws.WebService;</span><br><span class="line">import javax.xml.ws.Endpoint;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@WebService(targetNamespace = &quot;http://localhost:9000/HelloWorld&quot;)</span><br><span class="line">public class HelloWorld &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@WebMethod</span><br><span class="line">public String sayHello(String name) &#123;</span><br><span class="line">System.out.println(name + &quot;,你好&quot;);</span><br><span class="line">return name + &quot;,你好&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">public static void main(String args[])&#123;</span><br><span class="line">Object hello = new HelloWorld();</span><br><span class="line">String address = &quot;http://localhost:9000/HelloWorld&quot;;// 发布到的地址</span><br><span class="line">Endpoint.publish(address, hello);</span><br><span class="line">System.out.println(&quot;发布成功,http://localhost:8989/HelloWorld?wsdl&quot;);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
server依赖<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- https://mvnrepository.com/artifact/org.apache.axis/axis --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">&lt;groupId&gt;org.apache.axis&lt;/groupId&gt;</span><br><span class="line">&lt;artifactId&gt;axis&lt;/artifactId&gt;</span><br><span class="line">&lt;version&gt;1.4&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;!-- https://mvnrepository.com/artifact/org.apache.axis/axis-jaxrpc --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">&lt;groupId&gt;org.apache.axis&lt;/groupId&gt;</span><br><span class="line">&lt;artifactId&gt;axis-jaxrpc&lt;/artifactId&gt;</span><br><span class="line">&lt;version&gt;1.4&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;!-- https://mvnrepository.com/artifact/axis/axis-wsdl4j --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">&lt;groupId&gt;axis&lt;/groupId&gt;</span><br><span class="line">&lt;artifactId&gt;axis-wsdl4j&lt;/artifactId&gt;</span><br><span class="line">&lt;version&gt;1.5.1&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
client依赖<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- https://mvnrepository.com/artifact/commons-logging/commons-logging-api --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">&lt;groupId&gt;commons-logging&lt;/groupId&gt;</span><br><span class="line">&lt;artifactId&gt;commons-logging-api&lt;/artifactId&gt;</span><br><span class="line">&lt;version&gt;1.1&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;!-- https://mvnrepository.com/artifact/commons-discovery/commons-discovery --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">&lt;groupId&gt;commons-discovery&lt;/groupId&gt;</span><br><span class="line">&lt;artifactId&gt;commons-discovery&lt;/artifactId&gt;</span><br><span class="line">&lt;version&gt;0.5&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>生成<code>HelloWorld.wsdl</code> (右键-WebServices<code>-Generate WSDL Form Java Code</code>)</p>
<p><img src="http://7xnbs3.com1.z0.glb.clouddn.com/17-8-12/58767281.jpg"></p>
<ul>
<li><p>浏览器即可访问(工具:Wizdler)<br><img src="http://7xnbs3.com1.z0.glb.clouddn.com/17-8-12/51287937.jpg"></p>
</li>
<li><p>postman也可访问<br><img src="http://7xnbs3.com1.z0.glb.clouddn.com/17-8-12/84860502.jpg"></p>
</li>
</ul>
<h1 id="生成客户端"><a href="#生成客户端" class="headerlink" title="生成客户端"></a>生成客户端</h1><ul>
<li><p>方式一： 选择<code>HelloWorld.wsdl</code>右键-<code>Generate Java Code Form Wsdl</code><br><img src="http://7xnbs3.com1.z0.glb.clouddn.com/17-8-12/124167.jpg"></p>
</li>
<li><p>方式二：  新建工程（<code>Apache Axis为web方式</code>，<code>JAX-WS为注解方式</code>）</p>
</li>
</ul>
<p><img src="http://7xnbs3.com1.z0.glb.clouddn.com/17-8-12/19095284.jpg"></p>
<p><code> intellij 开发webservice - 先知后觉 - 博客园</code><br><a target="_blank" rel="noopener" href="http://www.cnblogs.com/linxiaoyang/p/4167016.html">http://www.cnblogs.com/linxiaoyang/p/4167016.html</a></p>
<p><code>如何用IDEA一步一步开发WebService服务器端</code><br><a target="_blank" rel="noopener" href="http://blog.csdn.net/u010323023/article/details/52926051">http://blog.csdn.net/u010323023/article/details/52926051</a><br><a target="_blank" rel="noopener" href="http://www.biliyu.com/article/986.html">http://www.biliyu.com/article/986.html</a></p>
<p><code>Intellij Idea 下 生成WebServiceClient (WS客户端) - NotFound404 - 博客频道 - CSDN.NET</code><br><a target="_blank" rel="noopener" href="http://blog.csdn.net/qq_35067322/article/details/53558775">http://blog.csdn.net/qq_35067322/article/details/53558775</a></p>
<hr>
<h1 id="RMI"><a href="#RMI" class="headerlink" title="RMI"></a>RMI</h1><p><code>java RMI原理详解 - xinghun_4的专栏 - 博客频道 - CSDN.NET</code><br><a target="_blank" rel="noopener" href="http://blog.csdn.net/xinghun_4/article/details/45787549">http://blog.csdn.net/xinghun_4/article/details/45787549</a></p>
<p><code>Java RMI详解 - 怀揣梦想，努力前行 - 博客频道 - CSDN.NET</code><br><a target="_blank" rel="noopener" href="http://blog.csdn.net/a19881029/article/details/9465663">http://blog.csdn.net/a19881029/article/details/9465663</a></p>
<p><code>Java RMI之HelloWorld篇 - 熔 岩 - 51CTO技术博客</code><br><a target="_blank" rel="noopener" href="http://lavasoft.blog.51cto.com/62575/91679/">http://lavasoft.blog.51cto.com/62575/91679/</a></p>
<hr>
<h1 id="dubbo-与-WebService区别-跨平台思考"><a href="#dubbo-与-WebService区别-跨平台思考" class="headerlink" title="dubbo 与 WebService区别 跨平台思考?"></a>dubbo 与 WebService区别 跨平台思考?</h1><p>Dubbo提供基于接口的透明的远程过程调用，支持<code>多种协议</code>，包括Dubbo、RMI、<code>WebService</code>、Hessian、Http、Thrift、Redis、Memcached。<br>Dubbo基于注册中心的目录服务，使服务消费方能动态的查找服务提供方，支持平滑的减少或增加服务器。</p>
<p><code>分布式服务框架Dubbo入门实践 - 简书</code><br><a target="_blank" rel="noopener" href="http://www.jianshu.com/p/d357dada2ff5">http://www.jianshu.com/p/d357dada2ff5</a></p>
<hr>
<h1 id="EJB"><a href="#EJB" class="headerlink" title="EJB"></a>EJB</h1><p><code>EJB分布式工作原理 - Senssic - 博客频道 - CSDN.NET</code><br><a target="_blank" rel="noopener" href="http://blog.csdn.net/senssic/article/details/11850131">http://blog.csdn.net/senssic/article/details/11850131</a></p>
<p><code>EJB 工作原理 - 企业应用 - Java - ITeye论坛</code><br><a target="_blank" rel="noopener" href="http://www.iteye.com/topic/3832">http://www.iteye.com/topic/3832</a></p>
<p><code>EJB工作原理学习笔记 - 天下无贼 - 51CTO技术博客</code><br><a target="_blank" rel="noopener" href="http://guojuanjun.blog.51cto.com/277646/1351245">http://guojuanjun.blog.51cto.com/277646/1351245</a></p>
<p><code>EJB工作原理学习笔记! - 李晓辉的Blog - 博客频道 - CSDN.NET</code><br><a target="_blank" rel="noopener" href="http://blog.csdn.net/tolixiaohui/article/details/211957">http://blog.csdn.net/tolixiaohui/article/details/211957</a></p>
<ul>
<li><p><code>Weblogic</code><br>WebLogic是美国Oracle公司出品的一个application server，确切的说是一个基于JAVAEE架构的中间件 同类有:tomcat</p>
</li>
<li><p><code> XDoclet</code><br>  XDoclet 是一个通用的代码生成实用程序,是一个扩展的Javadoc Doclet引擎，它允许您使用象 JavaDoc 标记之类的东西来向诸如类、方法和字段之类的语言特征添加元数据<br>  XDoclet 继承了 JavaDoc 引擎的思想，允许根据定制 JavaDoc 标记生成代码和其他文件。当然，XDoclet 也可以访问整个解析树。这样，它就可以访问类、类的包结构和类的方法。</p>
</li>
</ul>
<p><code>XDoclet是什么? - yangjuqi的日志 - 网易博客</code></p>
<p><a target="_blank" rel="noopener" href="http://blog.163.com/yangjuqi@126/blog/static/28452285200791192152923/">http://blog.163.com/yangjuqi@126/blog/static/28452285200791192152923/</a></p>
<hr>
<p><strong>参考</strong><br><code>Dubbo初探 - 推酷</code><br><a target="_blank" rel="noopener" href="http://www.tuicool.com/articles/VrQrUv">http://www.tuicool.com/articles/VrQrUv</a></p>
<p><code>Dubbo源码学习--集群负载均衡算法的实现</code><br><a target="_blank" rel="noopener" href="http://www.cnblogs.com/javanoob/p/dubbo_loadbalance.html">http://www.cnblogs.com/javanoob/p/dubbo_loadbalance.html</a></p>
<p><code>RPC框架与Dubbo完整使用</code><br><a target="_blank" rel="noopener" href="http://blog.csdn.net/u010297957/article/details/51702076">http://blog.csdn.net/u010297957/article/details/51702076</a></p>
<p><code>Java RMI 框架（远程方法调用） - 蚂蚁 - 51CTO技术博客</code><br><a target="_blank" rel="noopener" href="http://haolloyin.blog.51cto.com/1177454/332426/">http://haolloyin.blog.51cto.com/1177454/332426/</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.sovdating.com/%E4%BE%9D%E6%8D%AE%E4%BB%BB%E5%8A%A1%E4%BC%98%E5%85%88%E7%BA%A7,%E5%AE%9E%E7%8E%B0%E5%8F%AF%E6%8F%92%E9%98%9F%E7%9A%84%E7%BA%BF%E7%A8%8B%E6%B1%A0-%E7%AE%80%E8%A3%85/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="DJY">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sovdating Linux">
      <meta itemprop="description" content="Hello dev">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Sovdating Linux">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E4%BE%9D%E6%8D%AE%E4%BB%BB%E5%8A%A1%E4%BC%98%E5%85%88%E7%BA%A7,%E5%AE%9E%E7%8E%B0%E5%8F%AF%E6%8F%92%E9%98%9F%E7%9A%84%E7%BA%BF%E7%A8%8B%E6%B1%A0-%E7%AE%80%E8%A3%85/" class="post-title-link" itemprop="url">依据任务优先级,实现可插队的线程池 -简装</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-06-26 00:00:00" itemprop="dateCreated datePublished" datetime="2017-06-26T00:00:00+00:00">2017-06-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-01-26 12:42:18" itemprop="dateModified" datetime="2024-01-26T12:42:18+00:00">2024-01-26</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="关键"><a href="#关键" class="headerlink" title="关键"></a>关键</h1><ul>
<li>队列： <code>PriorityBlockingQueue</code> 优先级</li>
<li>思路：线程实现Comparable &#x2F; 仅作用在未开始的线程,故注意corePoolSize<br><code>class MyRunnableComp implements Runnable, Comparable&lt;MyRunnableComp&gt;</code></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">package pool.priority;</span><br><span class="line"> </span><br><span class="line">import java.util.concurrent.BlockingQueue;</span><br><span class="line">import java.util.concurrent.PriorityBlockingQueue;</span><br><span class="line">import java.util.concurrent.ThreadPoolExecutor;</span><br><span class="line">import java.util.concurrent.TimeUnit;</span><br><span class="line"> </span><br><span class="line">/**</span><br><span class="line">* [简单封装]依据任务优先级,可插队的线程池</span><br><span class="line">*/</span><br><span class="line">public class MyPriorityThreadPool &#123;</span><br><span class="line"> </span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        ThreadPoolExecutor threadPoolExecutor = new ThreadPool_demo().executor();</span><br><span class="line"> </span><br><span class="line">        boolean coreThreadTimeOut = threadPoolExecutor.allowsCoreThreadTimeOut();// 将包括“核心线程”在内的，没有任务分配的任何线程，在等待keepAliveTime时间后全部进行回收</span><br><span class="line">        System.out.println(coreThreadTimeOut);// 默认是false</span><br><span class="line"> </span><br><span class="line">        for (int i = 0; i &lt; 10; i++) &#123;</span><br><span class="line">            /* 常规线程(先进先出-LinkedTransferQueue[CAS乐观锁]) */</span><br><span class="line">//            threadPoolExecutor.execute(new Runnable() &#123;</span><br><span class="line">//                @Override</span><br><span class="line">//                public void run() &#123;</span><br><span class="line">//                    System.out.println(Thread.currentThread().getName() + &quot;正在执行。。。&quot;);</span><br><span class="line">//                &#125;</span><br><span class="line">//            &#125;);</span><br><span class="line"> </span><br><span class="line">            /* 优先级控制线程(依优先级插队-PriorityBlockingQueue)|仅作用在未开始的线程,故注意corePoolSize */</span><br><span class="line">            threadPoolExecutor.execute(new MyRunnableComp((int) (1000 + Math.random() * (9999 - 1000 + 1))));// 首个立即执行</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">class ThreadPool_demo &#123;</span><br><span class="line">    int corePoolSize = 1;// 核心线程(产生后不释放待复用)</span><br><span class="line">    int maximumPoolSize = 100;// 最大池(核心线程数+临时线程数)</span><br><span class="line">    long keepAliveTime = 0l;// 空闲时间(多出corePoolSize的线程在空闲时间超过 keepAliveTime 时将会终止)</span><br><span class="line">    TimeUnit unit = TimeUnit.MILLISECONDS;// 单位 毫秒 纳秒</span><br><span class="line"> </span><br><span class="line">    // BlockingQueue&lt;Runnable&gt; workQueue = new LinkedBlockingQueue&lt;Runnable&gt;();// 双链表,无限队列大小/ 不会有多于corePoolSize的线程被创建,maximumPoolSize没意义</span><br><span class="line">    // BlockingQueue&lt;Runnable&gt; workQueue = new LinkedTransferQueue&lt;Runnable&gt;();// 无锁方式-CAS ★</span><br><span class="line">    // BlockingQueue&lt;Runnable&gt; workQueue = new SynchronousQueue&lt;Runnable&gt;();// 同步</span><br><span class="line">    BlockingQueue&lt;Runnable&gt; workQueue = new PriorityBlockingQueue&lt;Runnable&gt;();// 优先级</span><br><span class="line"> </span><br><span class="line">    public ThreadPoolExecutor executor() &#123;</span><br><span class="line">        return new ThreadPoolExecutor(corePoolSize, maximumPoolSize, keepAliveTime, unit, workQueue);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">/**</span><br><span class="line">* 优先级可控的线程池</span><br><span class="line">*/</span><br><span class="line">class MyRunnableComp implements Runnable, Comparable&lt;MyRunnableComp&gt; &#123;</span><br><span class="line">    int priority;// 优先级</span><br><span class="line"> </span><br><span class="line">    public MyRunnableComp(int priority) &#123;</span><br><span class="line">        this.priority = priority;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    public int getPriority() &#123;</span><br><span class="line">        return priority;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    public void setPriority(int priority) &#123;</span><br><span class="line">        this.priority = priority;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    @Override</span><br><span class="line">    public void run() &#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + &quot;[&quot; + this.priority + &quot;]&quot; + &quot;正在执行。。。&quot;);</span><br><span class="line">        try &#123;</span><br><span class="line">            Thread.sleep(300);// 延长任务完成时间,给优先级排序预留时间</span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    /**</span><br><span class="line">     * 顺序控制</span><br><span class="line">     * @param o</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public int compareTo(MyRunnableComp o) &#123;</span><br><span class="line">        if (o.getPriority() == this.priority) &#123;</span><br><span class="line">            return 0;</span><br><span class="line">        &#125;</span><br><span class="line">        return o.getPriority() &gt; this.priority ? -1 : 1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">/**</span><br><span class="line">* Java线程池揭秘 - 推酷</span><br><span class="line">* http://www.tuicool.com/articles/32632uB</span><br><span class="line">* &lt;p&gt;</span><br><span class="line">* Java线程池总结 - 推酷</span><br><span class="line">* http://www.tuicool.com/articles/e2aUvyR</span><br><span class="line">* &lt;p&gt;</span><br><span class="line">* PriorityBlockingQueue | 并发编程网 – ifeve.com</span><br><span class="line">* http://ifeve.com/tag/priorityblockingqueue/</span><br><span class="line">*</span><br><span class="line">* Java 7中的TransferQueue | 并发编程网 – ifeve.com</span><br><span class="line">* http://ifeve.com/java-transfer-queue/</span><br><span class="line">*/</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.sovdating.com/API%E5%AE%89%E5%85%A8(https)%E4%B8%8E%E4%BC%9A%E8%AF%9D(OAuth,%E5%8F%82%E6%95%B0%E7%AD%BE%E5%90%8D)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="DJY">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sovdating Linux">
      <meta itemprop="description" content="Hello dev">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Sovdating Linux">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/API%E5%AE%89%E5%85%A8(https)%E4%B8%8E%E4%BC%9A%E8%AF%9D(OAuth,%E5%8F%82%E6%95%B0%E7%AD%BE%E5%90%8D)/" class="post-title-link" itemprop="url">API安全(https)与会话(OAuth,参数签名)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-06-23 00:00:00" itemprop="dateCreated datePublished" datetime="2017-06-23T00:00:00+00:00">2017-06-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-01-26 12:42:27" itemprop="dateModified" datetime="2024-01-26T12:42:27+00:00">2024-01-26</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="https"><a href="#https" class="headerlink" title="https"></a>https</h1><ul>
<li>目标: 网络过程, 加密传输,对称加解密</li>
<li>作用:  劫持,监听,篡改 (广告), 隐私泄露</li>
</ul>
<table>
<thead>
<tr>
<th>&#x2F;</th>
<th>对称密钥如何保护</th>
<th>加密方案约定</th>
<th>互信</th>
<th>被公开的信息</th>
</tr>
</thead>
<tbody><tr>
<td>单向验证</td>
<td>生成随机数作为密钥<br> 传输过程用公钥加密<br> -B公钥不可解密<br> -B私钥可以</td>
<td>明文反馈加密<br>使用预定的加密方案<br>+B公钥+A</td>
<td>随机对称密钥</td>
<td>A获得B证书,进行验证(服务端可信)</td>
</tr>
<tr>
<td>双向验证</td>
<td>生成随机数作为密钥<br> 传输过程用公钥加密<br> -B公钥不可解密<br> -B私钥可以</td>
<td>A公钥加密反馈加密方案<br> (仅A私钥可解) <br> 使用预定的加密方案 <br> +B公钥+A随机对称密钥</td>
<td>A获得B证书,进行验证(服务端可信)<br> B也获得A证书,进行验证(客户端可信)</td>
<td>B 公钥<br> A公钥 <br> 加密过的加密方案(A公钥) <br> 加密过的对称密钥(B公钥)</td>
</tr>
</tbody></table>
<p>3大过程:<code>①公钥交换</code>(用于验证对方和对称密钥的加密) &#x2F; <code>②方案协商</code> &#x2F; <code>③客户端提供对称加密给服务端</code></p>
<hr>
<h1 id="OAuth（开放授权）-用户托管"><a href="#OAuth（开放授权）-用户托管" class="headerlink" title="OAuth（开放授权）[ 用户托管 ]"></a>OAuth（开放授权）[ 用户托管 ]</h1><p><code>理解OAuth 2.0</code><br><a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2014/05/oauth_2_0.html">http://www.ruanyifeng.com/blog/2014/05/oauth_2_0.html</a></p>
<ul>
<li><code>QQ</code> 网页登陆<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">QQ登录OAuth2.0总体处理流程</span><br><span class="line">QQ登录OAuth2.0总体处理流程如下：</span><br><span class="line">Step1：申请接入，获取appid和apikey；</span><br><span class="line">Step2：开发应用，并设置协作者帐号进行测试联调；</span><br><span class="line">Step3：放置QQ登录按钮；</span><br><span class="line">Step4：通过用户登录验证和授权，获取Access Token；</span><br><span class="line">Step5：通过Access Token获取用户的OpenID；</span><br><span class="line">Step6：调用OpenAPI，来请求访问或修改用户授权的资源。 http://wiki.connect.qq.com/oauth2-0%E7%AE%80%E4%BB%8B</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-  开发攻略_ Server-side</span><br><span class="line"></span><br><span class="line">http://wiki.connect.qq.com/%E5%BC%80%E5%8F%91%E6%94%BB%E7%95%A5_server-side</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- 开发攻略_Client-side</span><br><span class="line">http://wiki.connect.qq.com/%E5%BC%80%E5%8F%91%E6%94%BB%E7%95%A5_client-side</span><br></pre></td></tr></table></figure></li>
<li><code>QQ</code> app 登陆<br>注:认证流程一致,仅在各初唤醒QQ的方式不同,app需要通过原生代码拉起 &#x2F; 获取用户信息接口一致(openId-&gt; get_user_info )<br><a target="_blank" rel="noopener" href="http://wiki.connect.qq.com/qq%E7%99%BB%E5%BD%95">http://wiki.connect.qq.com/qq%E7%99%BB%E5%BD%95</a></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Tencent.login	用户使用QQ账号登录应用</span><br><span class="line">Tencent.logout	注销登录</span><br><span class="line">Tencent.reAuth	当应用调用API返回没有权限（返回码为100030)时，可以让用户重新进行授权</span><br><span class="line">Tencent.shareToQQ	可将新闻、图片、文字等分享给QQ好友、群和讨论组</span><br><span class="line">Tencent.setAvatar	设置用户的QQ头像</span><br><span class="line">OpenApi接口	用于调用没有被SDK分装成单独接口的OpenApi，更多功能接口请查看《API列表》</span><br></pre></td></tr></table></figure>


<p>— - <code>微信 </code> 网页登录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1. 第三方发起微信授权登录请求，微信用户允许授权第三方应用后，微信会拉起应用或重定向到第三方网站，并且带上授权临时票据code参数；</span><br><span class="line">2. 通过code参数加上AppID和AppSecret等，通过API换取access_token；</span><br><span class="line">3. 通过access_token进行接口调用，获取用户基本数据资源或帮助用户实现基本操作。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">https://open.weixin.qq.com/cgi-bin/showdocument?action=dir_list&amp;t=resource/res_list&amp;verify=1&amp;id=open1419316505&amp;token=&amp;lang=zh_CN</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><code>微信</code> app登录<br>注:认证流程一致,仅在各初唤醒微信的方式不同,app需要通过原生代码拉起 &#x2F; 获取用户信息接口一致(openId-&gt; get_user_info )</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1. 第三方发起微信授权登录请求，微信用户允许授权第三方应用后，微信会拉起应用或重定向到第三方网站，并且带上授权临时票据code参数；</span><br><span class="line">2. 通过code参数加上AppID和AppSecret等，通过API换取access_token；</span><br><span class="line">3. 通过access_token进行接口调用，获取用户基本数据资源或帮助用户实现基本操作。</span><br><span class="line"></span><br><span class="line">https://open.weixin.qq.com/cgi-bin/showdocument?action=dir_list&amp;t=resource/res_list&amp;verify=1&amp;id=open1419317851&amp;token=&amp;lang=zh_CN</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<ul>
<li>总结:<br>OAuth(用户托管)  : 客户端与服务端之间,把原有的账号密码登录托管至第三方 授权机构,在机构登录后,颁发的 access_token (临时)用户本次业务使用.<br>access_token(临时会话,授权机构颁发)  : 包含了商户信息(appid)与登录用户(openId)的信息,特点是有效期控制.</li>
</ul>
<hr>
<h1 id="会话身份传递"><a href="#会话身份传递" class="headerlink" title="会话身份传递"></a>会话身份传递</h1><ul>
<li>session [管理后台]<br>缺点:依赖 cooke传递sessionId,有跨域屏障</li>
<li><code>账号密码</code> -&gt; token [body 或 get,post]  [前端系统]<br>缺点:存在明文登录前提,有被劫持风险 &#x2F; token被盗情况下,所有业务接口都可调用</li>
<li><code>app_key</code> + md5(<code>param</code>+<code>app_secret</code>)  [get,post 或 body] [接入第三方系统]<br>优点:无需登录即可开始业务,减少账号被劫持的风险 &#x2F; 不用担心签名被盗用<br>缺点:每次交互都要加解密. 唯一风险:单一接口被恶意多次调用</li>
</ul>
<hr>
<h1 id="参数签名"><a href="#参数签名" class="headerlink" title="参数签名"></a>参数签名</h1><ul>
<li>形式<br>商家密钥: app_secret</li>
</ul>
<p>sign&#x3D; MD5(<code> 参数字典序</code>+<code>&amp;key= app_secret</code>)</p>
<p>sign&#x3D;hash_hmac(“sha256”, <code> 参数字典序</code> , app_secret )</p>
<ul>
<li><p>作用:<code> 会话身份传递,防身份伪造,防数据篡改</code></p>
</li>
<li><p>约束<br>1.在不知商家密钥的情况下,无法做出有效的签名,无效的签名在服务端发现时,将不受理业务。<br>2.客户端发起的任何行为都 不可避免 自动化攻击，但无法篡改数据。<br>3.自动化攻击可建立QPS监控, 机器人检测( 行为分析,报文分析)进行阻拦,https双向验证到客户端 。(爬虫,反爬虫)<br>注意：拼装的关键数据(价格)后端决定,避免签名前篡改。-前端校验不可信</p>
</li>
<li><p><code>微信</code> 支付</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">商户系统和微信支付系统主要交互说明：</span><br><span class="line">步骤1：用户在商户APP中选择商品，提交订单，选择微信支付。</span><br><span class="line">步骤2：商户后台收到用户支付单，调用微信支付统一下单接口。参见【统一下单API】。</span><br><span class="line">步骤3：统一下单接口返回正常的prepay_id，再按签名规范重新生成签名后，将数据传输给APP。参与签名的字段名为appid，partnerid，prepayid，noncestr，timestamp，package。注意：package的值格式为Sign=WXPay</span><br><span class="line">步骤4：商户APP调起微信支付。api参见本章节【app端开发步骤说明】</span><br><span class="line">步骤5：商户后台接收支付通知。api参见【支付结果通知API】</span><br><span class="line">步骤6：商户后台查询支付结果。，api参见【查询订单API】</span><br><span class="line">https://pay.weixin.qq.com/wiki/doc/api/app/app.php?chapter=8_3</span><br></pre></td></tr></table></figure>
<p><code>微信支付</code>  <a target="_blank" rel="noopener" href="https://pay.weixin.qq.com/wiki/doc/api/app/app.php?chapter=4_3">https://pay.weixin.qq.com/wiki/doc/api/app/app.php?chapter=4_3</a></p>
</li>
<li><p><code>QQ</code> 手机支付</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">商户系统和手Q支付系统主要交互说明：</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">步骤1：用户在商户APP中选择商品，提交订单，选择手Q支付；</span><br><span class="line">步骤2：商户后台收到用户支付单，调用手Q支付统一下单接口。参见【统一下单API】；</span><br><span class="line">步骤3：统一下单接口返回正常的prepay_id，再按签名规范重新生成签名后，将数据传输给APP；</span><br><span class="line">步骤4：商户APP调起手Q支付；</span><br><span class="line">步骤5：商户后台接收支付通知api，参见【支付结果API】</span><br><span class="line">步骤6：商户后台查询支付结果api，参见【订单查询API】</span><br><span class="line">https://qpay.qq.com/qpaywiki/showdocument.php?pid=38&amp;docid=201</span><br></pre></td></tr></table></figure></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/page/11/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><span class="page-number current">12</span><a class="page-number" href="/page/13/">13</a><span class="space">&hellip;</span><a class="page-number" href="/page/56/">56</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/13/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">DJY</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
