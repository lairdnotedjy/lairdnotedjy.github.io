<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="baidu-site-verification" content="codeva-6wmKWl5hmx" />
<meta name="bytedance-verification-code" content="GcOf/MpQ8shZ5Hh/2hvr" />
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.1.1">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-33RJLY0818"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-33RJLY0818');
</script>

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha256-yIDrPSXHZdOZhAqiBP7CKzIwMQmRCJ8UeB8Jo17YC4o=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.sovdating.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.19.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Hello dev">
<meta property="og:type" content="website">
<meta property="og:title" content="Sovdating Linux">
<meta property="og:url" content="https://www.sovdating.com/page/32/index.html">
<meta property="og:site_name" content="Sovdating Linux">
<meta property="og:description" content="Hello dev">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="DJY">
<meta property="article:tag" content="golang python linux ubuntu centos rust">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://www.sovdating.com/page/32/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/32/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Sovdating Linux - some code for program</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Sovdating Linux</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">some code for program</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>Sitemap</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">DJY</p>
  <div class="site-description" itemprop="description">Hello dev</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">546</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">93</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">381</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.sovdating.com/Lucene-6-0-in-action-the-index-of-hot-backup-and-recovery/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="DJY">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sovdating Linux">
      <meta itemprop="description" content="Hello dev">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Sovdating Linux">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Lucene-6-0-in-action-the-index-of-hot-backup-and-recovery/" class="post-title-link" itemprop="url">Lucene 6.0 实战-索引热备份及恢复</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2016-06-24 23:24:43" itemprop="dateCreated datePublished" datetime="2016-06-24T23:24:43+00:00">2016-06-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-01-26 12:42:22" itemprop="dateModified" datetime="2024-01-26T12:42:22+00:00">2024-01-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Programming-Notes/" itemprop="url" rel="index"><span itemprop="name">Programming Notes</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="索引备份的几个关键问题"><a href="#索引备份的几个关键问题" class="headerlink" title="索引备份的几个关键问题"></a>索引备份的几个关键问题</h3><ul>
<li>最简单的备份方式是关闭IndexWriter，然后逐一拷贝索引文件，但是如果索引比较大，那么这种备份操作会持续较长时间，而在备份期间，程序无法对索引文件进行修改，很多搜索程序是不能接受索引操作期间如此长时间停顿的</li>
<li>那么不关闭IndexWriter又如何呢？这样也不行，因为在拷贝索引期间，如果索引文件发生变化，会导致备份的索引文件损坏</li>
<li>另外一个问题就是如果原索引文件损坏的话，再备份它也毫无意义，所以一定要备份的是最后一次成功commit之后的索引文件</li>
<li>每次在备份之前，如果程序将要覆盖上一个备份，需要先删除备份中未出现在当前快照中的文件，因为这些文件已经不会被当前索引引用了；如果每次都更改备份路径的话，那么就直接拷贝即可</li>
</ul>
<h3 id="索引热备份"><a href="#索引热备份" class="headerlink" title="索引热备份"></a>索引热备份</h3><p>从Lucene 2.3版本开始，Lucene提供了一个热备策略，就是SnapshotDeletionPolicy，这样就能在不关闭IndexWriter的情况下，对程序最近一次索引修改提交操作时的文件引用进行备份，从而能建立一个连续的索引备份镜像。那么你也许会有疑问，在备份期间，索引出现变化怎么办呢？这就是SnapshotDeletionPolicy的牛逼之处，在使用SnapshotDeletionPolicy.snapshot()获取快照之后，索引更新提交时刻的所有文件引用都不会被IndexWriter删除，只要IndexWriter并未关闭，即使IndexWriter在进行更新、优化操作等也不会删除这些文件。如果说索引拷贝过程耗时较长也不会出现问题，因为被拷贝的文件时索引快照，在快照的有效期，其引用的文件会一直存在于磁盘上。</p>
<p>所以在备份期间，索引会比通常情况下占用更大的磁盘空间，当索引备份完成后，可以调用SnapshotDeletionPolicy.release (IndexCommit commit) 释放指定的某次提交，以便让IndexWriter删除这些已被关闭或下次将要更新的文件。</p>
<p>需要注意的是，Lucene对索引文件的写入操作是一次性完成的。这意味着你可以简单通过文件名比对来完成对索引的增量备份备份，你不必查看每个文件的内容，也不必查看该文件上次被修改的时间戳，因为一旦程序从快照中完成文件写入和引用操作，这些文件就不会改变了。</p>
<p>segments.gen文件在每次程序提交索引更新时都会被重写，因此备份模块必须要经常备份该文件，但是在Lucene 6.0中注意segments.gen已经从Lucene索引文件格式中移除，所以无需单独考虑segments.gen的备份策略了。在备份期间，write.lock文件不用拷贝。</p>
<p>SnapshotDeletionPolicy类有两个使用限制</p>
<ul>
<li>该类在同一时刻只保留一个可用的索引快照，当然你也可以解除该限制，方法是通过建立对应的删除策略来同时保留多个索引快照</li>
<li>当前快照不会保存到硬盘，这意味着你关闭旧的IndexWriter并打开一个新的IndexWriter，快照将会被删除，因此在备份结束前是不能关闭IndexWriter的，否则也会报org.apache.lucene.store.AlreadyClosedException: this IndexWriter is closed异常。不过该限制也是很容易解除的：你可以将当前快照存储到磁盘上，然后在打开新的IndexWriter时将该快照保护起来，这样就能在关闭旧的IndexWriter和打开新IndexWriter时继续进行备份操作</li>
</ul>
<p>索引热备份解决方案</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.io.FileUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.analysis.standard.StandardAnalyzer;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.document.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.index.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.search.TermQuery;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.store.FSDirectory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.apache.lucene.document.Field.Store.YES;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试Lucene索引热备</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestIndexBackupRecovery</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">f</span> <span class="operator">=</span> <span class="string">&quot;D:/index_test&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">d</span> <span class="operator">=</span> <span class="string">&quot;D:/index_back&quot;</span>;</span><br><span class="line">        <span class="type">IndexWriterConfig</span> <span class="variable">indexWriterConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexWriterConfig</span>(<span class="keyword">new</span> <span class="title class_">StandardAnalyzer</span>());</span><br><span class="line">        indexWriterConfig.setIndexDeletionPolicy(<span class="keyword">new</span> <span class="title class_">SnapshotDeletionPolicy</span>(<span class="keyword">new</span> <span class="title class_">KeepOnlyLastCommitDeletionPolicy</span>()));</span><br><span class="line">        <span class="type">IndexWriter</span> <span class="variable">writer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexWriter</span>(FSDirectory.open(Paths.get(f)), indexWriterConfig);</span><br><span class="line">        <span class="type">Document</span> <span class="variable">document</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Document</span>();</span><br><span class="line">        document.add(<span class="keyword">new</span> <span class="title class_">StringField</span>(<span class="string">&quot;ID&quot;</span>, <span class="string">&quot;111&quot;</span>, YES));</span><br><span class="line">        document.add(<span class="keyword">new</span> <span class="title class_">IntPoint</span>(<span class="string">&quot;age&quot;</span>, <span class="number">111</span>));</span><br><span class="line">        document.add(<span class="keyword">new</span> <span class="title class_">StoredField</span>(<span class="string">&quot;age&quot;</span>, <span class="number">111</span>));</span><br><span class="line">        writer.addDocument(document);</span><br><span class="line">        writer.commit();</span><br><span class="line">        document = <span class="keyword">new</span> <span class="title class_">Document</span>();</span><br><span class="line">        document.add(<span class="keyword">new</span> <span class="title class_">StringField</span>(<span class="string">&quot;ID&quot;</span>, <span class="string">&quot;222&quot;</span>, Field.Store.YES));</span><br><span class="line">        document.add(<span class="keyword">new</span> <span class="title class_">IntPoint</span>(<span class="string">&quot;age&quot;</span>, <span class="number">333</span>));</span><br><span class="line">        document.add(<span class="keyword">new</span> <span class="title class_">StoredField</span>(<span class="string">&quot;age&quot;</span>, <span class="number">333</span>));</span><br><span class="line">        writer.addDocument(document);</span><br><span class="line">        document.add(<span class="keyword">new</span> <span class="title class_">StringField</span>(<span class="string">&quot;ID&quot;</span>, <span class="string">&quot;333&quot;</span>, Field.Store.YES));</span><br><span class="line">        document.add(<span class="keyword">new</span> <span class="title class_">IntPoint</span>(<span class="string">&quot;age&quot;</span>, <span class="number">555</span>));</span><br><span class="line">        document.add(<span class="keyword">new</span> <span class="title class_">StoredField</span>(<span class="string">&quot;age&quot;</span>, <span class="number">555</span>));</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">            document = <span class="keyword">new</span> <span class="title class_">Document</span>();</span><br><span class="line">            document.add(<span class="keyword">new</span> <span class="title class_">StringField</span>(<span class="string">&quot;ID&quot;</span>, <span class="string">&quot;333&quot;</span>, YES));</span><br><span class="line">            document.add(<span class="keyword">new</span> <span class="title class_">IntPoint</span>(<span class="string">&quot;age&quot;</span>, <span class="number">1000000</span> + i));</span><br><span class="line">            document.add(<span class="keyword">new</span> <span class="title class_">StoredField</span>(<span class="string">&quot;age&quot;</span>, <span class="number">1000000</span> + i));</span><br><span class="line">            document.add(<span class="keyword">new</span> <span class="title class_">StringField</span>(<span class="string">&quot;desc&quot;</span>, <span class="string">&quot;ABCDEFG&quot;</span> + i, YES));</span><br><span class="line">            writer.addDocument(document);</span><br><span class="line">        &#125;</span><br><span class="line">        writer.deleteDocuments(<span class="keyword">new</span> <span class="title class_">TermQuery</span>(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">&quot;ID&quot;</span>, <span class="string">&quot;333&quot;</span>)));</span><br><span class="line">        writer.commit();</span><br><span class="line">        backupIndex(writer, f, d);</span><br><span class="line">        writer.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">backupIndex</span><span class="params">(IndexWriter indexWriter, String indexDir, String</span></span><br><span class="line"><span class="params">            backupIndexDir)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">IndexWriterConfig</span> <span class="variable">config</span> <span class="operator">=</span> (IndexWriterConfig) indexWriter.getConfig();</span><br><span class="line">        <span class="type">SnapshotDeletionPolicy</span> <span class="variable">snapshotDeletionPolicy</span> <span class="operator">=</span> (SnapshotDeletionPolicy) config.getIndexDeletionPolicy();</span><br><span class="line">        <span class="type">IndexCommit</span> <span class="variable">snapshot</span> <span class="operator">=</span> snapshotDeletionPolicy.snapshot();</span><br><span class="line">        <span class="comment">//设置索引提交点，默认是null，会打开最后一次提交的索引点</span></span><br><span class="line">        config.setIndexCommit(snapshot);</span><br><span class="line">        Collection&lt;String&gt; fileNames = snapshot.getFileNames();</span><br><span class="line">        File[] dest = <span class="keyword">new</span> <span class="title class_">File</span>(backupIndexDir).listFiles();</span><br><span class="line">        String sourceFileName;</span><br><span class="line">        String destFileName;</span><br><span class="line">        <span class="keyword">if</span> (dest != <span class="literal">null</span> &amp;&amp; dest.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//先删除备份文件中的在此次快照中已经不存在的文件</span></span><br><span class="line">            <span class="keyword">for</span> (File file : dest) &#123;</span><br><span class="line">                <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">                <span class="comment">//包括文件扩展名</span></span><br><span class="line">                destFileName = file.getName();</span><br><span class="line">                <span class="keyword">for</span> (String fileName : fileNames) &#123;</span><br><span class="line">                    sourceFileName = fileName;</span><br><span class="line">                    <span class="keyword">if</span> (sourceFileName.equals(destFileName)) &#123;</span><br><span class="line">                        flag = <span class="literal">false</span>;</span><br><span class="line">                        <span class="keyword">break</span>;<span class="comment">//跳出内层for循环</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (flag) &#123;</span><br><span class="line">                    file.delete();<span class="comment">//删除</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//然后开始备份快照中新生成的文件</span></span><br><span class="line">            <span class="keyword">for</span> (String fileName : fileNames) &#123;</span><br><span class="line">                <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">                sourceFileName = fileName;</span><br><span class="line">                <span class="keyword">for</span> (File file : dest) &#123;</span><br><span class="line">                    destFileName = file.getName();</span><br><span class="line">                    <span class="comment">//备份中已经存在无需复制，因为Lucene索引是一次写入的，所以只要文件名相同不要要hash检查就可以认为它们的数据是一样的</span></span><br><span class="line">                    <span class="keyword">if</span> (destFileName.equals(sourceFileName)) &#123;</span><br><span class="line">                        flag = <span class="literal">false</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (flag) &#123;</span><br><span class="line">                    <span class="type">File</span> <span class="variable">from</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(indexDir + File.separator + sourceFileName);<span class="comment">//源文件</span></span><br><span class="line">                    <span class="type">File</span> <span class="variable">to</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(backupIndexDir + File.separator + sourceFileName);<span class="comment">//目的文件</span></span><br><span class="line">                    FileUtils.copyFile(from, to);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//备份不存在，直接创建</span></span><br><span class="line">            <span class="keyword">for</span> (String fileName : fileNames) &#123;</span><br><span class="line">                <span class="type">File</span> <span class="variable">from</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(indexDir + File.separator + fileName);<span class="comment">//源文件</span></span><br><span class="line">                <span class="type">File</span> <span class="variable">to</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(backupIndexDir + File.separator + fileName);<span class="comment">//目的文件</span></span><br><span class="line">                FileUtils.copyFile(from, to);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        snapshotDeletionPolicy.release(snapshot);</span><br><span class="line">        <span class="comment">//删除已经不再被引用的索引提交记录</span></span><br><span class="line">        indexWriter.deleteUnusedFiles();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="索引文件格式"><a href="#索引文件格式" class="headerlink" title="索引文件格式"></a>索引文件格式</h3><p>首先索引里都存了些什么呢？一个索引包含一个documents的序列，一个document是一个fields的序列，一个field是一个有名的terms序列，一个term是一个比特序列。</p>
<p>根据<a target="_blank" rel="noopener" href="https://lucene.apache.org/core/6_0_0/core/index.html?org/apache/lucene/codecs/lucene60/package-summary.html">Summary of File Extensions</a>的说明，目前Lucene 6.0中存在的索引格式如下</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Extension</th>
<th>Brief Description</th>
</tr>
</thead>
<tbody><tr>
<td>Segments File</td>
<td>segments_N</td>
<td>Stores information about a commit point</td>
</tr>
<tr>
<td>Lock File</td>
<td>write.lock</td>
<td>The Write lock prevents multiple IndexWriters from writing to the same file</td>
</tr>
<tr>
<td>Segment Info</td>
<td>.si</td>
<td>Stores metadata about a segment</td>
</tr>
<tr>
<td>Compound File</td>
<td>.cfs, .cfe</td>
<td>An optional “virtual” file consisting of all the other index files for systems that frequently run out of file handles</td>
</tr>
<tr>
<td>Fields</td>
<td>.fnm</td>
<td>Stores information about the fields</td>
</tr>
<tr>
<td>Field Index</td>
<td>.fdx</td>
<td>Contains pointers to field data</td>
</tr>
<tr>
<td>Field Data</td>
<td>.fdt</td>
<td>The stored fields for documents</td>
</tr>
<tr>
<td>Term Dictionary</td>
<td>.tim</td>
<td>The term dictionary, stores term info</td>
</tr>
<tr>
<td>Term Index</td>
<td>.tip</td>
<td>The index into the Term Dictionary</td>
</tr>
<tr>
<td>Frequencies</td>
<td>.doc</td>
<td>Contains the list of docs which contain each term along with frequency</td>
</tr>
<tr>
<td>Positions</td>
<td>.pos</td>
<td>Stores position information about where a term occurs in the index</td>
</tr>
<tr>
<td>Payloads</td>
<td>.pay</td>
<td>Stores additional per-position metadata information such as character offsets and user payloads</td>
</tr>
<tr>
<td>Norms</td>
<td>.nvd, .nvm</td>
<td>Encodes length and boost factors for docs and fields</td>
</tr>
<tr>
<td>Per-Document Values</td>
<td>.dvd, .dvm</td>
<td>Encodes additional scoring factors or other per-document information</td>
</tr>
<tr>
<td>Term Vector Index</td>
<td>.tvx</td>
<td>Stores offset into the document data file</td>
</tr>
<tr>
<td>Term Vector Documents</td>
<td>.tvd</td>
<td>Contains information about each document that has term vectors</td>
</tr>
<tr>
<td>Term Vector Fields</td>
<td>.tvf</td>
<td>The field level info about term vectors</td>
</tr>
<tr>
<td>Live Documents</td>
<td>.liv</td>
<td>Info about what files are live</td>
</tr>
<tr>
<td>Point values</td>
<td>.dii, .dim</td>
<td>Holds indexed points, if any</td>
</tr>
</tbody></table>
<p>在Lucene索引结构中，既保存了正向信息，也保存了反向信息。<br>正向信息存储在：索引(index)-&gt;段(segment)-&gt;文档(document)-&gt;field(.fnm&#x2F;.fdx&#x2F;.fdt)-&gt;term(.tvx&#x2F;.tvd&#x2F;.tvf)<br>反向信息存储在：词典(.tim)-&gt;倒排表(.doc&#x2F;.pos)</p>
<p>如果想要查看中文，可以参考<a target="_blank" rel="noopener" href="http://my.oschina.net/rickylau/blog/527602">这里</a>。</p>
<h3 id="恢复索引"><a href="#恢复索引" class="headerlink" title="恢复索引"></a>恢复索引</h3><p>恢复索引步骤如下</p>
<ul>
<li>关闭索引目录下的全部reader和writer，这样才能进行文件恢复。对于Windows系统来说，如果还有其它进程在使用这些文件，那么备份程序仍然不能覆盖这些文件</li>
<li>删除当前索引目录下的所有文件，如果删除过程出现“访问被拒绝”（Access is denied）错误，那么再次检查上一步是否已完成</li>
<li>从备份目录中拷贝文件至索引目录。程序需要保证该拷贝操作不会碰到任何错误，如磁盘空间已满等，因为这些错误会损坏索引文件</li>
<li>对于损坏索引，可以使用CheckIndex（org.apache.lucene.index）进行检查并修复</li>
</ul>
<p>通常Lucene能够很好地避免大多数常见错误，如果程序遇到磁盘空间已满或者OutOfMemoryException异常，那么它只会丢失内存缓冲中的文档，已经编入索引的文档将会完好保存下来，并且索引也会保持原样。这个结果对于以下情况同样适用：如出现JVM崩溃，或者程序碰到无法控制的异常，或者程序进程被终止，或者操作系统崩溃，或者计算机突然断电等。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> source 索引源</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> dest 索引目标</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> indexWriterConfig 配置相关</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">recoveryIndex</span><span class="params">(String source, String dest, IndexWriterConfig indexWriterConfig)</span> &#123;</span><br><span class="line">    <span class="type">IndexWriter</span> <span class="variable">indexWriter</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        indexWriter = <span class="keyword">new</span> <span class="title class_">IndexWriter</span>(FSDirectory.open(Paths.get(dest)), indexWriterConfig);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;&quot;</span>, e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">//说明IndexWriter正常打开了，无需恢复</span></span><br><span class="line">        <span class="keyword">if</span> (indexWriter != <span class="literal">null</span> &amp;&amp; indexWriter.isOpen()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                indexWriter.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//说明IndexWriter已经无法打开，使用备份恢复索引</span></span><br><span class="line">            <span class="comment">//此处简单操作，先清空损坏的索引文件目录，如果索引特别大，可以比对每个文件，不必全部删除  try &#123;</span></span><br><span class="line">            FileUtils.deleteDirectory(<span class="keyword">new</span> <span class="title class_">File</span>(dest));</span><br><span class="line">            FileUtils.copyDirectory(<span class="keyword">new</span> <span class="title class_">File</span>(source), <span class="keyword">new</span> <span class="title class_">File</span>(dest));</span><br><span class="line">        &#125; <span class="keyword">catch</span>(IOException e)&#123;</span><br><span class="line">            log.error(<span class="string">&quot;&quot;</span>, e);</span><br><span class="line">            <span class="comment">//使用备份恢复出错，那么就使用最后一招修复索引</span></span><br><span class="line">            log.info(<span class="string">&quot;Check index &#123;&#125; now!&quot;</span>, dest);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                IndexUtils.checkIndex(dest);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException | InterruptedException e1) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;Check index error!&quot;</span>, e1);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="修复索引"><a href="#修复索引" class="headerlink" title="修复索引"></a>修复索引</h3><p>当其它所有方法都无法解决索引损坏问题时，你的最后一个选项就是使用CheckIndex工具了。该工具除了能汇报索引细节状况以外，还能完成修复索引的工作。该工具会强制删除索引中出现问题的段，需要注意的是，该操作还会全部删除这些段包含的文档，该工具的使用目标应主要着眼于能够在紧急状况下让搜索程序再次运行起来，一旦我们进行了索引备份，并且备份完好，应优先使用恢复索引，而不是修复索引。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * CheckIndex会检查索引中的每个字节，所以当索引比较大时，此操作会比较耗时</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> InterruptedException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">checkIndex</span><span class="params">(String indexFilePath)</span> <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">    <span class="type">CheckIndex</span> <span class="variable">checkIndex</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CheckIndex</span>(FSDirectory.open(Paths.get(indexFilePath)));</span><br><span class="line">    checkIndex.setInfoStream(System.out);</span><br><span class="line">    CheckIndex.<span class="type">Status</span> <span class="variable">status</span> <span class="operator">=</span> checkIndex.checkIndex();</span><br><span class="line">    <span class="keyword">if</span> (status.clean) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Check Index successfully！&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//产生索引中的某个文件之后再次测试</span></span><br><span class="line">        System.out.println(<span class="string">&quot;Starting repair index files...&quot;</span>);</span><br><span class="line">        <span class="comment">//该方法会向索引中写入一个新的segments文件，但是并不会删除不被引用的文件，除非当你再次打开IndexWriter才会移除不被引用的文件</span></span><br><span class="line">        <span class="comment">//该方法会移除所有存在错误段中的Document索引文件</span></span><br><span class="line">        checkIndex.exorciseIndex(status);</span><br><span class="line">        checkIndex.close();</span><br><span class="line">        <span class="comment">//测试修复完毕之后索引是否能够打开</span></span><br><span class="line">        <span class="type">IndexWriter</span> <span class="variable">indexWriter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexWriter</span>(FSDirectory.open(Paths.get(indexFilePath)), <span class="keyword">new</span> <span class="title class_">IndexWriterConfig</span>(<span class="keyword">new</span></span><br><span class="line">                <span class="title class_">StandardAnalyzer</span>()));</span><br><span class="line">        System.out.println(indexWriter.isOpen());</span><br><span class="line">        indexWriter.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果索引完好，输出如下信息：</p>
<blockquote>
<p>Segments file&#x3D;segments_2 numSegments&#x3D;2 version&#x3D;6.0.0 id&#x3D;2jlug2dgsc4tmgkf5rck1xgm4<br>  1 of 2: name&#x3D;_0 maxDoc&#x3D;1<br>    version&#x3D;6.0.0<br>    id&#x3D;2jlug2dgsc4tmgkf5rck1xgm1<br>    codec&#x3D;Lucene60<br>    compound&#x3D;true<br>    numFiles&#x3D;3<br>    size (MB)&#x3D;0.002<br>    diagnostics &#x3D; {java.runtime.version&#x3D;1.8.0_45-b15, java.vendor&#x3D;Oracle Corporation, java.version&#x3D;1.8.0_45, java.vm.version&#x3D;25.45-b02, lucene.version&#x3D;6.0.0, os&#x3D;Windows 7, os.arch&#x3D;amd64, os.version&#x3D;6.1, source&#x3D;flush, timestamp&#x3D;1464159740092}<br>    no deletions<br>    test: open reader………OK [took 0.051 sec]<br>    test: check integrity…..OK [took 0.000 sec]<br>    test: check live docs…..OK [took 0.000 sec]<br>    test: field infos………OK [2 fields] [took 0.000 sec]<br>    test: field norms………OK [0 fields] [took 0.000 sec]<br>    test: terms, freq, prox…OK [1 terms; 1 terms&#x2F;docs pairs; 0 tokens] [took 0.007 sec]<br>    test: stored fields…….OK [2 total field count; avg 2.0 fields per doc] [took 0.008 sec]<br>    test: term vectors……..OK [0 total term vector count; avg 0.0 term&#x2F;freq vector fields per doc] [took 0.000 sec]<br>    test: docvalues………..OK [0 docvalues fields; 0 BINARY; 0 NUMERIC; 0 SORTED; 0 SORTED_NUMERIC; 0 SORTED_SET] [took 0.000 sec]<br>    test: points…………..OK [1 fields, 1 points] [took 0.001 sec]<br>  2 of 2: name&#x3D;_1 maxDoc&#x3D;1001<br>    version&#x3D;6.0.0<br>    id&#x3D;2jlug2dgsc4tmgkf5rck1xgm3<br>    codec&#x3D;Lucene60<br>    compound&#x3D;true<br>    numFiles&#x3D;4<br>    size (MB)&#x3D;0.023<br>    diagnostics &#x3D; {java.runtime.version&#x3D;1.8.0_45-b15, java.vendor&#x3D;Oracle Corporation, java.version&#x3D;1.8.0_45, java.vm.version&#x3D;25.45-b02, lucene.version&#x3D;6.0.0, os&#x3D;Windows 7, os.arch&#x3D;amd64, os.version&#x3D;6.1, source&#x3D;flush, timestamp&#x3D;1464159740329}<br>    has deletions [delGen&#x3D;1]<br>    test: open reader………OK [took 0.003 sec]<br>    test: check integrity…..OK [took 0.000 sec]<br>    test: check live docs…..OK [1000 deleted docs] [took 0.000 sec]<br>    test: field infos………OK [3 fields] [took 0.000 sec]<br>    test: field norms………OK [0 fields] [took 0.000 sec]<br>    test: terms, freq, prox…OK [1 terms; 1 terms&#x2F;docs pairs; 0 tokens] [took 0.008 sec]<br>    test: stored fields…….OK [2 total field count; avg 2.0 fields per doc] [took 0.012 sec]<br>    test: term vectors……..OK [0 total term vector count; avg 0.0 term&#x2F;freq vector fields per doc] [took 0.000 sec]<br>    test: docvalues………..OK [0 docvalues fields; 0 BINARY; 0 NUMERIC; 0 SORTED; 0 SORTED_NUMERIC; 0 SORTED_SET] [took 0.000 sec]<br>    test: points…………..OK [1 fields, 1001 points] [took 0.001 sec]<br>No problems were detected with this index.<br>Took 0.159 sec total.<br>Check Index successfully！</p>
</blockquote>
<p>在破坏索引之后（删除了一个cfe文件），再次运行输出</p>
<blockquote>
<p>Segments file&#x3D;segments_2 numSegments&#x3D;2 version&#x3D;6.0.0 id&#x3D;2jlug2dgsc4tmgkf5rck1xgm4<br>  1 of 2: name&#x3D;_0 maxDoc&#x3D;1<br>    version&#x3D;6.0.0<br>    id&#x3D;2jlug2dgsc4tmgkf5rck1xgm1<br>    codec&#x3D;Lucene60<br>    compound&#x3D;true<br>    numFiles&#x3D;3<br>FAILED<br>    WARNING: exorciseIndex() would remove reference to this segment; full exception:<br>java.nio.file.NoSuchFileException: D:\index_test_0.cfe<br>    at sun.nio.fs.WindowsException.translateToIOException(WindowsException.java:79)<br>…<br>…<br>    at java.lang.reflect.Method.invoke(Method.java:497)<br>    at com.intellij.rt.execution.application.AppMain.main(AppMain.java:144)<br>  2 of 2: name&#x3D;_1 maxDoc&#x3D;1001<br>    version&#x3D;6.0.0<br>    id&#x3D;2jlug2dgsc4tmgkf5rck1xgm3<br>    codec&#x3D;Lucene60<br>    compound&#x3D;true<br>    numFiles&#x3D;4<br>    size (MB)&#x3D;0.023<br>    diagnostics &#x3D; {java.runtime.version&#x3D;1.8.0_45-b15, java.vendor&#x3D;Oracle Corporation, java.version&#x3D;1.8.0_45, java.vm.version&#x3D;25.45-b02, lucene.version&#x3D;6.0.0, os&#x3D;Windows 7, os.arch&#x3D;amd64, os.version&#x3D;6.1, source&#x3D;flush, timestamp&#x3D;1464159740329}<br>    has deletions [delGen&#x3D;1]<br>    test: open reader………OK [took 0.059 sec]<br>    test: check integrity…..OK [took 0.000 sec]<br>    test: check live docs…..OK [1000 deleted docs] [took 0.001 sec]<br>    test: field infos………OK [3 fields] [took 0.000 sec]<br>    test: field norms………OK [0 fields] [took 0.000 sec]<br>    test: terms, freq, prox…OK [1 terms; 1 terms&#x2F;docs pairs; 0 tokens] [took 0.013 sec]<br>    test: stored fields…….OK [2 total field count; avg 2.0 fields per doc] [took 0.016 sec]<br>    test: term vectors……..OK [0 total term vector count; avg 0.0 term&#x2F;freq vector fields per doc] [took 0.000 sec]<br>    test: docvalues………..OK [0 docvalues fields; 0 BINARY; 0 NUMERIC; 0 SORTED; 0 SORTED_NUMERIC; 0 SORTED_SET] [took 0.000 sec]<br>    test: points…………..OK [1 fields, 1001 points] [took 0.002 sec]<br>WARNING: 1 broken segments (containing 1 documents) detected<br>Took 0.165 sec total.<br>Starting repair index files…<br>true</p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.sovdating.com/Lucene-6-0-in-action-index-backup-No-index-commit-to-snapshot/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="DJY">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sovdating Linux">
      <meta itemprop="description" content="Hello dev">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Sovdating Linux">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Lucene-6-0-in-action-index-backup-No-index-commit-to-snapshot/" class="post-title-link" itemprop="url">Lucene 6.0 实战-索引备份No index commit to snapshot</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2016-06-24 23:16:03" itemprop="dateCreated datePublished" datetime="2016-06-24T23:16:03+00:00">2016-06-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-01-26 12:42:18" itemprop="dateModified" datetime="2024-01-26T12:42:18+00:00">2024-01-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Programming-Notes/" itemprop="url" rel="index"><span itemprop="name">Programming Notes</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="备份之前先提交"><a href="#备份之前先提交" class="headerlink" title="备份之前先提交"></a>备份之前先提交</h3><p>在使用Lucene进行索引备份的时候，报错</p>
<blockquote>
<p>Exception in thread “main” java.lang.IllegalStateException: No index commit to snapshot<br>at org.apache.lucene.index.SnapshotDeletionPolicy.snapshot(SnapshotDeletionPolicy.java:160)</p>
</blockquote>
<p>其中导致抛错的代码是</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">SnapshotDeletionPolicy</span> <span class="variable">snapshotDeletionPolicy</span> <span class="operator">=</span> (SnapshotDeletionPolicy)</span><br><span class="line">indexWriter.getConfig().getIndexDeletionPolicy();</span><br><span class="line"><span class="type">IndexCommit</span> <span class="variable">snapshot</span> <span class="operator">=</span> snapshotDeletionPolicy.snapshot();</span><br></pre></td></tr></table></figure>
<p>查看snapshot()方法源码发现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (lastCommit == <span class="literal">null</span>) &#123;</span><br><span class="line">  <span class="comment">// No commit yet, eg this is a new IndexWriter:</span></span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;No index commit to snapshot&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可见如果是第一次也就是说还没有commit过，这种情况通常是第一次使用IndexWriter的时候，那么就会抛此异常。解决办法很简单，就是在热备之前commit索引，将所有的缓存flush到硬盘，这也是热备的正确逻辑，可以确保将索引的最新变动保存到备份之中。</p>
<h3 id="确保使用同一个SnapshotDeletionPolicy"><a href="#确保使用同一个SnapshotDeletionPolicy" class="headerlink" title="确保使用同一个SnapshotDeletionPolicy"></a>确保使用同一个SnapshotDeletionPolicy</h3><p>另外还有一点需要注意，如果你在备份的时候使用的是新new的SnapshotDeletionPolicy，那么同样会抛出此异常</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SnapshotDeletionPolicy snapshot= <span class="keyword">new</span> <span class="title class_">SnapshotDeletionPolicy</span>(<span class="keyword">new</span> <span class="title class_">KeepOnlyLastCommitDeletionPolicy</span>());</span><br><span class="line"><span class="type">IndexCommit</span> <span class="variable">commit</span> <span class="operator">=</span> snapshot.snapshot();</span><br><span class="line">Collection&lt;String&gt; fileNames = commit.getFileNames();</span><br></pre></td></tr></table></figure>
<p>这是因为采用new的形式得到的SnapshotDeletionPolicy和最初实例化IndexWriter的时候使用的并不是同一个，所以对于IndexWriter所做的提交，新的SnapshotDeletionPolicy是无法知道的。正确方式如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">IndexWriterConfig</span> <span class="variable">config</span> <span class="operator">=</span> (IndexWriterConfig) indexWriter.getConfig();</span><br><span class="line"><span class="type">SnapshotDeletionPolicy</span> <span class="variable">snapshotDeletionPolicy</span> <span class="operator">=</span> (SnapshotDeletionPolicy) </span><br><span class="line">config.getIndexDeletionPolicy();</span><br><span class="line"><span class="type">IndexCommit</span> <span class="variable">snapshot</span> <span class="operator">=</span> snapshotDeletionPolicy.snapshot();</span><br><span class="line"><span class="comment">//设置索引提交点，默认是null，会打开最后一次提交的索引点</span></span><br><span class="line">config.setIndexCommit(snapshot);</span><br><span class="line">Collection&lt;String&gt; fileNames = snapshot.getFileNames();</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.sovdating.com/%E6%9C%89%E6%95%88%E6%B8%85%E7%90%86%E5%BE%AE%E4%BF%A1%E5%86%85%E7%BD%AE%E6%B5%8F%E8%A7%88%E5%99%A8%EF%BC%88x5%E5%86%85%E6%A0%B8%EF%BC%89%E7%BC%93%E5%AD%98%E5%8A%9E%E6%B3%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="DJY">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sovdating Linux">
      <meta itemprop="description" content="Hello dev">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Sovdating Linux">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E6%9C%89%E6%95%88%E6%B8%85%E7%90%86%E5%BE%AE%E4%BF%A1%E5%86%85%E7%BD%AE%E6%B5%8F%E8%A7%88%E5%99%A8%EF%BC%88x5%E5%86%85%E6%A0%B8%EF%BC%89%E7%BC%93%E5%AD%98%E5%8A%9E%E6%B3%95/" class="post-title-link" itemprop="url">有效清理微信内置浏览器（x5内核）缓存办法</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2016-06-21 00:00:00" itemprop="dateCreated datePublished" datetime="2016-06-21T00:00:00+00:00">2016-06-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-01-26 12:42:26" itemprop="dateModified" datetime="2024-01-26T12:42:26+00:00">2024-01-26</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="有效清理微信内置浏览器（x5内核）缓存办法"><a href="#有效清理微信内置浏览器（x5内核）缓存办法" class="headerlink" title="有效清理微信内置浏览器（x5内核）缓存办法"></a>有效清理微信内置浏览器（x5内核）缓存办法</h1><p><a target="_blank" rel="noopener" href="http://debugx5.qq.com/">http://debugx5.qq.com/</a></p>
<p><img src="http://7xnbs3.com1.z0.glb.clouddn.com/16-7-9/48010338.jpg"></p>
<ul>
<li>源码分析<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">//****************************************************清除Cookie 缓存，广告部分。****************************************************/</span><br><span class="line">    function clearCookieAndCache()</span><br><span class="line">    &#123;</span><br><span class="line">        var cookiechecked = document.getElementById(&quot;id_clearcookie&quot;).checked;</span><br><span class="line">        var filecachechecked = document.getElementById(&quot;id_clearfilecache&quot;).checked;</span><br><span class="line">        var adfiltercachechecked = document.getElementById(&quot;id_clearadfiltercache&quot;).checked;</span><br><span class="line">        var dnscachechecked = document.getElementById(&quot;id_cleardns&quot;).checked;</span><br><span class="line"> </span><br><span class="line">        var clearItems = (cookiechecked ? 1: 0)  + ( filecachechecked ? 2 : 0 )+</span><br><span class="line">            (adfiltercachechecked ? 4 : 0) + (dnscachechecked ? 8 :0) ;</span><br><span class="line">        if(clearItems == 0)</span><br><span class="line">        &#123;</span><br><span class="line">            resultTips(&quot;请选择需要被清除的选项。&quot;, 1000);</span><br><span class="line">            return ;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        window.ProxyStatus.clearCookieAndCache(clearItems);</span><br><span class="line">        resultTips((cookiechecked ? &quot;[Cookie] &quot;:&quot;&quot;) + (filecachechecked ? &quot;[文件缓存] &quot;:&quot;&quot;) +</span><br><span class="line">                (adfiltercachechecked ? &quot;[广告过滤缓存] &quot;:&quot;&quot;) + (dnscachechecked ? &quot;[DNS缓存]&quot; :&quot;&quot;)</span><br><span class="line">                + &quot;被清空。&quot; , 1000);</span><br><span class="line"> </span><br><span class="line">        document.getElementById(&quot;id_clearcookie&quot;).checked = false;</span><br><span class="line">        document.getElementById(&quot;id_clearfilecache&quot;).checked = false;</span><br><span class="line">        document.getElementById(&quot;id_clearadfiltercache&quot;).checked = false;</span><br><span class="line">        document.getElementById(&quot;id_cleardns&quot;).checked = false;</span><br><span class="line">    &#125;</span><br><span class="line">    //*************************************************************************************************************************/</span><br></pre></td></tr></table></figure></li>
<li>思路(10进制转换二进制，使用位信息进行状态区分)<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">(1).toString(2)  &quot;1&quot;</span><br><span class="line">(2).toString(2)  &quot;10&quot;</span><br><span class="line">(4).toString(2) &quot;100&quot;</span><br><span class="line"></span><br><span class="line">(8).toString(2) &quot;1000&quot;</span><br><span class="line"></span><br><span class="line">1 =        1</span><br><span class="line"></span><br><span class="line">2 =      10</span><br><span class="line"></span><br><span class="line">4 =    100</span><br><span class="line">8 =  1000</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 比较方法:</span><br><span class="line"></span><br><span class="line">1+2+4=7</span><br><span class="line">(7).toString(2)  &quot; 111 &quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 是否包含运算符</span><br><span class="line">（返回值：位值相同为1，不同放回为0/1,2,4仅有一位1值所以，结果等于0则不存在，大于0则存在）</span><br><span class="line">(1 &amp; 7).toString(2) &quot;1&quot;</span><br><span class="line">(2 &amp; 7).toString(2) &quot;10&quot;</span><br><span class="line">(4 &amp; 7).toString(2) &quot;100&quot;</span><br></pre></td></tr></table></figure></li>
<li>简易清理<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">window.ProxyStatus.clearCookieAndCache(1);// 清理 [Cookie]</span><br><span class="line"></span><br><span class="line">window.ProxyStatus.clearCookieAndCache(2);// 清理 [文件缓存] ★</span><br><span class="line"></span><br><span class="line">window.ProxyStatus.clearCookieAndCache(4);// 清理 [广告过滤缓存]</span><br><span class="line"></span><br><span class="line">window.ProxyStatus.clearCookieAndCache(8);// 清理 [DNS缓存]</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h1 id="chrome-清理缓存办法"><a href="#chrome-清理缓存办法" class="headerlink" title="chrome 清理缓存办法"></a>chrome 清理缓存办法</h1><p>查看：<a href="chrome://view-http-cache"> chrome:&#x2F;&#x2F;view-http-cache </a><br>清理： <a href="chrome://net-internals/#dns"> chrome:&#x2F;&#x2F;net-internals&#x2F;#dns </a><br><img src="http://7xnbs3.com1.z0.glb.clouddn.com/16-7-9/2970620.jpg"></p>
<p><code>如何清除Chrome的dns cache(不重启Chrome) - 谷歌 (Google) - 知乎</code><br><a target="_blank" rel="noopener" href="http://www.zhihu.com/question/19721279">http://www.zhihu.com/question/19721279</a></p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/%E6%9C%89%E6%95%88%E6%B8%85%E7%90%86%E5%BE%AE%E4%BF%A1%E5%86%85%E7%BD%AE%E6%B5%8F%E8%A7%88%E5%99%A8%EF%BC%88x5%E5%86%85%E6%A0%B8%EF%BC%89%E7%BC%93%E5%AD%98%E5%8A%9E%E6%B3%95/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.sovdating.com/sql%E7%BC%96%E7%A8%8B%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="DJY">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sovdating Linux">
      <meta itemprop="description" content="Hello dev">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Sovdating Linux">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/sql%E7%BC%96%E7%A8%8B%E5%AD%A6%E4%B9%A0/" class="post-title-link" itemprop="url">sql编程学习</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2016-06-16 00:00:00" itemprop="dateCreated datePublished" datetime="2016-06-16T00:00:00+00:00">2016-06-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-01-26 12:42:18" itemprop="dateModified" datetime="2024-01-26T12:42:18+00:00">2024-01-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/sql%E7%BC%96%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">sql编程</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="系统函数"><a href="#系统函数" class="headerlink" title="系统函数"></a>系统函数</h1><blockquote>
<p>系统函数   数据库系统定义的函数，即内置函数</p>
</blockquote>
<p>|  函数列别 |     说明  |<br>| :——– |  : ——–|<br>| 聚合函数   |   执行的操作是将多个值合并为一个值。例如 COUNT、SUM、MIN 和MAX。<br>| 配置函数   |   是一种标量函数，可返回有关配置设置的信息。<br>|   加密函数   |   支持加密、解密、数字签名和数字签名验证。<br>|   游标函数   |   返回有关游标状态的信息。<br>|   日期和时间函数   |   可以更改日期和时间的值。<br>|   数学函数   |   执行三角、几何和其他数字运算。<br>|   元数据函数  |    返回数据库和数据库对象的属性信息。<br>|   排名函数   |   是一种非确定性函数，可以返回分区中每一行的排名值。<br>|   行集函数   |   返回可在 Transact-SQL 语句中表引用所在位置使用的行集。<br>|   安全函数  |    返回有关用户和角色的信息。<br>|   字符串函数    |  可更改 char、varchar、nchar、nvarchar、binary 和 varbinary 的值。<br>|   系统函数   |   对系统级的各种选项和对象进行操作或报告。<br>|   系统统计函数   |   返回有关 SQL Server 性能的信息。<br>|   文本和图像函数   |   可更改 text 和 image 的值。</p>
<h2 id="常用函数，练习"><a href="#常用函数，练习" class="headerlink" title="常用函数，练习"></a>常用函数，练习</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"># 字符串函数</span><br><span class="line">select ASCII(&#x27;中&#x27;);    # 返回字符的ASCII码值   </span><br><span class="line">select BIT_LENGTH(&#x27;中&#x27;);    # 返回字符串的比特长度   </span><br><span class="line">select LENGTH(&#x27;中&#x27;);    # 返回字符串str中的字符数   </span><br><span class="line">select CONCAT(&#x27;钓&#x27;,&#x27;鱼&#x27;,&#x27;岛&#x27;);    # 将s1,s2…,sn连接成字符串    任何字符串与NULL进行连接的结果都将是NULL</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 数值函数</span><br><span class="line">select ABS(2);    # 返回x的绝对值</span><br><span class="line">select ABS(-2);    # 返回x的绝对值</span><br><span class="line">select BIN(2); #    返回x的二进制（OCT返回八进制，HEX返回十六进制）</span><br><span class="line">select CEILING(2.2); # 返回大于x的最小整数值</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 日期时间函数</span><br><span class="line">select CURRENT_DATE();# 返回当前的日期</span><br><span class="line">select CURRENT_TIME();#    返回当前的时间</span><br><span class="line">select SYSDATE();# 系统时间</span><br><span class="line">select DATE_ADD(SYSDATE(),INTERVAL 1 day);# 返回日期date加上间隔时间int的结果(int必须按照关键字进行格式化),如：SELECT DATE_ADD(CURRENT_DATE,INTERVAL 6 MONTH);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 流程函数</span><br><span class="line">select (CASE WHEN &#x27;钓鱼岛&#x27; = &#x27;日本&#x27; THEN &#x27;yes&#x27; ELSE &#x27;no&#x27; END); # 如果testN是真，则返回resultN，否则返回default</span><br><span class="line">select (CASE &#x27;钓鱼岛&#x27; WHEN &#x27;日本&#x27; THEN &#x27;yes&#x27; ELSE &#x27;no&#x27; END); # 如果test和valN相等，则返回resultN，否则返回default</span><br><span class="line">select if(&#x27;钓鱼岛&#x27;=&#x27;日本&#x27;,&#x27;yes&#x27;,&#x27;no&#x27;); # 如果test是真，返回t；否则返回 f</span><br><span class="line">select IFNULL(&#x27;true&#x27;,&#x27;空&#x27;); # 如果arg1不是空，返回arg1，否则返回arg2</span><br><span class="line">select IFNULL(null,&#x27;空&#x27;);# 如果arg1不是空，返回arg1，否则返回arg2</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 流程控制</span><br><span class="line"></span><br><span class="line">select FLOOR(1+RAND() * (14+1)) into @device_rand;</span><br><span class="line">select @device_rand,(CASE</span><br><span class="line">                        WHEN @device_rand=1 THEN &#x27;Android 6.x&#x27;</span><br><span class="line">                        WHEN 1&lt;@device_rand &amp;&amp; @device_rand&lt;=3 THEN &#x27;iOS 9 (iPad)&#x27;</span><br><span class="line">                        WHEN 3&lt;@device_rand &amp;&amp; @device_rand&lt;=7 THEN &#x27;iOS 9 (iPhone)&#x27;</span><br><span class="line">                        WHEN 7&lt;@device_rand &amp;&amp; @device_rand&lt;=14 THEN &#x27;Android 5.x&#x27;</span><br><span class="line">                        END);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>更多：用户自定义函数， 表值函数， 标量值函数.<br>（详见文章： 关系数据库SQL之可编程性函数（用户自定义函数））</p>
</blockquote>
<p><strong>参考</strong><br><code>关系数据库SQL之可编程性函数（用户自定义函数）</code><br><a target="_blank" rel="noopener" href="http://www.cnblogs.com/seayxu/p/5472302.html">http://www.cnblogs.com/seayxu/p/5472302.html</a></p>
<p><code>MySQL常用函数与运算符</code><br><a target="_blank" rel="noopener" href="http://shanks.leanote.com/post/Mysql%E5%87%BD%E6%95%B0%E4%B8%8E%E8%BF%90%E7%AE%97%E7%AC%A6">http://shanks.leanote.com/post/Mysql%E5%87%BD%E6%95%B0%E4%B8%8E%E8%BF%90%E7%AE%97%E7%AC%A6</a></p>
<hr>
<h1 id="结构化查询语言-sql-structured-query-language"><a href="#结构化查询语言-sql-structured-query-language" class="headerlink" title="结构化查询语言-sql(structured query language)"></a>结构化查询语言-sql(structured query language)</h1><ul>
<li><p>DDL 数据定义语言<br>create:创建表, drop:删除表 , alter:修改表</p>
</li>
<li><p>DML 数据操作语言<br>insert:增 ,delete:删, update:改</p>
</li>
<li><p>DQL 数据查询语言<br>select:查</p>
</li>
<li><p>DCL 数据控制语言<br>用来设置或者更改数据库用户或角色权限的语句，包括GRANT、DENY、REVOKE等语句，在默认状态下，只有sysadmin、dbcreator、db_owner或db_securityadmin等角色的成员才有权利执行数据控制语言。</p>
</li>
<li><p>多表查询</p>
<ul>
<li><p>简单联结（inner join，left join）</p>
</li>
<li><p>组合级联（union，union all）</p>
</li>
<li><p>子查询</p>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>更多: 索引，试图，导入&#x2F;导出，备份&#x2F;恢复</p>
</blockquote>
<p><strong>参考</strong> </p>
<p><code>sql 语句学习  -持续更新中 - 简书</code><br><a target="_blank" rel="noopener" href="http://www.jianshu.com/p/d00fd0d4f1cc">http://www.jianshu.com/p/d00fd0d4f1cc</a></p>
<p><code>SQL 学习笔记 - 简书</code><br><a target="_blank" rel="noopener" href="http://www.jianshu.com/p/2dacd3040c74">http://www.jianshu.com/p/2dacd3040c74</a></p>
<p><code>（大数据工程师学习路径）第四步 SQL基础课程----修改和删除 - 推酷</code><br><a target="_blank" rel="noopener" href="http://www.tuicool.com/articles/yuUFba2">http://www.tuicool.com/articles/yuUFba2</a></p>
<p><code>（大数据工程师学习路径）第四步 SQL基础课程----select详解 - 推酷</code><br><a target="_blank" rel="noopener" href="http://www.tuicool.com/articles/za6Fz2">http://www.tuicool.com/articles/za6Fz2</a></p>
<p><code>（大数据工程师学习路径）第四步 SQL基础课程----其他（基础练习到此为止） - 爱看球的领带 - 博客园</code></p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/yangxiao99/p/4719347.html">http://www.cnblogs.com/yangxiao99/p/4719347.html</a></p>
<hr>
<h1 id="综合练习"><a href="#综合练习" class="headerlink" title="综合练习"></a>综合练习</h1><h2 id="Tips-临时表，-自动标记序号，全局变量"><a href="#Tips-临时表，-自动标记序号，全局变量" class="headerlink" title="Tips ( 临时表， 自动标记序号，全局变量 )"></a>Tips ( 临时表， 自动标记序号，全局变量 )</h2><ul>
<li><p>临时表 ( 更多请读： oracle函数 with as(临时表)用法 &amp; mysql的变通实现 .md )</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#  临时表 ( 更多请读： oracle函数 with as(临时表)用法 &amp; mysql的变通实现 .md )</span><br><span class="line">drop table if exists tab; create table tab as</span><br><span class="line">select * from(</span><br><span class="line">    select &#x27;张三&#x27; name,&#x27;男&#x27; sex,18 age,SYSDATE() time</span><br><span class="line">    union select &#x27;李四&#x27;,&#x27;女&#x27;,28,date_sub(SYSDATE(),interval 1 day)</span><br><span class="line">) tab;</span><br><span class="line"> </span><br><span class="line">select * from tab;</span><br></pre></td></tr></table></figure></li>
<li><p>自动标记序号</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 自动标记序号</span><br><span class="line">select (@rownum := @rownum+1) AS rowno,temp.* from</span><br><span class="line">(</span><br><span class="line">select * from tab,(Select (@rowNum :=0)) r</span><br><span class="line">) temp</span><br></pre></td></tr></table></figure></li>
<li><p>全局用户变量  user-variables</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 全局用户变量  user-variables</span><br><span class="line"></span><br><span class="line">SET @t1=1, @t2=2, @t3:=4;</span><br><span class="line">SELECT @t1, @t2, @t3, @t4 := @t1+@t2+@t3;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">set @temp;</span><br><span class="line">select max(age) into @temp from tab;</span><br><span class="line">select @temp;</span><br><span class="line">select * from tabA where age&gt;@temp;</span><br></pre></td></tr></table></figure>
<p><code>user-variables</code> <a target="_blank" rel="noopener" href="http://dev.mysql.com/doc/refman/5.7/en/user-variables.html">http://dev.mysql.com/doc/refman/5.7/en/user-variables.html</a></p>
</li>
<li><p>系统参数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 系统参数</span><br><span class="line">SELECT @@global.sql_mode, @@session.sql_mode, @@sql_mode;</span><br><span class="line">SHOW VARIABLES;</span><br><span class="line">select @@back_log;</span><br><span class="line">SHOW VARIABLES LIKE &#x27;back_log&#x27;;</span><br></pre></td></tr></table></figure>
<p><code>set-statement</code>  <a target="_blank" rel="noopener" href="http://dev.mysql.com/doc/refman/5.7/en/set-statement.html">http://dev.mysql.com/doc/refman/5.7/en/set-statement.html</a><br><code>system-variables(完整)</code> <a target="_blank" rel="noopener" href="http://dev.mysql.com/doc/refman/5.7/en/dynamic-system-variables.html">http://dev.mysql.com/doc/refman/5.7/en/dynamic-system-variables.html</a></p>
</li>
<li><p>客户端 编程接口</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># 客户端 编程接口</span><br><span class="line">SET @s = CONCAT(&quot;SELECT &quot;, &#x27;*&#x27;, &quot; FROM tab&quot;);</span><br><span class="line">prepare stmt FROM @s;</span><br><span class="line">execute stmt;</span><br><span class="line">drop prepare stmt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PREPARE stmt1 FROM &#x27;SELECT SQRT(POW(?,2) + POW(?,2)) AS hypotenuse&#x27;;</span><br><span class="line">SET @a = 3,@b = 4;</span><br><span class="line">EXECUTE stmt1 USING @a, @b;</span><br><span class="line"> </span><br><span class="line">SET @s = &#x27;SELECT SQRT(POW(?,2) + POW(?,2)) AS hypotenuse&#x27;;</span><br><span class="line">PREPARE stmt2 FROM @s;</span><br><span class="line">SET @a = 6,@b = 8;</span><br><span class="line">EXECUTE stmt2 USING @a, @b;</span><br></pre></td></tr></table></figure>
<p><code>prepared-statements</code>  <a target="_blank" rel="noopener" href="http://dev.mysql.com/doc/refman/5.7/en/sql-syntax-prepared-statements.html">http://dev.mysql.com/doc/refman/5.7/en/sql-syntax-prepared-statements.html</a></p>
</li>
</ul>
<hr>
<h2 id="时间条件"><a href="#时间条件" class="headerlink" title="时间条件"></a>时间条件</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists tab; create table tab as</span><br><span class="line">select * from(</span><br><span class="line">    select &#x27;张三&#x27; name,&#x27;男&#x27; sex,18 age,SYSDATE() time</span><br><span class="line">    union select &#x27;李四&#x27;,&#x27;女&#x27;,28,date_sub(SYSDATE(),interval 1 day)</span><br><span class="line">) tab;</span><br><span class="line">select * from tab;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">select * from tab where time &gt; DATE_FORMAT(&#x27;2016-11-30&#x27;,&#x27;%Y-%m-%d %H:%i:%s&#x27;);</span><br><span class="line">select * from tab where time &gt; DATE_FORMAT(str_to_date(&#x27;2016-11-30&#x27;,&#x27;%Y-%m-%d&#x27;),&#x27;%Y-%m-%d %H:%i:%s&#x27;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">select * from tab where time &gt; str_to_date(&#x27;2016-11-30&#x27;,&#x27;%Y-%m-%d&#x27;);</span><br><span class="line">select * from tab where time &gt; &#x27;2016-11-30&#x27;;</span><br></pre></td></tr></table></figure>


<h2 id="多表查询"><a href="#多表查询" class="headerlink" title="多表查询"></a>多表查询</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">drop table if exists tabA; create table tabA as</span><br><span class="line">select * from(</span><br><span class="line">    select 1 id,&#x27;刘一&#x27; name,&#x27;男&#x27; sex,18 age,SYSDATE() time</span><br><span class="line">    union select 2,&#x27;陈二&#x27;,&#x27;女&#x27;,28,date_sub(SYSDATE(),interval 1 day)</span><br><span class="line">    union select 3,&#x27;张三&#x27;,&#x27;女&#x27;,28,date_sub(SYSDATE(),interval 2 day)</span><br><span class="line">    union select 4,&#x27;李四&#x27;,&#x27;女&#x27;,29,date_sub(SYSDATE(),interval 3 day)</span><br><span class="line">    union select 5,&#x27;王五&#x27;,&#x27;女&#x27;,29,date_sub(SYSDATE(),interval 4 day)</span><br><span class="line">    union select 6,&#x27;赵六&#x27;,&#x27;女&#x27;,30,date_sub(SYSDATE(),interval 5 day)</span><br><span class="line">    union select 7,&#x27;孙七&#x27;,&#x27;女&#x27;,30,date_sub(SYSDATE(),interval 6 day)</span><br><span class="line">) tabA;</span><br><span class="line"> </span><br><span class="line">drop table if exists tabB; create table tabB as</span><br><span class="line">select * from(</span><br><span class="line">    select 6 id,&#x27;赵六&#x27; name,&#x27;男&#x27; sex,30 age,SYSDATE() time</span><br><span class="line">    union select 7,&#x27;孙七&#x27;,&#x27;女&#x27;,30,date_sub(SYSDATE(),interval 1 day)</span><br><span class="line">    union select 8,&#x27;周八&#x27;,&#x27;女&#x27;,28,date_sub(SYSDATE(),interval 2 day)</span><br><span class="line">    union select 9,&#x27;吴九&#x27;,&#x27;女&#x27;,28,date_sub(SYSDATE(),interval 3 day)</span><br><span class="line">    union select 10,&#x27;郑十&#x27;,&#x27;女&#x27;,28,date_sub(SYSDATE(),interval 4 day)</span><br><span class="line">) tabB;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">select * from tabA a,tabB b where a.id=b.id;             # 简写内联</span><br><span class="line">select * from tabA a inner join tabB b on a.id=b.id;    # 内联</span><br><span class="line">select * from tabA a left join tabB b on a.id=b.id;       # 左外</span><br><span class="line">select * from tabA a right join tabB b on a.id=b.id;     # 右外</span><br></pre></td></tr></table></figure>


<h2 id="分组-聚合"><a href="#分组-聚合" class="headerlink" title="分组 &amp; 聚合"></a>分组 &amp; 聚合</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 分组 group by *</span><br><span class="line">select age,count(*) from tabA group by age;# 除分组列可直接展示外,其它字段都只能在函数计算成单值才能显示(count,max,sum)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 聚合函数 group_concat</span><br><span class="line">select age,count(*),group_concat(name) from tabA group by age;# 合并数值(聚合)</span><br><span class="line">select age,count(*),group_concat(name separator &#x27;;&#x27;) from tabA group by age;# 改变分隔符</span><br><span class="line">select age,count(*),group_concat(name order by time) from tabA group by age;# 时间升序</span><br><span class="line">select age,count(*),group_concat(name order by time desc) from tabA group by age;# 时间降序</span><br></pre></td></tr></table></figure>


<h2 id="distinct去重"><a href="#distinct去重" class="headerlink" title="distinct去重"></a>distinct去重</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">select * from tabA;</span><br><span class="line">select count(*) from tabA;</span><br><span class="line">select count(distinct name) from tabA;</span><br><span class="line">select count(distinct age) from tabA;</span><br></pre></td></tr></table></figure>
<h2 id="查询重复-删除重复"><a href="#查询重复-删除重复" class="headerlink" title="查询重复 &amp; 删除重复"></a>查询重复 &amp; 删除重复</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 查找(仅显示重复)</span><br><span class="line">select age,count(age),group_concat(name) from tabA group by age having count(age) &gt; 1;</span><br><span class="line">select * from tabA where age in (select age from tabA group by age having count(age) &gt; 1);</span><br><span class="line"> </span><br><span class="line"># 去重(mysql缺省-非分组字段显示组内第一条)</span><br><span class="line">select * from tabA group by age</span><br><span class="line"> </span><br><span class="line"># 去重-重复项中显示最早一条数据[min(Id)]或最近一条数据[max(id)]</span><br><span class="line">select * from tabA a where a.id = (select min(id) from tabA b where a.age=b.age); # 最早一条数据[min(Id)]</span><br><span class="line">select * from tabA a where a.id = (select max(id) from tabA b where a.age=b.age); # 最近一条数据[max(id)]</span><br><span class="line"> </span><br><span class="line"># 删除重复</span><br><span class="line">select * from tabA a where a.id &gt; (select min(id) from tabA b where a.age=b.age);</span><br><span class="line">delete from tabA a where a.id &gt; (select min(id) from tabA b where a.age=b.age);# oralce正常,mysql语法错误</span><br><span class="line">delete from tabA where id in</span><br><span class="line">    (select id from (select * from tabA) a where a.id &gt; (select min(id) from (select * from tabA) b where a.age=b.age));# 改成这样(/恶心)</span><br><span class="line"> </span><br><span class="line">## 检查</span><br><span class="line">select * from tabA;</span><br></pre></td></tr></table></figure>


<h1 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 删除已存在 视图  &amp; 创建新视图</span><br><span class="line">Drop view if exists v_tabAB; create view v_tabAB as</span><br><span class="line">select a.* from tabA a,tabB b where a.name=b.name;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">select * from v_tabAB;</span><br></pre></td></tr></table></figure>


<h1 id="存储过程"><a href="#存储过程" class="headerlink" title="存储过程"></a>存储过程</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">drop PROCEDURE IF EXISTS  simpleproc ;</span><br><span class="line">delimiter //</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CREATE PROCEDURE simpleproc (OUT o_param1 INT)</span><br><span class="line">BEGIN</span><br><span class="line">SELECT COUNT(*) into o_param1 FROM tab;</span><br><span class="line">END//</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">delimiter ;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CALL simpleproc(@a);</span><br><span class="line">select @a;</span><br></pre></td></tr></table></figure>
<p><code>create-procedure</code> <a target="_blank" rel="noopener" href="http://dev.mysql.com/doc/refman/5.7/en/create-procedure.html">http://dev.mysql.com/doc/refman/5.7/en/create-procedure.html</a></p>
<ul>
<li><p>扩展阅读 <code>MySql delimiter的作用是什么</code>  <a target="_blank" rel="noopener" href="http://www.jb51.net/article/24815.htm">http://www.jb51.net/article/24815.htm</a></p>
</li>
<li><p>带参存储过程，几种执行方式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">CREATE PROCEDURE p (OUT o_ver_param VARCHAR(25), INOUT incr_param INT)</span><br><span class="line">BEGIN</span><br><span class="line">  SELECT VERSION() INTO o_ver_param;</span><br><span class="line">  SET incr_param = incr_param + 1;</span><br><span class="line">END;</span><br><span class="line"> </span><br><span class="line"># 参数引用传递</span><br><span class="line">SET @increment = 10;</span><br><span class="line">CALL p(@version, @increment);</span><br><span class="line">SELECT @version, @increment;</span><br><span class="line"> </span><br><span class="line"># 带参使用（prepare 编程接口）</span><br><span class="line">SET @increment = 10;</span><br><span class="line">PREPARE s FROM &#x27;CALL p(?, ?)&#x27;;</span><br><span class="line">EXECUTE s USING @version, @increment;</span><br><span class="line">SELECT @version, @increment;</span><br><span class="line"> </span><br><span class="line">SET @increment = 10;</span><br><span class="line">PREPARE s FROM &#x27;CALL p(@version, @increment)&#x27;;</span><br><span class="line">EXECUTE s;</span><br><span class="line">SELECT @version, @increment;</span><br></pre></td></tr></table></figure>
<p><code>call</code>  <a target="_blank" rel="noopener" href="http://dev.mysql.com/doc/refman/5.7/en/call.html">http://dev.mysql.com/doc/refman/5.7/en/call.html</a></p>
</li>
<li><p>游标 Cursors</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">CREATE PROCEDURE curdemo()</span><br><span class="line">BEGIN</span><br><span class="line">  DECLARE done INT DEFAULT FALSE;</span><br><span class="line">  DECLARE a CHAR(16);</span><br><span class="line">  DECLARE b, c INT;</span><br><span class="line">  DECLARE cur1 CURSOR FOR SELECT id,data FROM test.t1;</span><br><span class="line">  DECLARE cur2 CURSOR FOR SELECT i FROM test.t2;</span><br><span class="line">  DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;</span><br><span class="line"> </span><br><span class="line">  OPEN cur1;</span><br><span class="line">  OPEN cur2;</span><br><span class="line"> </span><br><span class="line">  read_loop: LOOP</span><br><span class="line">    FETCH cur1 INTO a, b;</span><br><span class="line">    FETCH cur2 INTO c;</span><br><span class="line">    IF done THEN</span><br><span class="line">      LEAVE read_loop;</span><br><span class="line">    END IF;</span><br><span class="line">    IF b &lt; c THEN</span><br><span class="line">      INSERT INTO test.t3 VALUES (a,b);</span><br><span class="line">    ELSE</span><br><span class="line">      INSERT INTO test.t3 VALUES (a,c);</span><br><span class="line">    END IF;</span><br><span class="line">  END LOOP;</span><br><span class="line"> </span><br><span class="line">  CLOSE cur1;</span><br><span class="line">  CLOSE cur2;</span><br><span class="line">END;</span><br></pre></td></tr></table></figure>
<p><code>Cursors</code> <a target="_blank" rel="noopener" href="http://dev.mysql.com/doc/refman/5.7/en/cursors.html">http://dev.mysql.com/doc/refman/5.7/en/cursors.html</a></p>
</li>
<li><p>扩展阅读 <code>mysql循环方式</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">三个标准的循环方式：WHILE循环，LOOP循环以及REPEAT循环。</span><br><span class="line">一 个 非标准的循环方式：GOTO</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">WHILE……DO……END WHILE</span><br><span class="line">REPEAT……UNTIL END REPEAT</span><br><span class="line">LOOP……END LOOP</span><br><span class="line">GOTO</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="http://www.soso.io/article/13660.html">http://www.soso.io/article/13660.html</a><br><a target="_blank" rel="noopener" href="http://www.blogjava.net/rain1102/archive/2011/05/16/350301.html">http://www.blogjava.net/rain1102/archive/2011/05/16/350301.html</a></p>
</li>
</ul>
<h1 id="tips-存储过程中纪录日志方法"><a href="#tips-存储过程中纪录日志方法" class="headerlink" title="tips: 存储过程中纪录日志方法"></a>tips: 存储过程中纪录日志方法</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># 初始化</span><br><span class="line">drop table if exists p_log;</span><br><span class="line">create table p_log as select 1 &#x27;id&#x27;,&#x27;p_name&#x27;,&#x27;log&#x27; ,SYSDATE() date;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">select * from p_log; # 存储过程,进度监控</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 标记主键,更新长度</span><br><span class="line">ALTER TABLE `p_log`</span><br><span class="line">MODIFY COLUMN `id`  int(1) NOT NULL AUTO_INCREMENT FIRST ,</span><br><span class="line">MODIFY COLUMN `p_name`  varchar(64) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NOT NULL DEFAULT &#x27;&#x27; AFTER `id`,</span><br><span class="line">MODIFY COLUMN `log`  varchar(1024) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NOT NULL DEFAULT &#x27;&#x27; AFTER `p_name`,</span><br><span class="line">ADD PRIMARY KEY (`id`);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 插入测试</span><br><span class="line">insert into p_log value(null,&#x27;p_name&#x27;,&#x27;log&#x27;,SYSDATE());</span><br><span class="line">select * from p_log; ```</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 流程控制</span><br></pre></td></tr></table></figure>
<p>14.6.5.1 CASE Syntax # 分支（同switch case）<br>14.6.5.2 IF Syntax<br>14.6.5.3 ITERATE Syntax    # 重新开始循环（同continue）<br>14.6.5.4 LEAVE Syntax  #  LEAVE    结束标签（同break）<br>14.6.5.5 LOOP Syntax # 循环（同for）<br>14.6.5.6 REPEAT Syntax    # 循环<br>14.6.5.7 RETURN Syntax<br>14.6.5.8 WHILE Syntax     # 循环</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">```</span><br><span class="line">CREATE PROCEDURE doiterate(p1 INT)</span><br><span class="line">BEGIN</span><br><span class="line">  label1: LOOP</span><br><span class="line">    SET p1 = p1 + 1;</span><br><span class="line">    IF p1 &lt; 10 THEN</span><br><span class="line">      ITERATE label1; # 重新开始循环（同continue）</span><br><span class="line">    END IF;</span><br><span class="line">    LEAVE label1; #  LEAVE    结束标签（同break）</span><br><span class="line">  END LOOP label1;</span><br><span class="line">  SET @x = p1;</span><br><span class="line">END;</span><br></pre></td></tr></table></figure>
<p><code>MySQL :: MySQL 5.7 Reference Manual :: 14.6.5 Flow Control Statements</code><br><a target="_blank" rel="noopener" href="http://dev.mysql.com/doc/refman/5.7/en/flow-control-statements.html">http://dev.mysql.com/doc/refman/5.7/en/flow-control-statements.html</a></p>
<p><code>MySQL :: MySQL 5.7 Reference Manual :: 14.6.5.5 LOOP Syntax</code><br><a target="_blank" rel="noopener" href="http://dev.mysql.com/doc/refman/5.7/en/loop.html">http://dev.mysql.com/doc/refman/5.7/en/loop.html</a></p>
<h1 id="计划任务"><a href="#计划任务" class="headerlink" title="计划任务"></a>计划任务</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">drop EVENT IF EXISTS e_test;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CREATE EVENT `e_test`</span><br><span class="line">    ON SCHEDULE EVERY 5 SECOND</span><br><span class="line">    ON COMPLETION NOT PRESERVE</span><br><span class="line">    ENABLE</span><br><span class="line">    DO</span><br><span class="line">    insert into p_log value(&#x27;event&#x27;,&#x27;x&#x27;,SYSDATE());</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#1) 临时关闭事件</span><br><span class="line">ALTER EVENT e_test DISABLE;</span><br><span class="line"> </span><br><span class="line"># 2) 开启事件</span><br><span class="line">ALTER EVENT e_test ENABLE;</span><br></pre></td></tr></table></figure>
<p><code>MySQL :: MySQL 5.7 Reference Manual :: 14.1.12 CREATE EVENT Syntax</code><br><a target="_blank" rel="noopener" href="http://dev.mysql.com/doc/refman/5.7/en/create-event.html">http://dev.mysql.com/doc/refman/5.7/en/create-event.html</a></p>
<p><code>详解 MySQL 的计划任务 - 开源中国社区</code><br><a target="_blank" rel="noopener" href="http://www.oschina.net/question/4873_20927">http://www.oschina.net/question/4873_20927</a></p>
<h1 id="数据字典"><a href="#数据字典" class="headerlink" title="数据字典"></a>数据字典</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 其中常用字典库 [information_schema]</span><br><span class="line">select * from INFORMATION_SCHEMA.SCHEMATA;  # 数据库中所有数据库信息</span><br><span class="line">select * from INFORMATION_SCHEMA.TABLES; # 存放数据库中所有数据库表信息</span><br><span class="line">select * from INFORMATION_SCHEMA.COLUMNS;  # 所有数据库表的列信息</span><br><span class="line">select * from INFORMATION_SCHEMA.STATISTICS;# 存放索引信息</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 获取表信息</span><br><span class="line">select TABLE_SCHEMA DB,TABLE_NAME 表名,TABLE_COMMENT 描述,TABLE_ROWS 数据条数,concat(round(data_length/(1024*1024),2),&#x27;M&#x27;) 容量</span><br><span class="line">from INFORMATION_SCHEMA.TABLES where TABLE_SCHEMA=&#x27;k12_platform&#x27; ;</span><br><span class="line"> </span><br><span class="line"># 获取表中字段信息</span><br><span class="line">select TABLE_SCHEMA DB,COLUMN_NAME 列名,TABLE_NAME 表名,COLUMN_COMMENT 备注,COLUMN_TYPE 类型,is_nullable 可否为空,CHARACTER_MAXIMUM_LENGTH 最大值长度</span><br><span class="line">from INFORMATION_SCHEMA.COLUMNS</span><br><span class="line">where 1=1</span><br><span class="line">and TABLE_SCHEMA=&#x27;k12_platform&#x27;</span><br><span class="line">and TABLE_NAME =&#x27;user&#x27;                 # 表名(查看表中所有字段信息)</span><br><span class="line">and COLUMN_COMMENT like &#x27;%昵称%&#x27; # 描述列(依据描述,找具体字段及所在表)</span><br><span class="line">and COLUMN_NAME like &#x27;nick_name&#x27;; # 描述列(依据字段,查找周边关系表)</span><br></pre></td></tr></table></figure>


<hr>
<h1 id="进阶"><a href="#进阶" class="headerlink" title="进阶"></a>进阶</h1><ul>
<li><p>工具掌握(PL&#x2F;sql，Navicat..)</p>
</li>
<li><p>数据字典</p>
</li>
<li><p>存储过程(逻辑语句， 事务控制 )</p>
</li>
<li><p>执行计划</p>
</li>
<li><p>性能调优（索引，分区，分表）</p>
</li>
<li><p>数据库设计</p>
</li>
<li><p>场景问题解决方案（去重，分组，聚合..）</p>
</li>
<li><p>数据库管理(锁表&#x2F;释放 )</p>
</li>
<li><p>数据库安全</p>
</li>
<li><p>数据库规范&amp;案例</p>
</li>
<li><p>nosql延伸</p>
</li>
</ul>
<hr>
<p><strong>参考</strong><br><code>MySQL 5.7参考手册(MySQL 5.7 Reference Manual)</code></p>
<p><a target="_blank" rel="noopener" href="http://dev.mysql.com/doc/refman/5.7/en/create-table.html">http://dev.mysql.com/doc/refman/5.7/en/create-table.html</a><br><img src="http://7xnbs3.com1.z0.glb.clouddn.com/16-6-16/90252887.jpg"></p>
<p>第三方分类  <a target="_blank" rel="noopener" href="http://overapi.com/mysql">http://overapi.com/mysql</a><br><img src="http://7xnbs3.com1.z0.glb.clouddn.com/16-7-1/10071748.jpg"></p>
<p>** Oracle    Database SQL Reference 数据库 SQL参考（完全 参考手册 ）**<br><code>oracle Database - Functions 函数</code><br><a target="_blank" rel="noopener" href="http://docs.oracle.com/cd/E11882_01/timesten.112/e21642/function.htm#TTSQL446">http://docs.oracle.com/cd/E11882_01/timesten.112/e21642/function.htm#TTSQL446</a></p>
<p><code>oracle Database - SQL Statements SQL语句</code><br><a target="_blank" rel="noopener" href="http://docs.oracle.com/cd/E11882_01/timesten.112/e21642/state.htm#TTSQL277">http://docs.oracle.com/cd/E11882_01/timesten.112/e21642/state.htm#TTSQL277</a><br><img src="http://7xnbs3.com1.z0.glb.clouddn.com/16-6-16/1486632.jpg"></p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/sql%E7%BC%96%E7%A8%8B%E5%AD%A6%E4%B9%A0/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.sovdating.com/nginx%20%E5%9F%9F%E5%90%8D%E9%85%8D%E7%BD%AE%E7%AD%96%E7%95%A5%E8%AE%A8%E8%AE%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="DJY">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sovdating Linux">
      <meta itemprop="description" content="Hello dev">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Sovdating Linux">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/nginx%20%E5%9F%9F%E5%90%8D%E9%85%8D%E7%BD%AE%E7%AD%96%E7%95%A5%E8%AE%A8%E8%AE%BA/" class="post-title-link" itemprop="url">nginx 域名配置策略讨论</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2016-06-15 00:00:00" itemprop="dateCreated datePublished" datetime="2016-06-15T00:00:00+00:00">2016-06-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-01-26 12:42:24" itemprop="dateModified" datetime="2024-01-26T12:42:24+00:00">2024-01-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/nginx/" itemprop="url" rel="index"><span itemprop="name">nginx</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="方式一"><a href="#方式一" class="headerlink" title="方式一"></a>方式一</h1><ul>
<li>根域名（ wosaitech.com ）转发到<code>html/wosai</code>,预留其它同级目录如“womao，weixin…”</li>
<li>子集服务（ wosaitech.com&#x2F;zhaoping ）转发到’html&#x2F;zhaoping’<ul>
<li><p>好处：wosai属于域名官网项目，zhaoping属于独立项目，分开部署清晰</p>
</li>
<li><p>好处：ip访问与域名访问，后缀一致，在维护中方便更替。支持变化域名后，ip同时保持服务。</p>
</li>
<li><p>坏处：每增加子集服务（html&#x2F;*）都必须增加配置，否则会被基础转发引导到<code>html/wosai/*</code>中寻找，找不到就出错</p>
</li>
</ul>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">   server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  wosaitech.com www.wosaitech.com;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        #charset koi8-r;</span><br><span class="line">        #access_log  logs/host.access.log  main;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        # 所有(&#x27;/&#x27;开头)访问</span><br><span class="line">        location / &#123;</span><br><span class="line">            root   html/wosai;</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        # 由于域名访问将根“/”目录转发到了其它位置(html/wosai).</span><br><span class="line">        # 导致所有域名下的服务都需要放置域名转发目录(html/wosai)下,否则无法访问</span><br><span class="line">        # 规避办法：未具体服务(*)进行再次转发(html/*)</span><br><span class="line">location /education&#123;</span><br><span class="line">proxy_pass http://127.0.0.1/education;</span><br><span class="line">&#125;</span><br><span class="line">location /wosaiIntro&#123;</span><br><span class="line">proxy_pass http://127.0.0.1/wosaiIntro;</span><br><span class="line">&#125;</span><br><span class="line">location /zhaoping&#123;</span><br><span class="line">proxy_pass http://127.0.0.1/zhaoping;</span><br><span class="line">&#125;</span><br><span class="line">location /apk&#123;</span><br><span class="line">proxy_pass http://127.0.0.1/apk;</span><br><span class="line">&#125;</span><br><span class="line">location /teach&#123;</span><br><span class="line">proxy_pass http://127.0.0.1/teach;</span><br><span class="line">&#125;</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>


<h1 id="方式二-讨论结论采用此方式"><a href="#方式二-讨论结论采用此方式" class="headerlink" title="方式二(讨论结论采用此方式)"></a>方式二(<code>讨论结论采用此方式</code>)</h1><ul>
<li>基于<code>方式一</code>思考，将 子集服务（ wosaitech.com&#x2F;zhaoping ），正常部署到<code>html/wosai/zhaoping</code>中<ul>
<li><p>好处： 每增加子集服务（html&#x2F;wosai&#x2F;*）都不需要增加配置维护。减少风险</p>
</li>
<li><p>坏处：与子集目录同级的<code>wosai</code>官网项目的文件目录，会形成干扰。混淆视听</p>
</li>
<li><p>坏处：遇到<code>wosai</code>官网项目的升级，要注意隐性的子集目录，及时还原。慎重清理</p>
</li>
</ul>
</li>
</ul>
<!--
     - 坏处(此条目忽略)：代码中配置的访问路径`wosaitech.com/zhaoping`需要修改为`wosaitech.com/wosai/zhaoping`

-->



<ul>
<li>增加二级域名(weixin.wosaitech.com)的独立转发配置（ html&#x2F;teach&#x2F; ）<ul>
<li>好处：足够独立的子集服务(weixin.wosaitech.com)，放在<code>html/wosai/teach</code>是不太合适的。方便管理<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">     listen       80;</span><br><span class="line">     server_name  wosaitech.com www.wosaitech.com;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">     #charset koi8-r;</span><br><span class="line">     #access_log  logs/host.access.log  main;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">     # 所有(&#x27;/&#x27;开头)访问</span><br><span class="line">     location / &#123;</span><br><span class="line">         root   html/wosai;</span><br><span class="line">         index  index.html index.htm;</span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br><span class="line">server &#123;</span><br><span class="line">     listen       80;</span><br><span class="line">     server_name  weixin.wosaitech.com;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">     #charset koi8-r;</span><br><span class="line">     #access_log  logs/host.access.log  main;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">     # 所有(&#x27;/&#x27;开头)访问</span><br><span class="line">     location / &#123;</span><br><span class="line">         root   html/teach/;</span><br><span class="line">         index  index.html index.htm;</span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h1 id="方式三"><a href="#方式三" class="headerlink" title="方式三"></a>方式三</h1><ul>
<li>基于<code>方式一</code>的坏处思考，将 子集服务（ wosaitech.com&#x2F;zhaoping ），也独立<code>公共</code>二级域名，可以避免<ul>
<li>好处：” 与子集目录同级的<code>wosai</code>官网项目的文件目录形成干扰 “ 不会存在，因为抽离出来了(html&#x2F;public&#x2F;zhaoping)</li>
<li>坏处：不能使用<code>wosaitech.com/zhaoping</code>，而要用<code>public. wosaitech.com/zhaoping </code></li>
<li>坏处：在 <code> wosaitech.com</code>与 <code>public. wosaitech.com/zhaoping </code>间交互时可能出现问题<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">     listen       80;</span><br><span class="line">     server_name  wosaitech.com www.wosaitech.com;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">     #charset koi8-r;</span><br><span class="line">     #access_log  logs/host.access.log  main;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">     # 所有(&#x27;/&#x27;开头)访问</span><br><span class="line">     location / &#123;</span><br><span class="line">         root   html/wosai;</span><br><span class="line">         index  index.html index.htm;</span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br><span class="line">server &#123;</span><br><span class="line">     listen       80;</span><br><span class="line">     server_name  public.wosaitech.com;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">     #charset koi8-r;</span><br><span class="line">     #access_log  logs/host.access.log  main;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">     # 所有(&#x27;/&#x27;开头)访问</span><br><span class="line">     location / &#123;</span><br><span class="line">         root   html/ public /;</span><br><span class="line">         index  index.html index.htm;</span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br><span class="line">server &#123;</span><br><span class="line">     listen       80;</span><br><span class="line">     server_name  weixin.wosaitech.com;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">     #charset koi8-r;</span><br><span class="line">     #access_log  logs/host.access.log  main;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">     # 所有(&#x27;/&#x27;开头)访问</span><br><span class="line">     location / &#123;</span><br><span class="line">         root   html/teach/;</span><br><span class="line">         index  index.html index.htm;</span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/nginx%20%E5%9F%9F%E5%90%8D%E9%85%8D%E7%BD%AE%E7%AD%96%E7%95%A5%E8%AE%A8%E8%AE%BA/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.sovdating.com/Read-treat-time-as-a-friend/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="DJY">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sovdating Linux">
      <meta itemprop="description" content="Hello dev">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Sovdating Linux">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Read-treat-time-as-a-friend/" class="post-title-link" itemprop="url">读《把时间当作朋友》</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2016-06-10 15:22:38" itemprop="dateCreated datePublished" datetime="2016-06-10T15:22:38+00:00">2016-06-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-01-26 12:42:25" itemprop="dateModified" datetime="2024-01-26T12:42:25+00:00">2024-01-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Life-Talk/" itemprop="url" rel="index"><span itemprop="name">Life-Talk</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote  class="blockquote-center">
**人生就是两件事：一是该做的；二是想做的。摆对顺序成就一生，摆错顺序一事无成。**
</blockquote>

<p><strong>作者简介</strong>：李笑来，原新东方老师，现艾德睿智国际教育咨询合伙人。他，经历丰富，与众小有不同。东北人，就读普通高校，本科学财会，毕业干销售，惯于洞察他人心理，一不留神，成了新东方教写作的名师，授业解惑，乐此不疲。</p>
<p>《把时间当作朋友》主要讲述的是关于开启心智方面的，可以这么说，李笑来用最浅显直白的语言表述了我们日常生活中经常发生的场景，其思想虽谈不上深邃，但总能比常人多看一层，而这一层就足以和常人拉开差距。阅读本书也让我认识到我以前心中一些不甚明了的困惑，李笑来旁征博引，用简短明了的示例或名言，直指我们日常生活中习以为常以至于司空见惯的坏习惯。然诸多当事人却沉浸其中，而无法自知。</p>
<p>很多学生都是“既勤奋又懒惰”的类型，我觉得对于绝大多数资质平平而又努力向上的人来说，都或多或少的会沾染些许“既勤奋又懒惰”的坏习惯。然而，不要忘记生活中明显有另外一些人——尽管数量上并不占优——在用另外一种状态生活。他们从容，他们优雅，他们善于化解各种压力，安静地去做他们认为应该做的事情，并总能有所成就。这些人中不乏天资聪颖，亦不乏后天环境优越或是父辈竭尽全力而为其创造各种优越条件。那么先不谈如何赶上甚至超越这部分人，就谈与他们并驾齐驱好了，你可能首先想到的方法就是“管理时间”抑或“时间管理”。然而时间不会服从于任何人的管理，它只会自顾自地流逝。时间不理任何人，它用自己特有的速度流逝，不受任何外界因素影响。所以李笑来老师给出的观点是：<strong>我们无法管理时间，我们真正能够管理的，是我们自己。</strong></p>
<p>在阅读本书过程中，仅摘录部分要点如下，如果你想要获得更全面的知识，请自行阅读全书。</p>
<ul>
<li>人们很难接受与已有知识和经验相左的信息或观念</li>
<li>被灌输的观念，越是错误的，越有惊人的繁殖力</li>
<li>人类能将自己的思考作为思考对象的能力被称作“元认知能力”</li>
<li>你的大脑并不是你，你的大脑是属于“你的”大脑，尽管你用它思考，好像它也在指导你的行为，但是你要明白，你不应该隶属于你的大脑，而应该是它隶属于你</li>
<li>人所拥有的任何东西，都可以被剥夺，唯独人性最后的自由——也就是在任何境遇中选择一己态度和生活方式的自由——不能被剥夺</li>
<li>心智与智商不同，大多数人都拥有正常的智商，但并非每个拥有正常智商的人都拥有正常的心智，许多人的心智仍处于未开启的状态</li>
<li>骗子想要成功行骗，必须把想让别人相信的谎言掺到大量的真理之中</li>
<li>有些认识，哪怕是简单的常识，也需要亲身经历后才能真正体会</li>
<li>我们总在不由自主地想，如果有速成的办法就好了——可惜，没有，确实没有</li>
<li>英文代码中的“foo”、“bar”类似于中文里的“张三”、“李四”，是一个无特别含义的名字。（我表示刚知道）</li>
<li>为了进步，我们必须忍受一定的未知，不要陷入“牛角尖陷阱”，例如循环代码块里的起始变量名称为什么是“i”，为什么第二次循环的起始变量名称通常是“j”，为什么“John”这个英文会被翻译成“约翰”？</li>
<li>尽管天分很重要，但一个人的能力主要靠积累获得</li>
<li>越是不满现状，摆脱现状的欲望就越强烈，而这种欲望会让一个人最终迷失方向，因为无论是谁，从本质上看都无法摆脱现状——每一时刻的现状都是过去某一或者某些时刻的结果，而每一时刻的现状都是未来某一或者某些时刻的原因。没有人能够逃脱现实的束缚</li>
<li>从某种意义上理解，“逆境造就成功、磨难令人成熟”之类的话纯属胡说八道。显然，在顺境中更容易成功，而且很多磨难根本没有必要——这更可能是失败者对他们自己一生都未曾有机会体验的成功以及成功者“意淫”式的猜想而已</li>
<li>失败者永远没有机会了解成功的真相，因为人最容易受自身经验的限制，而不曾有哪怕一点点成功经验的人更无从摆脱自身的局限</li>
<li>对现状不满、急于摆脱现状，是人们常常不知不觉落入的陷阱（尽管偶尔这也是少数人真正的动力）。接受现状才是最优策略——有什么做什么，有什么用什么；做什么都做好，用什么都用好</li>
<li>资源原本是有限的，经济学里将这种现象描述为“资源稀缺”。在整体上资源稀缺的前提下，“资源并非均匀分布”体现在每个人身上，直接的结果就是“绝大多数人都觉得自己拥有的不够多”。在我们生存的这个世界里，资源稀缺是客观现实，也恰因如此，人们的主观愿望肯定不可能全部被满足</li>
<li>墨菲定律：Murphy’s law，一个经验定律，其一般表述为“凡事只要可能出错，就会出错”</li>
<li>对一个5岁的孩子来讲，未来的1年相当于他已经度过的人生的¹⁄₅，即20%；而对一个50 岁的成年人来讲，未来的1年只相当于他已经度过的人生的¹⁄₅₀，即2%。所以，随着年龄的增加，人们会觉得时间运动得越来越快</li>
<li>每个人都有必要阅读项目管理方面的经典书籍。也许你并没有“项目经理”之类的头衔，但，实际上，每个人都应该是自己的项目经理—自主、独立，是心智成熟的人必有的素质</li>
<li>无论学到了什么东西，都可以接着问自己：“那……这个道理还可以运用在什么地方？”反复问自己这种简单问题，能够锻炼自己融会贯通、举一反三的能力</li>
<li>尽管总是有人劝诫“速成没戏”，但还是有人宣扬各种速成的方法，并且信者大有人在，宛若“野火烧不尽，春风吹又生”。为什么呢？上过中学的人都应该明白“省功不省力、省力不省功”的物理原理啊！其实，这些人缺乏的就是这种思考能力或者说思考习惯</li>
<li>我从来都不相信“人人都能成功”之类的话，我顶多相信“其实人人原本都有可能成功”。我觉得，一个人最终成功的关键，并不是因为他曾经精确地计划过自己的成功，而是坚持</li>
<li>从更高的层面上说，设计验收机制也是任何一个领导者必须拥有的基本能力。哪怕你领导的只是一个很小的团队，你也都必然要向团队成员指派各种各样的任务。在这种情况下，如果你没有设计验收机制，最终的结果肯定会让你非常失望，因为缺少验收机制会使团队成员对自己的工作质量毫不介意，长此以往，团队的执行力将等于零，作为团队领导者的你也必须承担失败的责任</li>
<li>不仅存在无法通过个体或者群体经验获得的知识，还存在与现有经验相悖的知识</li>
<li>我常常暗骂现在的大学本科教育。不夸张地讲，今天的本科教育很大程度上已经忘了“本”。本科教育之“本”在于培养学生的自学能力。从理论上讲，一个人本科毕业之后，应该有能力自学他所需要的任何知识</li>
<li>“自证预言”-罗伯特·莫顿教授发现了这种现象，并将其命名为“自证预言”，即如果人们相信某件事情会发生（事实上其原本并不见得一定会发生），那么这件事情最终真的会发生</li>
<li>“自利性偏差”-人类普遍拥有的一个认知偏差就是：把成功揽到自己身上，把失败归咎于别人或者坏运气</li>
<li>成功背后的东西很难看清楚，所谓成功的真实性也很难判断，而成功者们又会有意无意地美化和包装他们的经验，而这一切，都在干扰我们的判断。不过，观察失败者却相对容易得多，因为失败者的失败往往是显然的、确定的，失败的真正原因也往往很容易查实</li>
<li>有些时候，我们的思维会因我们所使用的语言（表达手段之一）而受到各种各样的影响。恰当而又正确地使用语言，可以帮助修复思维漏洞。一旦明白个中道理，我们就会发现，语言就是一个便宜（甚至免费）而又有效的辅助工具</li>
<li>以下一些句式最好经常使用，因为它们特别有助于独立思考习惯的养成，并且也有刺激思考的作用：<br>▷ ……是一回事，而……是另外一回事。<br>▷ ……和……其实根本不是一回事。<br>▷ ……不一定……<br>▷ ……。可是，这并不意味着……<br>▷ ……也许还有另外一种可能性（解释）。<br>▷ ……看起来像……，可是……<br>▷ ……。而事实却可能远比看起来的更为复杂（简单）。<br>▷ ……。然而，（这个论断）反过来（陈述）却不一定成立……<br>▷ ……其实很可能与……根本就没有任何关系。<br>▷ ……和……之间不一定是单纯的因果关系，它们也可能互为因果。<br>▷ ……和……之间的比较也许没有任何意义。<br>▷ ……其实不过是表面现象，其背后的本质是……<br>▷ ……有一个通常被忽略的前提。<br>▷ ……尽管听起来很有道理，然而却完全不现实。<br>▷ ……也许有人会说……，但是这种质疑却……<br>这些句式看起来简单，却往往能带来不同凡响的思考结果。平时遇到任何问题的时候，都不妨把这些句式套进去填空—就当想着玩了—要不了多久你就能体会这种游戏的有趣之处。不出意外的话，我们会发现自己的思维因为这些句式的运用而不由自主地发生了巨大转变。例如，“……和……其实根本不是一回事”这个句式往往瞬间就能使一个人的脑子更加清楚</li>
<li>大多数人会对自己的记忆力过分高估。这个幻觉来自每时每刻都有一些确实可以记得住的东西，而记不住的东西恰恰则因为没有被记住所以看上去“并不存在”。换言之，每时每刻都有“我记得住”的证据，而“我记不住”的证据基本上难觅其踪。这也就是为什么总有那么多人真诚地相信自己考试成绩差是因为“没发挥好”</li>
<li>我个人认为，在分享知识的时候，“知无不言，言无不尽”是正确的；而在日常交流中，这个原则的适用性非常差</li>
<li>在讨论问题的时候，我们常常会被对方的“固执己见”挫败，但在对方眼里，我们可能也是“固执己见”的，只不过是程度不同而已</li>
<li>我经常鼓励学生只要有时间就去看杂书—越杂越好，多多益善。为什么呢？因为读杂书会大大提高一个人接受新事物的能力（这种能力也是理解能力的一种）。阅历丰富、博览群书的人，肯定拥有更强的理解能力，因为他们在遇到未知的时候，更有可能迅速地在自己已有的知识中找到可以用来类比的信息</li>
<li>方法固然重要，但是比起“用功”来说，方法几乎可以忽略不计。由此可见，所有学习上的成功，都只依靠两件事—策略和坚持，而坚持本身就是最重要的策略。坚持，其实就是重复；而重复，说到底就是时间的投入，准确地说，是大量时间的投入</li>
<li>浪费时间、虚度年华的人，有一个共同的特征—拼命想控制自己完全不能控制的事物，却在自己真正能掌控的地方彻底失控</li>
<li>当一个人没有准备好的时候，对他来讲，不存在任何机会。机会时时刻刻都会出现在我们身边，关键在于，我们有没有足够努力，做到“万事俱备，只欠东风”。而当一个人准备好了的时候，随处都是机会，而且所有的机会都是切实的、可以把握的</li>
<li>从整体上看，人脉当然很重要。不过，针对某个个体来说，比人脉更重要的是他所拥有的资源。有些资源很难靠白手起家获得，比如金钱、地位、名誉。然而，有些资源却可以轻易从零开始积累，比如一个人的才华与学识。才华与学识，是一定可以通过努力获得的</li>
<li>如果一个人的身边都是优秀的人，就往往会出现没有人求他帮忙的景况，因为优秀的人几乎无一例外都以耽误别人的时间为耻，同时，这些人恰恰因为能够独立解决遇到的问题才被其他认为是优秀者</li>
<li>专心做可以提升自己的事情，学习并拥有更多、更好的技能，成为一个值得他人交往的人</li>
<li>学会独善其身，以不给他人制造麻烦为美德，用自己的独立赢得尊重</li>
<li>鸡尾酒会效应：cocktail party effect。指人的一种听力选择能力，在这种情况下，注意力集中在某一个人的谈话之中而忽略背景中其他的对话或噪音</li>
<li>当我们不停地鼓励所有人的时候，最大的受益者其实是我们自己，因为最终我们会发现，自己开始进入一种他人无法想象的状态，成为一个不需要他人鼓励的人。这一点很重要。因为很多人之所以做事裹足不前，浪费时间甚至生命，原因就在于他们是必须获得别人的鼓励才敢于行动的人。可是，我们却能成为另外一种人—我们可以不需要被别人鼓励—这是一种境界</li>
<li>对一个人来说，家庭是最重要的。因为最终有一天我们会发现，在很极端的情况下，依然支持我们的肯定是也通常只是我们的家庭—无论我们认为自己的家庭是好还是坏</li>
<li>当一个团队成功的时候，几乎每个人都会倾向于把成功归因于自己的贡献而忽略别人的存在；当一个团队失败的时候，几乎每个人都会倾向于把失败归咎于他人的过失而尽量把自己排除在外。这种现象被称作“自利性偏差”</li>
<li>劣币驱逐良币：Bad money drives out good，也称格雷欣法则（Gresham’s Law）。该法则认为当有两种名义价值相同但实际价值不同的货币同时在市场上流通时，实际价值高的货币将会被屯积并最终被实际价值低的货币取代</li>
<li>God, grant me the serenity to accept the things I cannot change, Courage to change the things I can, And wisdom to know the difference.（愿上帝赐予我从容去接受我不能改变的，赐予我勇气去改变我可以改变的，并赐予我智慧去分辨这两者间的区别。）</li>
<li>任何积累都需要时间，而且必然需要漫长的时间。也正因如此，大多数人才不肯积累，不愿积累，甚至不屑于积累</li>
<li>爱因斯坦说过：“用当年我们制造麻烦的思路，我们根本无法解决它们。”所以，别再跟时间较劲了。看清楚、想明白，问题出在自己身上。将来，时间可能是我们的敌人，也可能是我们的朋友。时间究竟是敌是友，就看你的了……</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.sovdating.com/%E5%90%8E%E7%AB%AF%E6%96%87%E9%9B%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="DJY">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sovdating Linux">
      <meta itemprop="description" content="Hello dev">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Sovdating Linux">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E5%90%8E%E7%AB%AF%E6%96%87%E9%9B%86/" class="post-title-link" itemprop="url">后端文集</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2016-06-06 00:00:00" itemprop="dateCreated datePublished" datetime="2016-06-06T00:00:00+00:00">2016-06-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-01-26 12:42:27" itemprop="dateModified" datetime="2024-01-26T12:42:27+00:00">2024-01-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%90%8E%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">后端</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>兄弟- <code>前端文集</code><br><a target="_blank" rel="noopener" href="http://liuxiang.github.io/2015/12/18/%E5%89%8D%E7%AB%AF%E6%96%87%E9%9B%86/">http://liuxiang.github.io/2015/12/18/%E5%89%8D%E7%AB%AF%E6%96%87%E9%9B%86/</a></p>
<h1 id="RESTful"><a href="#RESTful" class="headerlink" title="RESTful"></a>RESTful</h1><p><code>RESTful API 规范 v1.0-imweb社区 </code><br><a target="_blank" rel="noopener" href="http://imweb.io/topic/5707561f06f2400432c139a5?utm_source=tuicool&utm_medium=referral">http://imweb.io/topic/5707561f06f2400432c139a5?utm_source=tuicool&amp;utm_medium=referral</a></p>
<p><code>RESTful API 编写指南- 微服务</code><br><a target="_blank" rel="noopener" href="http://blog.igevin.info/posts/restful-api-get-started-to-write/">http://blog.igevin.info/posts/restful-api-get-started-to-write/</a></p>
<p><code>RESTful API 设计指南-阮一峰</code><br><a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2014/05/restful_api.html">http://www.ruanyifeng.com/blog/2014/05/restful_api.html</a></p>
<p><code>RESTful API 设计最佳实践</code><br><a target="_blank" rel="noopener" href="http://www.tuicool.com/articles/RR7VzeN">http://www.tuicool.com/articles/RR7VzeN</a></p>
<p><code>Restful api 错误提示返回实现思路</code><br><a target="_blank" rel="noopener" href="http://www.tuicool.com/articles/MZJvm2a">http://www.tuicool.com/articles/MZJvm2a</a></p>
<h1 id="后端教学"><a href="#后端教学" class="headerlink" title="后端教学"></a>后端教学</h1><p><code>free-programming-books.md</code><br><a target="_blank" rel="noopener" href="https://github.com/vhf/free-programming-books/blob/master/free-programming-books.md">https://github.com/vhf/free-programming-books/blob/master/free-programming-books.md</a></p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/%E5%90%8E%E7%AB%AF%E6%96%87%E9%9B%86/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.sovdating.com/%E8%BF%90%E7%BB%B4%E6%98%AF%E4%BB%80%E4%B9%88%E8%A7%92%E8%89%B2%EF%BC%9F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="DJY">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sovdating Linux">
      <meta itemprop="description" content="Hello dev">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Sovdating Linux">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4%E6%98%AF%E4%BB%80%E4%B9%88%E8%A7%92%E8%89%B2%EF%BC%9F/" class="post-title-link" itemprop="url">运维是什么角色？</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2016-06-06 00:00:00" itemprop="dateCreated datePublished" datetime="2016-06-06T00:00:00+00:00">2016-06-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-01-26 12:42:18" itemprop="dateModified" datetime="2024-01-26T12:42:18+00:00">2024-01-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><code> 产品</code> ：汽车设计</p>
<p><code>开发</code> ： 汽车 生产<br><code>测试</code> ：质量品控<br><code>运维</code> ：司机</p>
<p><code>这个 司机不简 单</code> 有时需要在高速行驶过程中换轮胎、并根据道路情况换档位、当汽车速度越来越快，汽车本身不能满足高速度时对汽车性能调优或零件升级、高速行进中解决汽 车故障及性能问题、时刻关注前方安全问题，并先知先觉的采取规避手段。这就是运维工作~</p>
<hr>
<h1 id="执行运维"><a href="#执行运维" class="headerlink" title="执行运维"></a>执行运维</h1><p>第一章    总则</p>
<ol>
<li>为加强公司各个项目后期的系统运维管理，确保系统能够平稳、可靠地运行，更好地为客户提供管理服务，特制定本规定。</li>
<li>本规定适用所有进入运维环节的项目。</li>
<li>运维人员应根据授权，处理本规定中所涉及的业务事项。</li>
</ol>
<p>第二章    主机、服务器及数据库系统的运维管理</p>
<p>第三章    软件系统的运维管理</p>
<p>第四章    数据库的运维管理</p>
<p><code>运维管理规定_百度文库</code><br><a target="_blank" rel="noopener" href="http://wenku.baidu.com/link?url=ZLfRttBsyu3Dps788cNdY55tOf6wdzaycw_zHGt7m_Hr8U9ThGJTA6Hg5jjd1-ZJfXjwgEwLK-sXuaqzffOwQBxTFMvPbVMm4KHNgN1znJq">http://wenku.baidu.com/link?url=ZLfRttBsyu3Dps788cNdY55tOf6wdzaycw_zHGt7m_Hr8U9ThGJTA6Hg5jjd1-ZJfXjwgEwLK-sXuaqzffOwQBxTFMvPbVMm4KHNgN1znJq</a></p>
<hr>
<h1 id="运维工程师"><a href="#运维工程师" class="headerlink" title="运维工程师"></a>运维工程师</h1><p><code>确保线上稳定</code></p>
<p>新产品模式对现有架构及技术的 冲击、产品高频度的升级带来的线上BUG隐患、<br>运维自动化管理承度不高导致的人为失误、IT行业追求的高效率导致流程执行上的缺失、<br>用户增涨带来的性能及 架构上的压力、IT行业宽松的技术管理文化、创新风险、互联网安全性问题等因素，<br>都会是网站稳定的大敌，运维工程师必须把控好这最后一关，需具体高度的责 任感、原则性及协调能力，如果能做到各因素的最佳平衡，那就是一名优秀的运维工程师了</p>
<p>运维对其它关联工种必须非常了解熟悉：网络、系统、系统开发、存储，安全,DB等</p>
<h2 id="二、运维工作师需要什么样的技能及素质"><a href="#二、运维工作师需要什么样的技能及素质" class="headerlink" title="二、运维工作师需要什么样的技能及素质"></a>二、运维工作师需要什么样的技能及素质</h2><p>做为一名运维工程师需要什么样的技能及素质呢?<br>首先说说技能吧，如大家上面所看到，运维是一个集多IT工种技能与一身的岗位，对系统-&gt;网络 -&gt;存储-&gt;协议-&gt;需求-&gt;开发-&gt;测试-&gt;安全等各环节都需要了解一些，但对于某些环节需熟悉甚至精通，如系统 (基本操作系统的熟悉使用,*nix,windows ..)、协议、系统开发(日常很重要的工作是自动运维化相关开发、大规模集群工具开发、管理）、通用应用（如lvs、ha、web server 、db、中间件、存储等）、网络,IDC拓朴架构；</p>
<p><code>个人素质方面：</code><br>1、沟通能力、团队协作：运维工作跨部门、跨工种工作很多，需善于沟通、并且团队协作能力要强；这应该是现代企业的基本素质要求了，不多说。<br>2、工作中需胆大心细：胆大才能创新、不走寻常路，特别对于运维这种新的工种，更需创新才能促进发展；心细，运维工程师是网站admin,最高线上权限者，一不小心就会遗憾终生或打入十八层地狱。<br>3、主动性、执行力、精力旺盛、抗压能力强：由于IT行业的特性，变化快；往往计划赶不上变化，运维工作就更突出了，比如国内各大公司服务器往往是全国各地，哪里便宜性价比高，就那往搬，进行大规模服务迁移（牵扯的服务器成百上千台），这是一个非常头痛的问题；往往时间非常紧迫，如限1周内完成，这种情况下，运维工程师的主动性及执行力就有很高的要求了：计划、方案、服务无缝迁移、机器搬迁上架、环境准备、安全评估、性能评估、基建、各关联部门扯皮,7X24小紧急事故响应等。<br>4、其它就是一些基本素质了：头脑要灵光、逻辑思维能力强、为人谦虚稳重、亲和力、乐于助人、有大局观。<br>5、最后一点，做网站运维需要有探索创新精神，通过创新型思维解决现实中的问题，因为这是一个处于幼年的职业（国外也一样，但比国内起步早点），没有成熟体系或方法论可以借鉴，只能靠大家自已摸索努力。</p>
<h2 id="三、怎样才算是一个合格的运维工程师"><a href="#三、怎样才算是一个合格的运维工程师" class="headerlink" title="三、怎样才算是一个合格的运维工程师"></a>三、怎样才算是一个合格的运维工程师</h2><h2 id="四、运维职业的迷惘、现状与发展前景"><a href="#四、运维职业的迷惘、现状与发展前景" class="headerlink" title="四、运维职业的迷惘、现状与发展前景"></a>四、运维职业的迷惘、现状与发展前景</h2><h2 id="五、运维关键技术点解剖"><a href="#五、运维关键技术点解剖" class="headerlink" title="五、运维关键技术点解剖"></a>五、运维关键技术点解剖</h2><hr>
<p><code>运维工程师的职责和前景 | Linux运维笔记</code><br><a target="_blank" rel="noopener" href="https://blog.linuxeye.com/119.html">https://blog.linuxeye.com/119.html</a></p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/%E8%BF%90%E7%BB%B4%E6%98%AF%E4%BB%80%E4%B9%88%E8%A7%92%E8%89%B2%EF%BC%9F/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.sovdating.com/%E5%B8%B8%E7%94%A8git%E5%91%BD%E4%BB%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="DJY">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sovdating Linux">
      <meta itemprop="description" content="Hello dev">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Sovdating Linux">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E5%B8%B8%E7%94%A8git%E5%91%BD%E4%BB%A4/" class="post-title-link" itemprop="url">常用git命令</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2016-05-28 00:00:00" itemprop="dateCreated datePublished" datetime="2016-05-28T00:00:00+00:00">2016-05-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-01-26 12:42:21" itemprop="dateModified" datetime="2024-01-26T12:42:21+00:00">2024-01-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/git%E5%91%BD%E4%BB%A4/" itemprop="url" rel="index"><span itemprop="name">git命令</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h1><p><code>Git-2.8.3-64-bit.exe</code><br><a target="_blank" rel="noopener" href="https://git-scm.com/download/win">https://git-scm.com/download/win</a></p>
<h1 id="github引导"><a href="#github引导" class="headerlink" title="github引导"></a>github引导</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;# blog.hexo&quot; &gt;&gt; README.md</span><br><span class="line"></span><br><span class="line">git init</span><br><span class="line">git add README.md</span><br><span class="line">git commit -m &quot;first commit&quot;</span><br><span class="line">git remote add origin https://github.com/liuxiang/blog.hexo.git</span><br><span class="line">git push -u origin master  # 推送 远程仓库</span><br></pre></td></tr></table></figure>


<h1 id="oschina-引导"><a href="#oschina-引导" class="headerlink" title="oschina 引导"></a>oschina 引导</h1><p>简易的命令行入门教程:</p>
<p>Git 全局设置:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git config --global user.name &quot;lushanlai&quot;</span><br><span class="line">git config --global user.email &quot;417951577@qq.com&quot;</span><br></pre></td></tr></table></figure>


<p>创建 git 仓库:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mkdir private</span><br><span class="line">cd private</span><br><span class="line">git init</span><br><span class="line">touch README.md</span><br><span class="line">git add README.md</span><br><span class="line">git commit -m &quot;first commit&quot;</span><br><span class="line">git remote add origin https://git.oschina.net/lushanlai/private.git</span><br><span class="line">git push -u origin master</span><br></pre></td></tr></table></figure>


<p>已有项目?</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd existing_git_repo</span><br><span class="line">git remote add origin https://git.oschina.net/lushanlai/private.git</span><br><span class="line">git push -u origin master</span><br></pre></td></tr></table></figure>


<h1 id="本地仓库-推送服务器"><a href="#本地仓库-推送服务器" class="headerlink" title="本地仓库 &amp; 推送服务器"></a>本地仓库 &amp; 推送服务器</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">git init  # 初始化目录为git仓库</span><br><span class="line"></span><br><span class="line">git add .   # 添加所有（暂存）</span><br><span class="line"></span><br><span class="line">git commit -m &quot;first commit&quot; # 提交暂存</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">git remote add origin  https://git.oschina.net/liuxiang7/SQL-work.git   # 设置远程仓库</span><br><span class="line"></span><br><span class="line">git pull -v --progress &quot;origin&quot;  # 更新远程仓库到本地</span><br><span class="line">git push -u origin master # 推送至 远程仓库</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">F:\work\SQL work&gt;git init</span><br><span class="line">Initialized empty Git repository in F:/work/SQL work/.git/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">F:\work\SQL work&gt;git add .</span><br><span class="line">warning: LF will be replaced by CRLF in MySql-wosai/更多/game/排名.sql.</span><br><span class="line">The file will have its original line endings in your working directory.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">F:\work\SQL work&gt;git commit -m &quot;first commit&quot;</span><br><span class="line">[master (root-commit) 63697a6] first commit</span><br><span class="line">warning: LF will be replaced by CRLF in MySql-wosai/更多/game/排名.sql.</span><br><span class="line">The file will have its original line endings in your working directory.</span><br><span class="line"> 72 files changed, 11363 insertions(+)</span><br><span class="line"> create mode 100644 &quot;Asia-Sql/7\347\272\247\345\214\272\345\237\237.sql&quot;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">F:\work\SQL work&gt;git.exe pull -v --progress &quot;origin&quot;  # 更新</span><br><span class="line">Username for &#x27;https://git.oschina.net&#x27;: liuxiang.1227@qq.com</span><br><span class="line">Password for &#x27;https://liuxiang.1227@qq.com@git.oschina.net&#x27;:</span><br><span class="line">fatal: Couldn&#x27;t find remote ref #</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">F:\work\SQL work&gt;git remote add origin https://git.oschina.net/liuxiang7/SQL-work.git</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">F:\work\SQL work&gt;git push -u origin master</span><br><span class="line">Username for &#x27;https://git.oschina.net&#x27;: liuxiang.1227@qq.com</span><br><span class="line">Password for &#x27;https://liuxiang.1227@qq.com@git.oschina.net&#x27;:</span><br><span class="line">Counting objects: 77, done.</span><br><span class="line">Delta compression using up to 4 threads.</span><br><span class="line">Compressing objects: 100% (70/70), done.</span><br><span class="line">Writing objects: 100% (77/77), 104.78 KiB | 0 bytes/s, done.</span><br><span class="line">Total 77 (delta 2), reused 0 (delta 0)</span><br><span class="line">To https://git.oschina.net/liuxiang7/SQL-work.git</span><br><span class="line">   2caa42f..709f26f  master -&gt; master</span><br><span class="line">Branch master set up to track remote branch master from origin.</span><br></pre></td></tr></table></figure>


<hr>
<p><code>git常用命令 - 推酷</code><br><a target="_blank" rel="noopener" href="http://www.tuicool.com/articles/FZBvUrn">http://www.tuicool.com/articles/FZBvUrn</a></p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/%E5%B8%B8%E7%94%A8git%E5%91%BD%E4%BB%A4/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.sovdating.com/Lucene-6-0-in-action-5-The-index-search-an-IndexSearcher/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="DJY">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sovdating Linux">
      <meta itemprop="description" content="Hello dev">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Sovdating Linux">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Lucene-6-0-in-action-5-The-index-search-an-IndexSearcher/" class="post-title-link" itemprop="url">Lucene 6.0 实战（5）-索引搜索器IndexSearcher</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2016-05-24 21:51:49" itemprop="dateCreated datePublished" datetime="2016-05-24T21:51:49+00:00">2016-05-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-01-26 12:42:18" itemprop="dateModified" datetime="2024-01-26T12:42:18+00:00">2024-01-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Programming-Notes/" itemprop="url" rel="index"><span itemprop="name">Programming Notes</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="Lucene的主要搜索API"><a href="#Lucene的主要搜索API" class="headerlink" title="Lucene的主要搜索API"></a>Lucene的主要搜索API</h3><p>一个简单的搜索应用主要包括索引和搜索两部分，在Lucene中，IndexSearcher类是用于对索引中文档进行搜索的核心类，它有几个重载的搜索方法，可以使用最常用的方法对特定的项进行搜索，一个项由一个字符串类型的域值和对应的域名构成。现将搜索相关API汇总如下</p>
<table>
<thead>
<tr>
<th>类</th>
<th>目的</th>
</tr>
</thead>
<tbody><tr>
<td>IndexSearcher</td>
<td>搜索索引的核心类。所有搜索都通过IndexSearcher进行，它们会调用该类中重载的search方法</td>
</tr>
<tr>
<td>Query及其子类</td>
<td>封装某种查询类型的具体子类。Query实例将被传递给IndexSearcher的search方法</td>
</tr>
<tr>
<td>QueryParser</td>
<td>将用户输入的可读的查询表达式处理成具体的Query对象</td>
</tr>
<tr>
<td>TopDocs</td>
<td>保持由IndexSearcher.search()方法返回的具有较高评分的顶部文档</td>
</tr>
<tr>
<td>ScoreDoc</td>
<td>提供对TopDocs中每条搜索结果的访问接口</td>
</tr>
</tbody></table>
<h3 id="IndexSearcher简介"><a href="#IndexSearcher简介" class="headerlink" title="IndexSearcher简介"></a>IndexSearcher简介</h3><p>首先看IndexSearcher的doc注释</p>
<blockquote>
<p>Implements search over a single IndexReader.<br>Applications usually need only call the inherited search(Query, int) or search(Query, Filter, int) methods. For performance reasons, if your index is unchanging, you should share a single IndexSearcher instance across multiple searches instead of creating a new one per-search. If your index has changed and you wish to see the changes reflected in searching, you should use DirectoryReader.openIfChanged(DirectoryReader) to obtain a new reader and then create a new IndexSearcher from that. Also, for low-latency turnaround it’s best to use a near-real-time reader (DirectoryReader.open(IndexWriter)). Once you have a new IndexReader, it’s relatively cheap to create a new IndexSearcher from it.<br>NOTE: IndexSearcher instances are completely thread safe, meaning multiple threads can call any of its methods, concurrently. If your application requires external synchronization, you should not synchronize on the IndexSearcher instance; use your own (non-Lucene) objects instead.</p>
</blockquote>
<p>从这段说明中得出如下几点</p>
<ul>
<li>提供了对单个IndexReader的查询实现</li>
<li>通常应用程序只需要调用search(Query, int)或者search(Query, Filter, int)方法</li>
<li>如果你的索引不变，在多个搜索中应该采用共享一个IndexSearcher实例的方式</li>
<li>如果索引有变动，并且你希望在搜索中有所体现，那么应该使用DirectoryReader.openIfChanged(DirectoryReader)来获取新的reader，然后通过这个reader创建一个新的IndexSearcher</li>
<li>为了低延迟查询，最好使用近实时搜索（NRT），此时构建IndexSearcher需要使用DirectoryReader.open(IndexWriter)，一旦你获取一个新的IndexReader，再去创建一个IndexSearcher所付出的代价要小的多</li>
<li>IndexSearcher实例是完全线程安全的，这意味着多个线程可以并发调用任何方法。如果需要外部同步，无需对IndexSearcher实例进行同步</li>
</ul>
<h3 id="Lucene的多样化查询"><a href="#Lucene的多样化查询" class="headerlink" title="Lucene的多样化查询"></a>Lucene的多样化查询</h3><ul>
<li>通过项进行搜索-TermQuery类</li>
<li>在指定的项范围内搜索-TermRangeQuery类</li>
<li>通过字符串搜索-PrefixQuery类</li>
<li>组合查询-BooleanQuery类</li>
<li>通过短语搜索-PhraseQuery类</li>
<li>通配符查询-WildcardQuery类</li>
<li>搜索类似项-FuzzyQuery类</li>
<li>匹配所有文档-MatchAllDocsQuery类</li>
<li>不匹配文档-MatchNoDocsQuery类</li>
<li>解析查询表达式-QueryParser类</li>
<li>多短语查询-MultiPhraseQuery类</li>
</ul>
<p>一些简单的查询示例如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.lucene.analysis.Analyzer;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.analysis.TokenStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.analysis.core.WhitespaceAnalyzer;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.analysis.standard.StandardAnalyzer;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.analysis.tokenattributes.OffsetAttribute;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.document.Document;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.document.Field;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.document.StringField;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.document.TextField;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.index.DirectoryReader;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.index.IndexWriter;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.index.IndexWriterConfig;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.index.Term;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.queryparser.classic.ParseException;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.queryparser.classic.QueryParser;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.search.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.store.Directory;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.store.RAMDirectory;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.util.BytesRef;</span><br><span class="line"><span class="keyword">import</span> org.junit.Assert;</span><br><span class="line"><span class="keyword">import</span> org.junit.Before;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.StringReader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IndexSearchDemo</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Directory</span> <span class="variable">directory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RAMDirectory</span>();</span><br><span class="line">    <span class="keyword">private</span> String[] ids = &#123;<span class="string">&quot;1&quot;</span>, <span class="string">&quot;2&quot;</span>&#125;;</span><br><span class="line">    <span class="keyword">private</span> String[] countries = &#123;<span class="string">&quot;Netherlands&quot;</span>, <span class="string">&quot;Italy&quot;</span>&#125;;</span><br><span class="line">    <span class="keyword">private</span> String[] contents = &#123;<span class="string">&quot;Amsterdam has lots of bridges&quot;</span>, <span class="string">&quot;Venice has lots of canals, not bridges&quot;</span>&#125;;</span><br><span class="line">    <span class="keyword">private</span> String[] cities = &#123;<span class="string">&quot;Amsterdam&quot;</span>, <span class="string">&quot;Venice&quot;</span>&#125;;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">IndexWriterConfig</span> <span class="variable">indexWriterConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexWriterConfig</span>(<span class="keyword">new</span> <span class="title class_">WhitespaceAnalyzer</span>());</span><br><span class="line">    <span class="keyword">private</span> IndexWriter indexWriter;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createIndex</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            indexWriter = <span class="keyword">new</span> <span class="title class_">IndexWriter</span>(directory, indexWriterConfig);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) &#123;</span><br><span class="line">                <span class="type">Document</span> <span class="variable">document</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Document</span>();</span><br><span class="line">                <span class="type">Field</span> <span class="variable">idField</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringField</span>(<span class="string">&quot;id&quot;</span>, ids[i], Field.Store.YES);</span><br><span class="line">                <span class="type">Field</span> <span class="variable">countryField</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringField</span>(<span class="string">&quot;country&quot;</span>, countries[i], Field.Store.YES);</span><br><span class="line">                <span class="type">Field</span> <span class="variable">contentField</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TextField</span>(<span class="string">&quot;content&quot;</span>, contents[i], Field.Store.NO);</span><br><span class="line">                <span class="type">Field</span> <span class="variable">cityField</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringField</span>(<span class="string">&quot;city&quot;</span>, cities[i], Field.Store.YES);</span><br><span class="line">                document.add(idField);</span><br><span class="line">                document.add(countryField);</span><br><span class="line">                document.add(contentField);</span><br><span class="line">                document.add(cityField);</span><br><span class="line">                indexWriter.addDocument(document);</span><br><span class="line">            &#125;</span><br><span class="line">            indexWriter.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testTermQuery</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Term</span> <span class="variable">term</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">&quot;id&quot;</span>, <span class="string">&quot;2&quot;</span>);</span><br><span class="line">        <span class="type">IndexSearcher</span> <span class="variable">indexSearcher</span> <span class="operator">=</span> getIndexSearcher();</span><br><span class="line">        <span class="type">TopDocs</span> <span class="variable">search</span> <span class="operator">=</span> indexSearcher.search(<span class="keyword">new</span> <span class="title class_">TermQuery</span>(term), <span class="number">10</span>);</span><br><span class="line">        Assert.assertEquals(<span class="number">1</span>, search.totalHits);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testMatchNoDocsQuery</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Query</span> <span class="variable">query</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MatchNoDocsQuery</span>();</span><br><span class="line">        <span class="type">IndexSearcher</span> <span class="variable">indexSearcher</span> <span class="operator">=</span> getIndexSearcher();</span><br><span class="line">        <span class="type">TopDocs</span> <span class="variable">search</span> <span class="operator">=</span> indexSearcher.search(query, <span class="number">10</span>);</span><br><span class="line">        Assert.assertEquals(<span class="number">0</span>, search.totalHits);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testTermRangeQuery</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">//搜索起始字母范围从A到Z的city</span></span><br><span class="line">        <span class="type">Query</span> <span class="variable">query</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TermRangeQuery</span>(<span class="string">&quot;city&quot;</span>, <span class="keyword">new</span> <span class="title class_">BytesRef</span>(<span class="string">&quot;A&quot;</span>), <span class="keyword">new</span> <span class="title class_">BytesRef</span>(<span class="string">&quot;Z&quot;</span>), <span class="literal">true</span>, <span class="literal">true</span>);</span><br><span class="line">        <span class="type">IndexSearcher</span> <span class="variable">indexSearcher</span> <span class="operator">=</span> getIndexSearcher();</span><br><span class="line">        <span class="type">TopDocs</span> <span class="variable">search</span> <span class="operator">=</span> indexSearcher.search(query, <span class="number">10</span>);</span><br><span class="line">        Assert.assertEquals(<span class="number">2</span>, search.totalHits);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testQueryParser</span><span class="params">()</span> <span class="keyword">throws</span> ParseException, IOException &#123;</span><br><span class="line">        <span class="comment">//使用WhitespaceAnalyzer分析器不会忽略大小写，也就是说大小写敏感</span></span><br><span class="line">        <span class="type">QueryParser</span> <span class="variable">queryParser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QueryParser</span>(<span class="string">&quot;content&quot;</span>, <span class="keyword">new</span> <span class="title class_">WhitespaceAnalyzer</span>());</span><br><span class="line">        <span class="type">Query</span> <span class="variable">query</span> <span class="operator">=</span> queryParser.parse(<span class="string">&quot;+lots +has&quot;</span>);</span><br><span class="line">        <span class="type">IndexSearcher</span> <span class="variable">indexSearcher</span> <span class="operator">=</span> getIndexSearcher();</span><br><span class="line">        <span class="type">TopDocs</span> <span class="variable">search</span> <span class="operator">=</span> indexSearcher.search(query, <span class="number">1</span>);</span><br><span class="line">        Assert.assertEquals(<span class="number">2</span>, search.totalHits);</span><br><span class="line">        query = queryParser.parse(<span class="string">&quot;lots OR bridges&quot;</span>);</span><br><span class="line">        search = indexSearcher.search(query, <span class="number">10</span>);</span><br><span class="line">        Assert.assertEquals(<span class="number">2</span>, search.totalHits);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//有点需要注意，在QueryParser解析通配符表达式的时候，一定要用引号包起来，然后作为字符串传递给parse函数</span></span><br><span class="line">        query = <span class="keyword">new</span> <span class="title class_">QueryParser</span>(<span class="string">&quot;field&quot;</span>, <span class="keyword">new</span> <span class="title class_">StandardAnalyzer</span>()).parse(<span class="string">&quot;\&quot;This is some phrase*\&quot;&quot;</span>);</span><br><span class="line">        Assert.assertEquals(<span class="string">&quot;analyzed&quot;</span>, <span class="string">&quot;\&quot;? ? some phrase\&quot;&quot;</span>, query.toString(<span class="string">&quot;field&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//语法参考：http://lucene.apache.org/core/6_0_0/queryparser/org/apache/lucene/queryparser/classic/package-summary.html#package_description</span></span><br><span class="line">        <span class="comment">//使用QueryParser解析&quot;~&quot;，~代表编辑距离，~后面参数的取值在0-2之间，默认值是2，不要使用浮点数</span></span><br><span class="line">        <span class="type">QueryParser</span> <span class="variable">parser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QueryParser</span>(<span class="string">&quot;city&quot;</span>, <span class="keyword">new</span> <span class="title class_">WhitespaceAnalyzer</span>());</span><br><span class="line">        <span class="comment">//例如，roam~，该查询会匹配foam和roams，如果~后不跟参数，则默认值是2</span></span><br><span class="line">        <span class="comment">//QueryParser在解析的时候不区分大小写（会全部转成小写字母），所以虽少了一个字母，但是首字母被解析为小写的v，依然不匹配，所以编辑距离是2</span></span><br><span class="line">        query = parser.parse(<span class="string">&quot;Venic~2&quot;</span>);</span><br><span class="line">        search = indexSearcher.search(query, <span class="number">10</span>);</span><br><span class="line">        Assert.assertEquals(<span class="number">1</span>, search.totalHits);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testBooleanQuery</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Query</span> <span class="variable">termQuery</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TermQuery</span>(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">&quot;country&quot;</span>, <span class="string">&quot;Beijing&quot;</span>));</span><br><span class="line">        <span class="type">Query</span> <span class="variable">termQuery1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TermQuery</span>(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">&quot;city&quot;</span>, <span class="string">&quot;Venice&quot;</span>));</span><br><span class="line">        <span class="comment">//测试OR查询，或者出现Beijing或者出现Venice</span></span><br><span class="line">        <span class="type">BooleanQuery</span> <span class="variable">build</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BooleanQuery</span>.Builder().add(termQuery, BooleanClause.Occur.SHOULD).add(termQuery1, BooleanClause.Occur.SHOULD).build();</span><br><span class="line">        <span class="type">IndexSearcher</span> <span class="variable">indexSearcher</span> <span class="operator">=</span> getIndexSearcher();</span><br><span class="line">        <span class="type">TopDocs</span> <span class="variable">search</span> <span class="operator">=</span> indexSearcher.search(build, <span class="number">10</span>);</span><br><span class="line">        Assert.assertEquals(<span class="number">1</span>, search.totalHits);</span><br><span class="line">        <span class="comment">//使用BooleanQuery实现 国家是(Italy OR Netherlands) AND contents中包含(Amsterdam)操作</span></span><br><span class="line">        <span class="type">BooleanQuery</span> <span class="variable">build1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BooleanQuery</span>.Builder().add(<span class="keyword">new</span> <span class="title class_">TermQuery</span>(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">&quot;country&quot;</span>, <span class="string">&quot;Italy&quot;</span>)), BooleanClause.Occur.SHOULD).add(<span class="keyword">new</span> <span class="title class_">TermQuery</span></span><br><span class="line">                (<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">&quot;country&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;Netherlands&quot;</span>)), BooleanClause.Occur.SHOULD).build();</span><br><span class="line">        <span class="type">BooleanQuery</span> <span class="variable">build2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BooleanQuery</span>.Builder().add(build1, BooleanClause.Occur.MUST).add(<span class="keyword">new</span> <span class="title class_">TermQuery</span>(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">&quot;content&quot;</span>, <span class="string">&quot;Amsterdam&quot;</span>)), BooleanClause.Occur</span><br><span class="line">                .MUST).build();</span><br><span class="line">        search = indexSearcher.search(build2, <span class="number">10</span>);</span><br><span class="line">        Assert.assertEquals(<span class="number">1</span>, search.totalHits);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testPhraseQuery</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">//设置两个短语之间的跨度为2，也就是说has和bridges之间的短语小于等于均可检索到</span></span><br><span class="line">        <span class="type">PhraseQuery</span> <span class="variable">build</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PhraseQuery</span>.Builder().setSlop(<span class="number">2</span>).add(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">&quot;content&quot;</span>, <span class="string">&quot;has&quot;</span>)).add(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">&quot;content&quot;</span>, <span class="string">&quot;bridges&quot;</span>)).build();</span><br><span class="line">        <span class="type">IndexSearcher</span> <span class="variable">indexSearcher</span> <span class="operator">=</span> getIndexSearcher();</span><br><span class="line">        <span class="type">TopDocs</span> <span class="variable">search</span> <span class="operator">=</span> indexSearcher.search(build, <span class="number">10</span>);</span><br><span class="line">        Assert.assertEquals(<span class="number">1</span>, search.totalHits);</span><br><span class="line">        build = <span class="keyword">new</span> <span class="title class_">PhraseQuery</span>.Builder().setSlop(<span class="number">1</span>).add(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">&quot;content&quot;</span>, <span class="string">&quot;Venice&quot;</span>)).add(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">&quot;content&quot;</span>, <span class="string">&quot;lots&quot;</span>)).add(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">&quot;content&quot;</span>,</span><br><span class="line">                <span class="string">&quot;canals&quot;</span>)).build();</span><br><span class="line">        search = indexSearcher.search(build, <span class="number">10</span>);</span><br><span class="line">        Assert.assertNotEquals(<span class="number">1</span>, search.totalHits);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testMatchAllDocsQuery</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Query</span> <span class="variable">query</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MatchAllDocsQuery</span>();</span><br><span class="line">        <span class="type">IndexSearcher</span> <span class="variable">indexSearcher</span> <span class="operator">=</span> getIndexSearcher();</span><br><span class="line">        <span class="type">TopDocs</span> <span class="variable">search</span> <span class="operator">=</span> indexSearcher.search(query, <span class="number">10</span>);</span><br><span class="line">        Assert.assertEquals(<span class="number">2</span>, search.totalHits);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testFuzzyQuery</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ParseException &#123;</span><br><span class="line">        <span class="comment">//注意是区分大小写的，同时默认的编辑距离的值是2</span></span><br><span class="line">        <span class="comment">//注意两个Term之间的编辑距离必须小于两者中最小者的长度：the edit distance between the terms must be less than the minimum length term</span></span><br><span class="line">        <span class="type">Query</span> <span class="variable">query</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FuzzyQuery</span>(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">&quot;city&quot;</span>, <span class="string">&quot;Veni&quot;</span>));</span><br><span class="line">        <span class="type">IndexSearcher</span> <span class="variable">indexSearcher</span> <span class="operator">=</span> getIndexSearcher();</span><br><span class="line">        <span class="type">TopDocs</span> <span class="variable">search</span> <span class="operator">=</span> indexSearcher.search(query, <span class="number">10</span>);</span><br><span class="line">        Assert.assertEquals(<span class="number">1</span>, search.totalHits);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testWildcardQuery</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">//*代表0个或者多个字母</span></span><br><span class="line">        <span class="type">Query</span> <span class="variable">query</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WildcardQuery</span>(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">&quot;content&quot;</span>, <span class="string">&quot;*dam&quot;</span>));</span><br><span class="line">        <span class="type">IndexSearcher</span> <span class="variable">indexSearcher</span> <span class="operator">=</span> getIndexSearcher();</span><br><span class="line">        <span class="type">TopDocs</span> <span class="variable">search</span> <span class="operator">=</span> indexSearcher.search(query, <span class="number">10</span>);</span><br><span class="line">        Assert.assertEquals(<span class="number">1</span>, search.totalHits);</span><br><span class="line">        <span class="comment">//?代表0个或者1个字母</span></span><br><span class="line">        query = <span class="keyword">new</span> <span class="title class_">WildcardQuery</span>(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">&quot;content&quot;</span>, <span class="string">&quot;?ridges&quot;</span>));</span><br><span class="line">        search = indexSearcher.search(query, <span class="number">10</span>);</span><br><span class="line">        Assert.assertEquals(<span class="number">2</span>, search.totalHits);</span><br><span class="line">        query = <span class="keyword">new</span> <span class="title class_">WildcardQuery</span>(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">&quot;content&quot;</span>, <span class="string">&quot;b*s&quot;</span>));</span><br><span class="line">        search = indexSearcher.search(query, <span class="number">10</span>);</span><br><span class="line">        Assert.assertEquals(<span class="number">2</span>, search.totalHits);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testPrefixQuery</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">//使用前缀搜索以It打头的国家名，显然只有Italy符合</span></span><br><span class="line">        <span class="type">PrefixQuery</span> <span class="variable">query</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PrefixQuery</span>(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">&quot;country&quot;</span>, <span class="string">&quot;It&quot;</span>));</span><br><span class="line">        <span class="type">IndexSearcher</span> <span class="variable">indexSearcher</span> <span class="operator">=</span> getIndexSearcher();</span><br><span class="line">        <span class="type">TopDocs</span> <span class="variable">search</span> <span class="operator">=</span> indexSearcher.search(query, <span class="number">10</span>);</span><br><span class="line">        Assert.assertEquals(<span class="number">1</span>, search.totalHits);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> IndexSearcher <span class="title function_">getIndexSearcher</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">IndexSearcher</span>(DirectoryReader.open(directory));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testToken</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Analyzer</span> <span class="variable">analyzer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StandardAnalyzer</span>();</span><br><span class="line">        <span class="type">TokenStream</span></span><br><span class="line">                <span class="variable">tokenStream</span> <span class="operator">=</span> analyzer.tokenStream(<span class="string">&quot;myfield&quot;</span>, <span class="keyword">new</span> <span class="title class_">StringReader</span>(<span class="string">&quot;Some text content for my test!&quot;</span>));</span><br><span class="line">        <span class="type">OffsetAttribute</span> <span class="variable">offsetAttribute</span> <span class="operator">=</span> tokenStream.addAttribute(OffsetAttribute.class);</span><br><span class="line">        tokenStream.reset();</span><br><span class="line">        <span class="keyword">while</span> (tokenStream.incrementToken()) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;token: &quot;</span> + tokenStream.reflectAsString(<span class="literal">true</span>).toString());</span><br><span class="line">            System.out.println(<span class="string">&quot;token start offset: &quot;</span> + offsetAttribute.startOffset());</span><br><span class="line">            System.out.println(<span class="string">&quot;token end offset: &quot;</span> + offsetAttribute.endOffset());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testMultiPhraseQuery</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        Term[] terms = <span class="keyword">new</span> <span class="title class_">Term</span>[]&#123;<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">&quot;content&quot;</span>, <span class="string">&quot;has&quot;</span>), <span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">&quot;content&quot;</span>, <span class="string">&quot;lots&quot;</span>)&#125;;</span><br><span class="line">        <span class="type">Term</span> <span class="variable">term2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">&quot;content&quot;</span>, <span class="string">&quot;bridges&quot;</span>);</span><br><span class="line">        <span class="comment">//多个add之间认为是OR操作，即(has lots)和bridges之间的slop不大于3，不计算标点</span></span><br><span class="line">        <span class="type">MultiPhraseQuery</span> <span class="variable">multiPhraseQuery</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MultiPhraseQuery</span>.Builder().add(terms).add(term2).setSlop(<span class="number">3</span>).build();</span><br><span class="line">        <span class="type">IndexSearcher</span> <span class="variable">indexSearcher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexSearcher</span>(DirectoryReader.open(directory));</span><br><span class="line">        <span class="type">TopDocs</span> <span class="variable">search</span> <span class="operator">=</span> indexSearcher.search(multiPhraseQuery, <span class="number">10</span>);</span><br><span class="line">        Assert.assertEquals(<span class="number">2</span>, search.totalHits);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//使用BooleanQuery类模拟MultiPhraseQuery类的功能</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testBooleanQueryImitateMultiPhraseQuery</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">PhraseQuery</span> <span class="variable">first</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PhraseQuery</span>.Builder().setSlop(<span class="number">3</span>).add(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">&quot;content&quot;</span>, <span class="string">&quot;Amsterdam&quot;</span>)).add(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">&quot;content&quot;</span>, <span class="string">&quot;bridges&quot;</span>))</span><br><span class="line">                .build();</span><br><span class="line">        <span class="type">PhraseQuery</span> <span class="variable">second</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PhraseQuery</span>.Builder().setSlop(<span class="number">1</span>).add(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">&quot;content&quot;</span>, <span class="string">&quot;Venice&quot;</span>)).add(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">&quot;content&quot;</span>, <span class="string">&quot;lots&quot;</span>)).build();</span><br><span class="line">        <span class="type">BooleanQuery</span> <span class="variable">booleanQuery</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BooleanQuery</span>.Builder().add(first, BooleanClause.Occur.SHOULD).add(second, BooleanClause.Occur.SHOULD).build();</span><br><span class="line">        <span class="type">IndexSearcher</span> <span class="variable">indexSearcher</span> <span class="operator">=</span> getIndexSearcher();</span><br><span class="line">        <span class="type">TopDocs</span> <span class="variable">search</span> <span class="operator">=</span> indexSearcher.search(booleanQuery, <span class="number">10</span>);</span><br><span class="line">        Assert.assertEquals(<span class="number">2</span>, search.totalHits);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有关QueryParser的详细语法请参考<a target="_blank" rel="noopener" href="http://lucene.apache.org/core/6_0_0/queryparser/index.html?org/apache/lucene/queryparser/classic/package-summary.html">这里</a>。</p>
<h3 id="Lucene的高级搜索技术"><a href="#Lucene的高级搜索技术" class="headerlink" title="Lucene的高级搜索技术"></a>Lucene的高级搜索技术</h3><p>Lucene包含了一个建立在SpanQuery类基础上的整套查询体系，大致反映了Lucene的Query类体系。SpanQuery是指域中的起始语汇单元和终止语汇单元的位置。SpanQuery有一些常用的子类，如下所示</p>
<table>
<thead>
<tr>
<th>SpanQuery类型</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>FieldMaskingSpanQuery</td>
<td>用于在多个域之间查询，即把另一个域看作某个域，从而看起来就像在同一个域里查询，因为 Lucene 默认某个条件只能作用在单个域上，不支持跨域查询，只能在同一个域里查询，所以有了 FieldMaskingSpanQuery</td>
</tr>
<tr>
<td>SpanTermQuery</td>
<td>和其它跨度查询类型结合使用，单独使用时相当于 TermQuery，唯一的区别就是使用 SpanTermQuery 可以得到 Term 的 Span 跨度信息</td>
</tr>
<tr>
<td>SpanNearQuery</td>
<td>用来匹配两个 Term 之间的跨度的，即一个 Term 经过几个跨度可以到达另一个 Term，slop 为跨度因子，用来限制两个 Term 之间的最大跨度。还有一个 inOrder 参数，它用来设置是否允许进行倒序跨度，什么意思？即 TermA 到 TermB 不一定是从左到右去匹配也可以从右到左，而从右到左就是倒序，inOrder 为 true 即表示 order（顺序）很重要不能倒序去匹配必须正向去匹配，false 则反之。注意停用词不在 slop 统计范围内</td>
</tr>
<tr>
<td>SpanFirstQuery</td>
<td>表示对出现在一个域中的[0, n]范围内的 term 项进行的匹配查询，关键是n指定了查询的 term 出现范围的上限</td>
</tr>
<tr>
<td>SpanContainingQuery</td>
<td>返回在另一个范围内的查询匹配结果，big 和 little 的子句可以是任何 span 类型查询。在包含 little 匹配中从 big 匹配跨度返回。例如“a beautiful and boring world”，big 查询是 SpanNearQuery(SpanTermQuery(“beautiful”), SpanTermQuery(“world”)).setSlop(2)，而 little 查询是 SpanTermQuery(“boring”)，则该 Doc 命中，并从 big 匹配跨度返回，即 big 优先级高</td>
</tr>
<tr>
<td>SpanWithinQuery</td>
<td>与 SpanContainingQuery 类似，只不过是从 little 匹配跨度返回，换句话说，SpanContainingQuery 是 big 查询优先级更高，而 SpanWithinQuery 是 little 查询优先级更高。也许英文说的更清晰，In clear, the SpanContainingQuery will keep matches that contain another Spans, while the SpanWithinQuery will keep matches that are contained within another Spans.</td>
</tr>
<tr>
<td>SpanNotQuery</td>
<td>使用场景是当使用 SpanNearQuery 时，如果两个 Term 从 TermA 到 TermB 有多种情况，即可能出现 TermA 或者 TermB 在索引中重复出现，则可能有多种情况，SpanNotQuery 就是用来限制 TermA 和 TermB 之间不存在 TermC，从而排除一些情况，实现更精确的控制</td>
</tr>
<tr>
<td>SpanOrQuery</td>
<td>这个查询会嵌套一些子查询，子查询之间的逻辑关系为或</td>
</tr>
</tbody></table>
<p>使用示例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.lucene.analysis.Analyzer;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.analysis.TokenStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.analysis.core.WhitespaceAnalyzer;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.analysis.tokenattributes.OffsetAttribute;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.document.Document;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.document.Field;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.document.StringField;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.document.TextField;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.index.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.search.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.search.spans.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.store.RAMDirectory;</span><br><span class="line"><span class="keyword">import</span> org.junit.After;</span><br><span class="line"><span class="keyword">import</span> org.junit.Assert;</span><br><span class="line"><span class="keyword">import</span> org.junit.Before;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.StringReader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpanQueryDemo</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> RAMDirectory directory;</span><br><span class="line">    <span class="keyword">private</span> IndexSearcher indexSearcher;</span><br><span class="line">    <span class="keyword">private</span> IndexReader indexReader;</span><br><span class="line">    <span class="keyword">private</span> SpanTermQuery quick;</span><br><span class="line">    <span class="keyword">private</span> SpanTermQuery brown;</span><br><span class="line">    <span class="keyword">private</span> SpanTermQuery red;</span><br><span class="line">    <span class="keyword">private</span> SpanTermQuery fox;</span><br><span class="line">    <span class="keyword">private</span> SpanTermQuery lazy;</span><br><span class="line">    <span class="keyword">private</span> SpanTermQuery sleepy;</span><br><span class="line">    <span class="keyword">private</span> SpanTermQuery dog;</span><br><span class="line">    <span class="keyword">private</span> SpanTermQuery cat;</span><br><span class="line">    <span class="keyword">private</span> Analyzer analyzer;</span><br><span class="line">    <span class="keyword">private</span> IndexWriter indexWriter;</span><br><span class="line">    <span class="keyword">private</span> IndexWriterConfig indexWriterConfig;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUp</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        directory = <span class="keyword">new</span> <span class="title class_">RAMDirectory</span>();</span><br><span class="line">        analyzer = <span class="keyword">new</span> <span class="title class_">WhitespaceAnalyzer</span>();</span><br><span class="line">        indexWriterConfig = <span class="keyword">new</span> <span class="title class_">IndexWriterConfig</span>(analyzer);</span><br><span class="line">        indexWriterConfig.setOpenMode(IndexWriterConfig.OpenMode.CREATE_OR_APPEND);</span><br><span class="line">        indexWriter = <span class="keyword">new</span> <span class="title class_">IndexWriter</span>(directory, indexWriterConfig);</span><br><span class="line">        <span class="type">Document</span> <span class="variable">document</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Document</span>();</span><br><span class="line">        <span class="comment">//TextField使用Store.YES时索引文档、频率、位置信息</span></span><br><span class="line">        document.add(<span class="keyword">new</span> <span class="title class_">TextField</span>(<span class="string">&quot;f&quot;</span>, <span class="string">&quot;What&#x27;s amazing, the quick brown fox jumps over the lazy dog&quot;</span>, Field.Store.YES));</span><br><span class="line">        indexWriter.addDocument(document);</span><br><span class="line">        document = <span class="keyword">new</span> <span class="title class_">Document</span>();</span><br><span class="line">        document.add(<span class="keyword">new</span> <span class="title class_">TextField</span>(<span class="string">&quot;f&quot;</span>, <span class="string">&quot;Wow! the quick red fox jumps over the sleepy cat&quot;</span>, Field.Store.YES));</span><br><span class="line">        indexWriter.addDocument(document);</span><br><span class="line">        indexWriter.commit();</span><br><span class="line">        indexSearcher = <span class="keyword">new</span> <span class="title class_">IndexSearcher</span>(DirectoryReader.open(directory));</span><br><span class="line">        indexReader = indexSearcher.getIndexReader();</span><br><span class="line">        quick = <span class="keyword">new</span> <span class="title class_">SpanTermQuery</span>(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">&quot;f&quot;</span>, <span class="string">&quot;quick&quot;</span>));</span><br><span class="line">        brown = <span class="keyword">new</span> <span class="title class_">SpanTermQuery</span>(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">&quot;f&quot;</span>, <span class="string">&quot;brown&quot;</span>));</span><br><span class="line">        red = <span class="keyword">new</span> <span class="title class_">SpanTermQuery</span>(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">&quot;f&quot;</span>, <span class="string">&quot;red&quot;</span>));</span><br><span class="line">        fox = <span class="keyword">new</span> <span class="title class_">SpanTermQuery</span>(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">&quot;f&quot;</span>, <span class="string">&quot;fox&quot;</span>));</span><br><span class="line">        lazy = <span class="keyword">new</span> <span class="title class_">SpanTermQuery</span>(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">&quot;f&quot;</span>, <span class="string">&quot;lazy&quot;</span>));</span><br><span class="line">        dog = <span class="keyword">new</span> <span class="title class_">SpanTermQuery</span>(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">&quot;f&quot;</span>, <span class="string">&quot;dog&quot;</span>));</span><br><span class="line">        sleepy = <span class="keyword">new</span> <span class="title class_">SpanTermQuery</span>(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">&quot;f&quot;</span>, <span class="string">&quot;sleepy&quot;</span>));</span><br><span class="line">        cat = <span class="keyword">new</span> <span class="title class_">SpanTermQuery</span>(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">&quot;f&quot;</span>, <span class="string">&quot;cat&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDown</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (indexWriter != <span class="literal">null</span> &amp;&amp; indexWriter.isOpen()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                indexWriter.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                System.out.println(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">assertOnlyBrownFox</span><span class="params">(Query query)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">TopDocs</span> <span class="variable">search</span> <span class="operator">=</span> indexSearcher.search(query, <span class="number">10</span>);</span><br><span class="line">        Assert.assertEquals(<span class="number">1</span>, search.totalHits);</span><br><span class="line">        Assert.assertEquals(<span class="string">&quot;wrong doc&quot;</span>, <span class="number">0</span>, search.scoreDocs[<span class="number">0</span>].doc);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">assertBothFoxes</span><span class="params">(Query query)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">TopDocs</span> <span class="variable">search</span> <span class="operator">=</span> indexSearcher.search(query, <span class="number">10</span>);</span><br><span class="line">        Assert.assertEquals(<span class="number">2</span>, search.totalHits);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">assertNoMatches</span><span class="params">(Query query)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">TopDocs</span> <span class="variable">search</span> <span class="operator">=</span> indexSearcher.search(query, <span class="number">10</span>);</span><br><span class="line">        Assert.assertEquals(<span class="number">0</span>, search.totalHits);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 输出跨度查询的结果</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> query</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">dumpSpans</span><span class="params">(SpanQuery query)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">SpanWeight</span> <span class="variable">weight</span> <span class="operator">=</span> query.createWeight(indexSearcher, <span class="literal">true</span>);</span><br><span class="line">        <span class="type">Spans</span> <span class="variable">spans</span> <span class="operator">=</span> weight.getSpans(indexReader.getContext().leaves().get(<span class="number">0</span>), SpanWeight.Postings.POSITIONS);</span><br><span class="line">        System.out.println(query);</span><br><span class="line">        <span class="type">TopDocs</span> <span class="variable">search</span> <span class="operator">=</span> indexSearcher.search(query, <span class="number">10</span>);</span><br><span class="line">        <span class="type">float</span>[] scores = <span class="keyword">new</span> <span class="title class_">float</span>[<span class="number">2</span>];</span><br><span class="line">        <span class="keyword">for</span> (ScoreDoc sd : search.scoreDocs) &#123;</span><br><span class="line">            scores[sd.doc] = sd.score;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">numSpans</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//处理所有跨度</span></span><br><span class="line">        <span class="keyword">while</span> (spans.nextDoc() != Spans.NO_MORE_DOCS) &#123;</span><br><span class="line">            <span class="keyword">while</span> (spans.nextStartPosition() != Spans.NO_MORE_POSITIONS) &#123;</span><br><span class="line">                numSpans++;</span><br><span class="line">                <span class="type">int</span> <span class="variable">id</span> <span class="operator">=</span> spans.docID();</span><br><span class="line">                <span class="comment">//检索文档</span></span><br><span class="line">                <span class="type">Document</span> <span class="variable">doc</span> <span class="operator">=</span> indexReader.document(id);</span><br><span class="line">                <span class="comment">//重新分析文本</span></span><br><span class="line">                <span class="type">TokenStream</span> <span class="variable">stream</span> <span class="operator">=</span> analyzer.tokenStream(<span class="string">&quot;contents&quot;</span>, <span class="keyword">new</span> <span class="title class_">StringReader</span>(doc.get(<span class="string">&quot;f&quot;</span>)));</span><br><span class="line">                stream.reset();</span><br><span class="line">                <span class="type">OffsetAttribute</span> <span class="variable">offsetAttribute</span> <span class="operator">=</span> stream.addAttribute(OffsetAttribute.class);</span><br><span class="line">                <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">                <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">                sb.append(<span class="string">&quot;  &quot;</span>);</span><br><span class="line">                <span class="comment">//处理所有语汇单元</span></span><br><span class="line">                <span class="keyword">while</span> (stream.incrementToken()) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (i == spans.startPosition()) &#123;</span><br><span class="line">                        sb.append(<span class="string">&quot;&lt;&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    sb.append(offsetAttribute.toString());</span><br><span class="line">                    <span class="keyword">if</span> (i + <span class="number">1</span> == spans.endPosition()) &#123;</span><br><span class="line">                        sb.append(<span class="string">&quot;&gt;&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    sb.append(<span class="string">&quot; &quot;</span>);</span><br><span class="line">                    i++;</span><br><span class="line">                &#125;</span><br><span class="line">                sb.append(<span class="string">&quot;(&quot;</span>).append(scores[id]).append(<span class="string">&quot;)&quot;</span>);</span><br><span class="line">                System.out.println(sb.toString());</span><br><span class="line">                stream.close();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (numSpans == <span class="number">0</span>) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot; No Spans&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSpanTermQuery</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        assertOnlyBrownFox(brown);</span><br><span class="line">        dumpSpans(brown);</span><br><span class="line">        dumpSpans(<span class="keyword">new</span> <span class="title class_">SpanTermQuery</span>(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">&quot;f&quot;</span>, <span class="string">&quot;the&quot;</span>)));</span><br><span class="line">        dumpSpans(<span class="keyword">new</span> <span class="title class_">SpanTermQuery</span>(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">&quot;f&quot;</span>, <span class="string">&quot;fox&quot;</span>)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * SpanFirstQuery可以对出现在域中前面某位置的跨度进行查询</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSpanFirstQuery</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">SpanFirstQuery</span> <span class="variable">spanFirstQuery</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpanFirstQuery</span>(brown, <span class="number">2</span>);</span><br><span class="line">        assertNoMatches(spanFirstQuery);</span><br><span class="line">        dumpSpans(spanFirstQuery);</span><br><span class="line">        <span class="comment">//设置从前面开始10个跨度查找brown，一个切分结果是一个跨度，使用的是空格分词器</span></span><br><span class="line">        spanFirstQuery = <span class="keyword">new</span> <span class="title class_">SpanFirstQuery</span>(brown, <span class="number">5</span>);</span><br><span class="line">        dumpSpans(spanFirstQuery);</span><br><span class="line">        assertOnlyBrownFox(spanFirstQuery);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSpanNearQuery</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        SpanQuery[] queries = <span class="keyword">new</span> <span class="title class_">SpanQuery</span>[]&#123;quick, brown, dog&#125;;</span><br><span class="line">        <span class="type">SpanNearQuery</span> <span class="variable">spanNearQuery</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpanNearQuery</span>(queries, <span class="number">0</span>, <span class="literal">true</span>);</span><br><span class="line">        assertNoMatches(spanNearQuery);</span><br><span class="line">        dumpSpans(spanNearQuery);</span><br><span class="line">        spanNearQuery = <span class="keyword">new</span> <span class="title class_">SpanNearQuery</span>(queries, <span class="number">4</span>, <span class="literal">true</span>);</span><br><span class="line">        assertNoMatches(spanNearQuery);</span><br><span class="line">        dumpSpans(spanNearQuery);</span><br><span class="line">        spanNearQuery = <span class="keyword">new</span> <span class="title class_">SpanNearQuery</span>(queries, <span class="number">5</span>, <span class="literal">true</span>);</span><br><span class="line">        assertOnlyBrownFox(spanNearQuery);</span><br><span class="line">        dumpSpans(spanNearQuery);</span><br><span class="line">        <span class="comment">//将inOrder设置为false，那么就不会考虑顺序，只要两者中间不超过三个就可以检索到</span></span><br><span class="line">        spanNearQuery = <span class="keyword">new</span> <span class="title class_">SpanNearQuery</span>(<span class="keyword">new</span> <span class="title class_">SpanQuery</span>[]&#123;lazy, fox&#125;, <span class="number">3</span>, <span class="literal">false</span>);</span><br><span class="line">        assertOnlyBrownFox(spanNearQuery);</span><br><span class="line">        dumpSpans(spanNearQuery);</span><br><span class="line">        <span class="comment">//在考虑顺序的情况下，是检索不到的</span></span><br><span class="line">        spanNearQuery = <span class="keyword">new</span> <span class="title class_">SpanNearQuery</span>(<span class="keyword">new</span> <span class="title class_">SpanQuery</span>[]&#123;lazy, fox&#125;, <span class="number">3</span>, <span class="literal">true</span>);</span><br><span class="line">        assertNoMatches(spanNearQuery);</span><br><span class="line">        dumpSpans(spanNearQuery);</span><br><span class="line">        <span class="type">PhraseQuery</span> <span class="variable">phraseQuery</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PhraseQuery</span>.Builder().add(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">&quot;f&quot;</span>, <span class="string">&quot;lazy&quot;</span>)).add(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">&quot;f&quot;</span>, <span class="string">&quot;fox&quot;</span>)).setSlop(<span class="number">4</span>).build();</span><br><span class="line">        assertNoMatches(phraseQuery);</span><br><span class="line">        <span class="type">PhraseQuery</span> <span class="variable">phraseQuery1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PhraseQuery</span>.Builder().setSlop(<span class="number">5</span>).add(phraseQuery.getTerms()[<span class="number">0</span>]).add(phraseQuery.getTerms()[<span class="number">1</span>]).build();</span><br><span class="line">        assertOnlyBrownFox(phraseQuery1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSpanNotQuery</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">//设置slop为1</span></span><br><span class="line">        <span class="type">SpanNearQuery</span> <span class="variable">quickFox</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpanNearQuery</span>(<span class="keyword">new</span> <span class="title class_">SpanQuery</span>[]&#123;quick, fox&#125;, <span class="number">1</span>, <span class="literal">true</span>);</span><br><span class="line">        assertBothFoxes(quickFox);</span><br><span class="line">        dumpSpans(quickFox);</span><br><span class="line">        <span class="comment">//第一个参数表示要包含的跨度对象，第二个参数则表示要排除的跨度对象</span></span><br><span class="line">        <span class="type">SpanNotQuery</span> <span class="variable">quickFoxDog</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpanNotQuery</span>(quickFox, dog);</span><br><span class="line">        assertBothFoxes(quickFoxDog);</span><br><span class="line">        dumpSpans(quickFoxDog);</span><br><span class="line">        <span class="comment">//下面把red排除掉，那么就只能查到一条记录</span></span><br><span class="line">        <span class="type">SpanNotQuery</span> <span class="variable">noQuickRedFox</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpanNotQuery</span>(quickFox, red);</span><br><span class="line">        assertOnlyBrownFox(noQuickRedFox);</span><br><span class="line">        dumpSpans(noQuickRedFox);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSpanOrQuery</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">SpanNearQuery</span> <span class="variable">quickFox</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpanNearQuery</span>(<span class="keyword">new</span> <span class="title class_">SpanQuery</span>[]&#123;quick, fox&#125;, <span class="number">1</span>, <span class="literal">true</span>);</span><br><span class="line">        <span class="type">SpanNearQuery</span> <span class="variable">lazyDog</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpanNearQuery</span>(<span class="keyword">new</span> <span class="title class_">SpanQuery</span>[]&#123;lazy, dog&#125;, <span class="number">0</span>, <span class="literal">true</span>);</span><br><span class="line">        <span class="type">SpanNearQuery</span> <span class="variable">sleepyCat</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpanNearQuery</span>(<span class="keyword">new</span> <span class="title class_">SpanQuery</span>[]&#123;sleepy, cat&#125;, <span class="number">0</span>, <span class="literal">true</span>);</span><br><span class="line">        <span class="type">SpanNearQuery</span> <span class="variable">quickFoxNearLazyDog</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpanNearQuery</span>(<span class="keyword">new</span> <span class="title class_">SpanQuery</span>[]&#123;quickFox, lazyDog&#125;, <span class="number">3</span>, <span class="literal">true</span>);</span><br><span class="line">        assertOnlyBrownFox(quickFoxNearLazyDog);</span><br><span class="line">        dumpSpans(quickFoxNearLazyDog);</span><br><span class="line">        <span class="type">SpanNearQuery</span> <span class="variable">quickFoxNearSleepyCat</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpanNearQuery</span>(<span class="keyword">new</span> <span class="title class_">SpanQuery</span>[]&#123;quickFox, sleepyCat&#125;, <span class="number">3</span>, <span class="literal">true</span>);</span><br><span class="line">        dumpSpans(quickFoxNearSleepyCat);</span><br><span class="line">        <span class="type">SpanOrQuery</span> <span class="variable">or</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpanOrQuery</span>(<span class="keyword">new</span> <span class="title class_">SpanQuery</span>[]&#123;quickFoxNearLazyDog, quickFoxNearSleepyCat&#125;);</span><br><span class="line">        assertBothFoxes(or);</span><br><span class="line">        dumpSpans(or);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 测试安全过滤</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSecurityFilter</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Document</span> <span class="variable">document</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Document</span>();</span><br><span class="line">        document.add(<span class="keyword">new</span> <span class="title class_">StringField</span>(<span class="string">&quot;owner&quot;</span>, <span class="string">&quot;eric&quot;</span>, Field.Store.YES));</span><br><span class="line">        document.add(<span class="keyword">new</span> <span class="title class_">TextField</span>(<span class="string">&quot;keywords&quot;</span>, <span class="string">&quot;A B of eric&quot;</span>, Field.Store.YES));</span><br><span class="line">        indexWriter.addDocument(document);</span><br><span class="line">        document = <span class="keyword">new</span> <span class="title class_">Document</span>();</span><br><span class="line">        document.add(<span class="keyword">new</span> <span class="title class_">TextField</span>(<span class="string">&quot;owner&quot;</span>, <span class="string">&quot;jobs&quot;</span>, Field.Store.YES));</span><br><span class="line">        document.add(<span class="keyword">new</span> <span class="title class_">TextField</span>(<span class="string">&quot;keywords&quot;</span>, <span class="string">&quot;A B of jobs&quot;</span>, Field.Store.YES));</span><br><span class="line">        indexWriter.addDocument(document);</span><br><span class="line">        document.add(<span class="keyword">new</span> <span class="title class_">TextField</span>(<span class="string">&quot;owner&quot;</span>, <span class="string">&quot;jack&quot;</span>, Field.Store.YES));</span><br><span class="line">        document.add(<span class="keyword">new</span> <span class="title class_">TextField</span>(<span class="string">&quot;keywords&quot;</span>, <span class="string">&quot;A B of jack&quot;</span>, Field.Store.YES));</span><br><span class="line">        indexWriter.addDocument(document);</span><br><span class="line">        indexWriter.commit();</span><br><span class="line">        <span class="type">TermQuery</span> <span class="variable">termQuery</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TermQuery</span>(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">&quot;owner&quot;</span>, <span class="string">&quot;eric&quot;</span>));</span><br><span class="line">        <span class="type">TermQuery</span> <span class="variable">termQuery1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TermQuery</span>(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">&quot;keywords&quot;</span>, <span class="string">&quot;A&quot;</span>));</span><br><span class="line">        <span class="comment">//把FILTER看做是Like即可，也就是说owner必须是eric的才允许检索到</span></span><br><span class="line">        <span class="type">Query</span> <span class="variable">query</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BooleanQuery</span>.Builder().add(termQuery1, BooleanClause.Occur.MUST).add(termQuery,</span><br><span class="line">                BooleanClause.Occur.FILTER).build();</span><br><span class="line">        System.out.println(query);</span><br><span class="line">        indexSearcher = <span class="keyword">new</span> <span class="title class_">IndexSearcher</span>(DirectoryReader.open(directory));</span><br><span class="line">        <span class="type">TopDocs</span> <span class="variable">search</span> <span class="operator">=</span> indexSearcher.search(query, <span class="number">10</span>);</span><br><span class="line">        Assert.assertEquals(<span class="number">1</span>, search.totalHits);</span><br><span class="line">        <span class="comment">//如果不加安全过滤的话，那么应该检索到三条记录</span></span><br><span class="line">        query = <span class="keyword">new</span> <span class="title class_">BooleanQuery</span>.Builder().add(termQuery1, BooleanClause.Occur.MUST).build();</span><br><span class="line">        System.out.println(query);</span><br><span class="line">        search = indexSearcher.search(query, <span class="number">10</span>);</span><br><span class="line">        Assert.assertEquals(<span class="number">3</span>, search.totalHits);</span><br><span class="line">        <span class="type">String</span> <span class="variable">keywords</span> <span class="operator">=</span> indexSearcher.doc(search.scoreDocs[<span class="number">0</span>].doc).get(<span class="string">&quot;keywords&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;使用Filter查询：&quot;</span> + keywords);</span><br><span class="line">        <span class="comment">//使用BooleanQuery可以实现同样的功能</span></span><br><span class="line">        <span class="type">BooleanQuery</span> <span class="variable">booleanQuery</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BooleanQuery</span>.Builder().add(termQuery, BooleanClause.Occur.MUST).add(termQuery1, BooleanClause.Occur.MUST).build();</span><br><span class="line">        search = indexSearcher.search(booleanQuery, <span class="number">10</span>);</span><br><span class="line">        Assert.assertEquals(<span class="number">1</span>, search.totalHits);</span><br><span class="line">        System.out.println(<span class="string">&quot;使用BooleanQuery查询：&quot;</span> + indexSearcher.doc(search.scoreDocs[<span class="number">0</span>].doc).get(<span class="string">&quot;keywords&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="禁用模糊查询和通配符查询"><a href="#禁用模糊查询和通配符查询" class="headerlink" title="禁用模糊查询和通配符查询"></a>禁用模糊查询和通配符查询</h3><p>有时候，可能不希望用户使用模糊查询或者通配符查询，这时候可以通过实现自己的QueryParser达到禁用的目的。例如</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.lucene.analysis.Analyzer;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.analysis.core.WhitespaceAnalyzer;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.queryparser.classic.ParseException;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.queryparser.classic.QueryParser;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.search.Query;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Description:禁用模糊查询和通配符查询，同样的如果希望禁用其它类型查询，只需要覆写对应的getXXXQuery方法即可</span></span><br><span class="line"><span class="comment"> * &lt;/P&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Wang Xu</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> V1.0.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> V1.0.0</span></span><br><span class="line"><span class="comment"> * WebSite: http://codepub.cn</span></span><br><span class="line"><span class="comment"> * Licence: Apache v2 License</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomQueryParser</span> <span class="keyword">extends</span> <span class="title class_">QueryParser</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CustomQueryParser</span><span class="params">(String f, Analyzer a)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(f, a);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Query <span class="title function_">getFuzzyQuery</span><span class="params">(String field, String termStr, <span class="type">float</span> minSimilarity)</span> <span class="keyword">throws</span> ParseException &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ParseException</span>(<span class="string">&quot;Fuzzy queries not allowed!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Query <span class="title function_">getWildcardQuery</span><span class="params">(String field, String termStr)</span> <span class="keyword">throws</span> ParseException &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ParseException</span>(<span class="string">&quot;Wildcard queries not allowed!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String args[])</span> <span class="keyword">throws</span> ParseException &#123;</span><br><span class="line">        <span class="type">CustomQueryParser</span> <span class="variable">customQueryParser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CustomQueryParser</span>(<span class="string">&quot;filed&quot;</span>, <span class="keyword">new</span> <span class="title class_">WhitespaceAnalyzer</span>());</span><br><span class="line">        customQueryParser.parse(<span class="string">&quot;a?t&quot;</span>);</span><br><span class="line">        customQueryParser.parse(<span class="string">&quot;junit~&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="多索引的搜索合并方法"><a href="#多索引的搜索合并方法" class="headerlink" title="多索引的搜索合并方法"></a>多索引的搜索合并方法</h3><p>如果存在多索引文件，需要如何搜索并合并搜索结果呢？此时需要使用MultiReader，通过该类的构造函数MultiReader(IndexReader… subReaders)可以接收多个IndexReader实例，而一个IndexReader实例对应一个索引文件目录，之后用该MultiReader实例初始化IndexSearcher。</p>
<p>注意，IndexReader实例是完全线程安全的，多线程可以调用其任何方法，而无需对IndexReader实例进行同步。如果你的应用需要外部同步操作，对你自己的对象进行同步，而不是Lucene的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.lucene.analysis.Analyzer;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.analysis.core.WhitespaceAnalyzer;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.document.Document;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.document.Field;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.document.StringField;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.index.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.search.IndexSearcher;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.search.ScoreDoc;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.search.TermRangeQuery;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.search.TopDocs;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.store.Directory;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.store.RAMDirectory;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.util.BytesRef;</span><br><span class="line"><span class="keyword">import</span> org.junit.After;</span><br><span class="line"><span class="keyword">import</span> org.junit.Assert;</span><br><span class="line"><span class="keyword">import</span> org.junit.Before;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Description:测试有多个索引文件的情况下，如何进行搜索并合并搜索结果</span></span><br><span class="line"><span class="comment"> * &lt;/P&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Wang Xu</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> V1.0.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> V1.0.0</span></span><br><span class="line"><span class="comment"> * WebSite: http://codepub.cn</span></span><br><span class="line"><span class="comment"> * Licence: Apache v2 License</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MultiReaderDemo</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Analyzer</span> <span class="variable">analyzer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WhitespaceAnalyzer</span>();</span><br><span class="line">    <span class="type">Directory</span> <span class="variable">aDirectory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RAMDirectory</span>();</span><br><span class="line">    <span class="type">Directory</span> <span class="variable">bDirectory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RAMDirectory</span>();</span><br><span class="line">    <span class="type">IndexWriterConfig</span> <span class="variable">aIndexWriterConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexWriterConfig</span>(analyzer);</span><br><span class="line">    <span class="type">IndexWriterConfig</span> <span class="variable">bIndexWriterConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexWriterConfig</span>(analyzer);</span><br><span class="line">    IndexWriter aIndexWriter;</span><br><span class="line">    IndexWriter bIndexWriter;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUp</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        String[] animals = &#123;<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>, <span class="string">&quot;d&quot;</span>, <span class="string">&quot;e&quot;</span>, <span class="string">&quot;f&quot;</span>, <span class="string">&quot;g&quot;</span>, <span class="string">&quot;h&quot;</span>, <span class="string">&quot;i&quot;</span>, <span class="string">&quot;j&quot;</span>, <span class="string">&quot;k&quot;</span>, <span class="string">&quot;l&quot;</span>, <span class="string">&quot;m&quot;</span>, <span class="string">&quot;n&quot;</span>, <span class="string">&quot;o&quot;</span>, <span class="string">&quot;p&quot;</span>, <span class="string">&quot;q&quot;</span>, <span class="string">&quot;r&quot;</span>, <span class="string">&quot;s&quot;</span>, <span class="string">&quot;t&quot;</span>, <span class="string">&quot;u&quot;</span>, <span class="string">&quot;v&quot;</span>, <span class="string">&quot;w&quot;</span>, <span class="string">&quot;x&quot;</span>, <span class="string">&quot;y&quot;</span>, <span class="string">&quot;z&quot;</span>&#125;;</span><br><span class="line">        aIndexWriter = <span class="keyword">new</span> <span class="title class_">IndexWriter</span>(aDirectory, aIndexWriterConfig);</span><br><span class="line">        bIndexWriter = <span class="keyword">new</span> <span class="title class_">IndexWriter</span>(bDirectory, bIndexWriterConfig);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; animals.length; i++) &#123;</span><br><span class="line">            <span class="type">Document</span> <span class="variable">document</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Document</span>();</span><br><span class="line">            <span class="type">String</span> <span class="variable">animal</span> <span class="operator">=</span> animals[i];</span><br><span class="line">            document.add(<span class="keyword">new</span> <span class="title class_">StringField</span>(<span class="string">&quot;animal&quot;</span>, animal, Field.Store.YES));</span><br><span class="line">            <span class="keyword">if</span> (animal.charAt(<span class="number">0</span>) &lt; <span class="string">&#x27;n&#x27;</span>) &#123;</span><br><span class="line">                aIndexWriter.addDocument(document);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                bIndexWriter.addDocument(document);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        aIndexWriter.commit();</span><br><span class="line">        bIndexWriter.commit();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDown</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (aIndexWriter != <span class="literal">null</span> &amp;&amp; aIndexWriter.isOpen()) &#123;</span><br><span class="line">                aIndexWriter.close();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (bIndexWriter != <span class="literal">null</span> &amp;&amp; bIndexWriter.isOpen()) &#123;</span><br><span class="line">                bIndexWriter.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testMultiReader</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">IndexReader</span> <span class="variable">aIndexReader</span> <span class="operator">=</span> DirectoryReader.open(aDirectory);</span><br><span class="line">        <span class="type">IndexReader</span> <span class="variable">bIndexReader</span> <span class="operator">=</span> DirectoryReader.open(bDirectory);</span><br><span class="line">        <span class="type">MultiReader</span> <span class="variable">multiReader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MultiReader</span>(aIndexReader, bIndexReader);</span><br><span class="line">        <span class="type">IndexSearcher</span> <span class="variable">indexSearcher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexSearcher</span>(multiReader);</span><br><span class="line">        <span class="type">TopDocs</span> <span class="variable">animal</span> <span class="operator">=</span> indexSearcher.search(<span class="keyword">new</span> <span class="title class_">TermRangeQuery</span>(<span class="string">&quot;animal&quot;</span>, <span class="keyword">new</span> <span class="title class_">BytesRef</span>(<span class="string">&quot;h&quot;</span>), <span class="keyword">new</span> <span class="title class_">BytesRef</span>(<span class="string">&quot;q&quot;</span>), <span class="literal">true</span>, <span class="literal">true</span>), <span class="number">10</span>);</span><br><span class="line">        Assert.assertEquals(<span class="number">10</span>, animal.totalHits);</span><br><span class="line">        ScoreDoc[] scoreDocs = animal.scoreDocs;</span><br><span class="line">        <span class="keyword">for</span> (ScoreDoc sd : scoreDocs) &#123;</span><br><span class="line">            System.out.println(indexSearcher.doc(sd.doc));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Document&lt;stored,indexed,tokenized,omitNorms,indexOptions=DOCS&lt;animal:h&gt;&gt;</span><br><span class="line">Document&lt;stored,indexed,tokenized,omitNorms,indexOptions=DOCS&lt;animal:i&gt;&gt;</span><br><span class="line">Document&lt;stored,indexed,tokenized,omitNorms,indexOptions=DOCS&lt;animal:j&gt;&gt;</span><br><span class="line">Document&lt;stored,indexed,tokenized,omitNorms,indexOptions=DOCS&lt;animal:k&gt;&gt;</span><br><span class="line">Document&lt;stored,indexed,tokenized,omitNorms,indexOptions=DOCS&lt;animal:l&gt;&gt;</span><br><span class="line">Document&lt;stored,indexed,tokenized,omitNorms,indexOptions=DOCS&lt;animal:m&gt;&gt;</span><br><span class="line">Document&lt;stored,indexed,tokenized,omitNorms,indexOptions=DOCS&lt;animal:n&gt;&gt;</span><br><span class="line">Document&lt;stored,indexed,tokenized,omitNorms,indexOptions=DOCS&lt;animal:o&gt;&gt;</span><br><span class="line">Document&lt;stored,indexed,tokenized,omitNorms,indexOptions=DOCS&lt;animal:p&gt;&gt;</span><br><span class="line">Document&lt;stored,indexed,tokenized,omitNorms,indexOptions=DOCS&lt;animal:q&gt;&gt;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/page/31/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/31/">31</a><span class="page-number current">32</span><a class="page-number" href="/page/33/">33</a><span class="space">&hellip;</span><a class="page-number" href="/page/55/">55</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/33/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">DJY</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
