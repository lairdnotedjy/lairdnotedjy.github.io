<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="baidu-site-verification" content="codeva-6wmKWl5hmx" />
<meta name="bytedance-verification-code" content="GcOf/MpQ8shZ5Hh/2hvr" />
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.1.1">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-33RJLY0818"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-33RJLY0818');
</script>

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha256-yIDrPSXHZdOZhAqiBP7CKzIwMQmRCJ8UeB8Jo17YC4o=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.sovdating.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.19.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="背景如果把这个标题拆分成两个来讲，那么每一个都很好解决，下文会进行详述，而如果把这两者看做是与条件并加上其它限制，则实现起来比较困难，本文就是要探讨在需求繁多的情况下，如何优雅地实现。比如需求如下  保留标点符号，否则去掉标点的话，在标点两边的词可能会匹配上，比如“你好，小甜甜”，去掉标点切分是『你|好|小|甜|甜』，那么『好小』有可能会命中，而如果切分成『你|好|，|小|甜|甜』，则『好小』无法">
<meta property="og:type" content="article">
<meta property="og:title" content="Lucene 实现任意词搜索命中并返回位置信息">
<meta property="og:url" content="https://www.sovdating.com/lucene-implements-any-word-search-and-returns-location-information/index.html">
<meta property="og:site_name" content="Sovdating Linux">
<meta property="og:description" content="背景如果把这个标题拆分成两个来讲，那么每一个都很好解决，下文会进行详述，而如果把这两者看做是与条件并加上其它限制，则实现起来比较困难，本文就是要探讨在需求繁多的情况下，如何优雅地实现。比如需求如下  保留标点符号，否则去掉标点的话，在标点两边的词可能会匹配上，比如“你好，小甜甜”，去掉标点切分是『你|好|小|甜|甜』，那么『好小』有可能会命中，而如果切分成『你|好|，|小|甜|甜』，则『好小』无法">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2017-10-13T22:29:56.000Z">
<meta property="article:modified_time" content="2024-01-26T12:42:20.272Z">
<meta property="article:author" content="DJY">
<meta property="article:tag" content="Lucene">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://www.sovdating.com/lucene-implements-any-word-search-and-returns-location-information/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://www.sovdating.com/lucene-implements-any-word-search-and-returns-location-information/","path":"lucene-implements-any-word-search-and-returns-location-information/","title":"Lucene 实现任意词搜索命中并返回位置信息"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Lucene 实现任意词搜索命中并返回位置信息 | Sovdating Linux</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Sovdating Linux</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">some code for program</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>Sitemap</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%83%8C%E6%99%AF"><span class="nav-number">1.</span> <span class="nav-text">背景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%80%E5%8D%95%E9%9C%80%E6%B1%82%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="nav-number">2.</span> <span class="nav-text">简单需求的实现</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%85%E8%A6%81%E6%B1%82%E4%BB%BB%E6%84%8F%E6%90%9C%E7%B4%A2%E8%AF%8D%E5%91%BD%E4%B8%AD"><span class="nav-number">2.1.</span> <span class="nav-text">仅要求任意搜索词命中</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%AF%E4%BB%A5%E5%AD%98%E5%82%A8Field%E7%9A%84%E5%80%BC"><span class="nav-number">2.2.</span> <span class="nav-text">可以存储Field的值</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%AF%E4%BB%A5%E5%AD%98%E5%82%A8TermVectors%E7%9A%84%E5%80%BC"><span class="nav-number">2.3.</span> <span class="nav-text">可以存储TermVectors的值</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%8D%E6%9D%82%E9%9C%80%E6%B1%82%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="nav-number">3.</span> <span class="nav-text">复杂需求的实现</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BF%9D%E7%95%99%E6%A0%87%E7%82%B9%E7%AC%A6%E5%8F%B7%E7%9A%84%E5%88%86%E8%AF%8D%E5%99%A8"><span class="nav-number">3.1.</span> <span class="nav-text">保留标点符号的分词器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%BB%E6%84%8F%E8%AF%8D%E6%90%9C%E7%B4%A2%E5%91%BD%E4%B8%AD%E5%B9%B6%E8%BF%94%E5%9B%9Epositions%E4%BF%A1%E6%81%AF"><span class="nav-number">3.2.</span> <span class="nav-text">任意词搜索命中并返回positions信息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E9%80%BB%E8%BE%91%E4%B8%8E%E6%9F%A5%E8%AF%A2"><span class="nav-number">3.3.</span> <span class="nav-text">实现逻辑与查询</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E9%80%BB%E8%BE%91%E6%88%96%E6%9F%A5%E8%AF%A2"><span class="nav-number">3.4.</span> <span class="nav-text">实现逻辑或查询</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0SpanAllNearQuery"><span class="nav-number">4.</span> <span class="nav-text">实现SpanAllNearQuery</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SpanNearQuery%E5%AE%9E%E7%8E%B0%E9%80%9A%E9%85%8D%E7%AC%A6%E6%9F%A5%E8%AF%A2"><span class="nav-number">5.</span> <span class="nav-text">SpanNearQuery实现通配符查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E9%AA%8C"><span class="nav-number">6.</span> <span class="nav-text">实验</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">DJY</p>
  <div class="site-description" itemprop="description">Hello dev</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">554</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">94</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">389</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://www.sovdating.com/lucene-implements-any-word-search-and-returns-location-information/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="DJY">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sovdating Linux">
      <meta itemprop="description" content="Hello dev">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Lucene 实现任意词搜索命中并返回位置信息 | Sovdating Linux">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Lucene 实现任意词搜索命中并返回位置信息
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-10-13 22:29:56" itemprop="dateCreated datePublished" datetime="2017-10-13T22:29:56+00:00">2017-10-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-01-26 12:42:20" itemprop="dateModified" datetime="2024-01-26T12:42:20+00:00">2024-01-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Programming-Notes/" itemprop="url" rel="index"><span itemprop="name">Programming Notes</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>如果把这个标题拆分成两个来讲，那么每一个都很好解决，下文会进行详述，而如果把这两者看做是与条件并加上其它限制，则实现起来比较困难，本文就是要探讨在需求繁多的情况下，如何优雅地实现。比如需求如下</p>
<ul>
<li>保留标点符号，否则去掉标点的话，在标点两边的词可能会匹配上，比如“你好，小甜甜”，去掉标点切分是『你|好|小|甜|甜』，那么『好小』有可能会命中，而如果切分成『你|好|，|小|甜|甜』，则『好小』无法命中</li>
<li>只要包含搜索词，要求对任意搜索词均可命中<ul>
<li>比如“我爱你中国”，不同的分词工具会切分出不同的结果</li>
<li>『我|爱|你|中国』或者『我爱你|中国』或者『我|爱|你|中|国』等，那么要求搜索“我爱”或者“爱你”或者“你中”等都要命中</li>
</ul>
</li>
<li>需要获取命中词的positions信息<ul>
<li>还是以“我爱你中国”为例，如果搜“你中”，那么需要返回结果命中，并给出positions信息，例如start&#x3D;2表示“你中”在原文本中是从第2个位置开始</li>
</ul>
</li>
<li>可以设置slop<ul>
<li>什么是slop，简单来说slop是指两个项的位置之间允许的最大间隔距离</li>
<li>为什么要设置slop呢？比如小黄文为了防止敏感词被屏蔽，会在敏感词中间加上干扰词，例如<code>性%=$虐待</code>，那么直接搜<code>性虐待</code>无法命中</li>
<li>只要设置slop为3，即相当于搜<code>性[***]虐待</code>，这里面的<code>[***]</code>就代表slop为3，可以匹配任意三个字</li>
</ul>
</li>
<li>不要存储Field的值<ul>
<li>如果可以存储的话，可以通过Document获取原文本，再用TokenStream分析该文本，使用QueryScore初始化TokenStream的分析结果，遍历每个token根据TokenScore的得分判断是否命中，若命中则输出位置信息或者起始偏移量即可</li>
<li>但是存储Field的值是需要占用硬盘空间的，当需要索引海量的文本的时候，会导致索引体积非常大，搜索性能变差</li>
<li>当然还可以通过将索引拆分成多份存储实现降低索引体积的目的，这也是一个方法，不过治标不治本</li>
</ul>
</li>
<li>不要存储TermVectors<ul>
<li>同样地如果可以存储的话，可以通过TermVectors获取Terms再遍历TermsEnum，获取PostingsEnum得到positions信息，缺点在于只能实现单个字（Term）的搜索匹配</li>
<li>但是存储TermVectors同样占用硬盘空间，为了缩小索引体积，不要存储</li>
</ul>
</li>
<li>实现与逻辑，比如搜索“你中 &amp; 我爱”表示两个词都要命中</li>
<li>实现或逻辑，比如搜索“你中 | 我爱”表示两个词至少要有一个命中</li>
</ul>
<p>如果想要实现百分之百的任意词搜索命中，那么只能按字切分，因为没有任何分词工具能够保证切出来的词与搜索词是一致的。在上面说到为了达到匹配干扰词的目的，需要设置slop，但是会有一定的误判率，本来不该匹配的在设置slop之后也匹配上了。除了设置slop这种方式，还有一种方法，就是在索引阶段只保留汉字，其它的标点符号和干扰符号统统去掉，当然这也存在一定的误判率，而且获取的positions信息已经不是原文本中正确的positions信息了。两种方式的权衡与取舍可以根据业务需求而定，这两种方式都不会漏判，但是均会有误判。</p>
<h3 id="简单需求的实现"><a href="#简单需求的实现" class="headerlink" title="简单需求的实现"></a>简单需求的实现</h3><p>如果并不要求满足上面所有的需求，而仅仅满足其中任何一个，那么实现起来都是非常简单的，以下代码均基于Lucene 5.5.0实现，示例如下。</p>
<h4 id="仅要求任意搜索词命中"><a href="#仅要求任意搜索词命中" class="headerlink" title="仅要求任意搜索词命中"></a>仅要求任意搜索词命中</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@org</span>.junit.Test</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testAnyMatch</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">RAMDirectory</span> <span class="variable">ramDirectory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RAMDirectory</span>();</span><br><span class="line">    <span class="type">IndexWriter</span> <span class="variable">indexWriter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexWriter</span>(ramDirectory, <span class="keyword">new</span> <span class="title class_">IndexWriterConfig</span>(<span class="keyword">new</span> <span class="title class_">StandardAnalyzer</span>()));</span><br><span class="line">    <span class="type">Document</span> <span class="variable">document</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Document</span>();</span><br><span class="line">    document.add(<span class="keyword">new</span> <span class="title class_">TextField</span>(<span class="string">&quot;content&quot;</span>, <span class="string">&quot;我爱你中国&quot;</span>, Field.Store.NO));</span><br><span class="line">    indexWriter.addDocument(document);</span><br><span class="line">    indexWriter.commit();</span><br><span class="line">    <span class="type">IndexSearcher</span> <span class="variable">indexSearcher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexSearcher</span>(DirectoryReader.open(indexWriter));</span><br><span class="line">    <span class="type">PhraseQuery</span> <span class="variable">phraseQuery</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PhraseQuery</span>.Builder().add(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">&quot;content&quot;</span>, <span class="string">&quot;你&quot;</span>)).add(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">&quot;content&quot;</span>, <span class="string">&quot;中&quot;</span>)).setSlop(<span class="number">0</span>).build();</span><br><span class="line">    <span class="type">TopDocs</span> <span class="variable">search</span> <span class="operator">=</span> indexSearcher.search(phraseQuery, Integer.MAX_VALUE);</span><br><span class="line">    System.out.println(search.totalHits);</span><br><span class="line">    <span class="comment">//OR search like this</span></span><br><span class="line">    <span class="type">MultiPhraseQuery</span> <span class="variable">multiPhraseQuery</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MultiPhraseQuery</span>();</span><br><span class="line">    <span class="type">Term</span> <span class="variable">first</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">&quot;content&quot;</span>, <span class="string">&quot;你&quot;</span>);</span><br><span class="line">    <span class="type">Term</span> <span class="variable">second</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">&quot;content&quot;</span>, <span class="string">&quot;中&quot;</span>);</span><br><span class="line">    multiPhraseQuery.add(<span class="keyword">new</span> <span class="title class_">Term</span>[]&#123;first, second&#125;);</span><br><span class="line">    search = indexSearcher.search(multiPhraseQuery, Integer.MAX_VALUE);</span><br><span class="line">    System.out.println(search.totalHits);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="可以存储Field的值"><a href="#可以存储Field的值" class="headerlink" title="可以存储Field的值"></a>可以存储Field的值</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@org</span>.junit.Test</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testStoreFieldMatch</span><span class="params">()</span> <span class="keyword">throws</span> IOException, InvalidTokenOffsetsException &#123;</span><br><span class="line">    <span class="type">RAMDirectory</span> <span class="variable">ramDirectory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RAMDirectory</span>();</span><br><span class="line">    <span class="type">IndexWriter</span> <span class="variable">indexWriter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexWriter</span>(ramDirectory, <span class="keyword">new</span> <span class="title class_">IndexWriterConfig</span>(<span class="keyword">new</span> <span class="title class_">StandardAnalyzer</span>()));</span><br><span class="line">    <span class="type">Document</span> <span class="variable">document</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Document</span>();</span><br><span class="line">    document.add(<span class="keyword">new</span> <span class="title class_">TextField</span>(<span class="string">&quot;content&quot;</span>, <span class="string">&quot;我爱你中国&quot;</span>, Field.Store.YES));</span><br><span class="line">    indexWriter.addDocument(document);</span><br><span class="line">    indexWriter.commit();</span><br><span class="line">    <span class="type">IndexSearcher</span> <span class="variable">indexSearcher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexSearcher</span>(DirectoryReader.open(indexWriter));</span><br><span class="line">    <span class="type">PhraseQuery</span> <span class="variable">phraseQuery</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PhraseQuery</span>.Builder().add(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">&quot;content&quot;</span>, <span class="string">&quot;你&quot;</span>)).add(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">&quot;content&quot;</span>, <span class="string">&quot;中&quot;</span>)).setSlop(<span class="number">0</span>).build();</span><br><span class="line">    <span class="type">TopDocs</span> <span class="variable">search</span> <span class="operator">=</span> indexSearcher.search(phraseQuery, Integer.MAX_VALUE);</span><br><span class="line">    ScoreDoc[] scoreDocs = search.scoreDocs;</span><br><span class="line">    <span class="keyword">for</span> (ScoreDoc scoreDoc : scoreDocs) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> indexSearcher.doc(scoreDoc.doc).get(<span class="string">&quot;content&quot;</span>);</span><br><span class="line">        <span class="type">TokenStream</span> <span class="variable">contentStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StandardAnalyzer</span>().tokenStream(<span class="string">&quot;content&quot;</span>, content);</span><br><span class="line">        <span class="type">CharTermAttribute</span> <span class="variable">charTermAttribute</span> <span class="operator">=</span> contentStream.addAttribute(CharTermAttribute.class);</span><br><span class="line">        <span class="type">OffsetAttribute</span> <span class="variable">offsetAttribute</span> <span class="operator">=</span> contentStream.addAttribute(OffsetAttribute.class);</span><br><span class="line">        <span class="type">QueryScorer</span> <span class="variable">queryScorer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QueryScorer</span>(phraseQuery);</span><br><span class="line">        queryScorer.setMaxDocCharsToAnalyze(Integer.MAX_VALUE);</span><br><span class="line">        <span class="type">TokenStream</span> <span class="variable">init</span> <span class="operator">=</span> queryScorer.init(contentStream);</span><br><span class="line">        <span class="keyword">if</span> (init != <span class="literal">null</span>) &#123;</span><br><span class="line">            contentStream = init;</span><br><span class="line">        &#125;</span><br><span class="line">        contentStream.reset();</span><br><span class="line">        queryScorer.startFragment(<span class="literal">null</span>);</span><br><span class="line">        <span class="type">int</span> startOffset, endOffset;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">boolean</span> <span class="variable">next</span> <span class="operator">=</span> contentStream.incrementToken(); next &amp;&amp; (offsetAttribute.startOffset() &lt; Integer.MAX_VALUE); next = contentStream.incrementToken()) &#123;</span><br><span class="line">            startOffset = offsetAttribute.startOffset();</span><br><span class="line">            endOffset = offsetAttribute.endOffset();</span><br><span class="line">            <span class="keyword">if</span> (startOffset &gt; content.length() || endOffset &gt; content.length()) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidTokenOffsetsException</span>(<span class="string">&quot;Token &quot;</span> + charTermAttribute.toString() + <span class="string">&quot; exceeds length of provided text sized &quot;</span> + content.length());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">float</span> <span class="variable">res</span> <span class="operator">=</span> queryScorer.getTokenScore();</span><br><span class="line">            <span class="keyword">if</span> (res &gt; Float.valueOf(<span class="number">0</span>) &amp;&amp; startOffset &lt;= endOffset) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;hits: &quot;</span> + content.substring(startOffset, endOffset) + <span class="string">&quot;, start: &quot;</span> + startOffset);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        contentStream.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="可以存储TermVectors的值"><a href="#可以存储TermVectors的值" class="headerlink" title="可以存储TermVectors的值"></a>可以存储TermVectors的值</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@org</span>.junit.Test</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testTermVectorsMatch</span><span class="params">()</span> <span class="keyword">throws</span> IOException, InvalidTokenOffsetsException &#123;</span><br><span class="line">    <span class="type">RAMDirectory</span> <span class="variable">ramDirectory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RAMDirectory</span>();</span><br><span class="line">    <span class="type">IndexWriter</span> <span class="variable">indexWriter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexWriter</span>(ramDirectory, <span class="keyword">new</span> <span class="title class_">IndexWriterConfig</span>(<span class="keyword">new</span> <span class="title class_">StandardAnalyzer</span>()));</span><br><span class="line">    <span class="type">Document</span> <span class="variable">document</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Document</span>();</span><br><span class="line">    <span class="type">FieldType</span> <span class="variable">fieldType</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FieldType</span>();</span><br><span class="line">    fieldType.setIndexOptions(IndexOptions.DOCS_AND_FREQS_AND_POSITIONS_AND_OFFSETS);</span><br><span class="line">    fieldType.setStoreTermVectorPositions(<span class="literal">true</span>);</span><br><span class="line">    fieldType.setStoreTermVectors(<span class="literal">true</span>);</span><br><span class="line">    document.add(<span class="keyword">new</span> <span class="title class_">Field</span>(<span class="string">&quot;content&quot;</span>, <span class="string">&quot;我爱你中国&quot;</span>, fieldType));</span><br><span class="line">    indexWriter.addDocument(document);</span><br><span class="line">    indexWriter.commit();</span><br><span class="line">    <span class="type">IndexSearcher</span> <span class="variable">indexSearcher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexSearcher</span>(DirectoryReader.open(indexWriter));</span><br><span class="line">    <span class="type">Term</span> <span class="variable">searchTerm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">&quot;content&quot;</span>, <span class="string">&quot;中&quot;</span>);</span><br><span class="line">    <span class="type">PhraseQuery</span> <span class="variable">phraseQuery</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PhraseQuery</span>.Builder().add(searchTerm).setSlop(<span class="number">0</span>).build();</span><br><span class="line">    <span class="type">TopDocs</span> <span class="variable">search</span> <span class="operator">=</span> indexSearcher.search(phraseQuery, Integer.MAX_VALUE);</span><br><span class="line">    ScoreDoc[] scoreDocs = search.scoreDocs;</span><br><span class="line">    <span class="keyword">for</span> (ScoreDoc scoreDoc : scoreDocs) &#123;</span><br><span class="line">        <span class="type">Terms</span> <span class="variable">content</span> <span class="operator">=</span> indexSearcher.getIndexReader().getTermVector(scoreDoc.doc, <span class="string">&quot;content&quot;</span>);</span><br><span class="line">        <span class="type">TermsEnum</span> <span class="variable">iterator</span> <span class="operator">=</span> content.iterator();</span><br><span class="line">        BytesRef bytesRef;</span><br><span class="line">        <span class="keyword">while</span> ((bytesRef = iterator.next()) != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">PostingsEnum</span> <span class="variable">postings</span> <span class="operator">=</span> iterator.postings(<span class="literal">null</span>, PostingsEnum.ALL);</span><br><span class="line">            <span class="keyword">if</span> (postings.nextDoc() != Spans.NO_MORE_DOCS) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; postings.freq(); i++) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (searchTerm.text().equals(bytesRef.utf8ToString())) &#123;</span><br><span class="line">                        System.out.println(<span class="string">&quot;hits: &quot;</span> + bytesRef.utf8ToString() + <span class="string">&quot;, start: &quot;</span> + postings.nextPosition());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="复杂需求的实现"><a href="#复杂需求的实现" class="headerlink" title="复杂需求的实现"></a>复杂需求的实现</h3><p>实现某一个简单的需求就不再举例了，下面要讲解如何实现复杂的需求，也就是说，要同时满足上面的需求列表，而不仅仅是只满足其中的某一条。首先需要解决的就是分词之后保留标点符号的问题，在Lucene中，我并没有找到原生的支持保留标点符号的Analyzer，于是只能自己造轮子了。</p>
<h4 id="保留标点符号的分词器"><a href="#保留标点符号的分词器" class="headerlink" title="保留标点符号的分词器"></a>保留标点符号的分词器</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.extern.log4j.Log4j2;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.analysis.Analyzer;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.analysis.TokenStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.analysis.Tokenizer;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.analysis.core.LowerCaseFilter;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.analysis.pattern.PatternTokenizer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.regex.Pattern;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Log4j2</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReservePunctuationAnalyzer</span> <span class="keyword">extends</span> <span class="title class_">Analyzer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ReservePunctuationAnalyzer</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> TokenStreamComponents <span class="title function_">createComponents</span><span class="params">(String fieldName)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> Tokenizer source;</span><br><span class="line">        source = <span class="keyword">new</span> <span class="title class_">PatternTokenizer</span>(Pattern.compile(<span class="string">&quot;&quot;</span>), -<span class="number">1</span>);</span><br><span class="line">        <span class="type">TokenStream</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LowerCaseFilter</span>(source);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TokenStreamComponents</span>(source, result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>分词测试如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">input</span> <span class="operator">=</span> <span class="string">&quot;你好，小甜甜。&quot;</span>;</span><br><span class="line">    <span class="type">TokenStream</span> <span class="variable">test</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReservePunctuationAnalyzer</span>().tokenStream(<span class="string">&quot;test&quot;</span>, input);</span><br><span class="line">    <span class="type">CharTermAttribute</span> <span class="variable">charTermAttribute</span> <span class="operator">=</span> test.addAttribute(CharTermAttribute.class);</span><br><span class="line">    <span class="type">OffsetAttribute</span> <span class="variable">offsetAttribute</span> <span class="operator">=</span> test.addAttribute(OffsetAttribute.class);</span><br><span class="line">    test.reset();</span><br><span class="line">    <span class="keyword">while</span> (test.incrementToken()) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;token:[&quot;</span> + charTermAttribute + <span class="string">&quot;], offset:[&quot;</span> + offsetAttribute.startOffset() + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    test.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>分词结果输出如下</p>
<blockquote>
<p>token:[你], offset:[0]<br>token:[好], offset:[1]<br>token:[，], offset:[2]<br>token:[小], offset:[3]<br>token:[甜], offset:[4]<br>token:[甜], offset:[5]<br>token:[。], offset:[6]</p>
</blockquote>
<h4 id="任意词搜索命中并返回positions信息"><a href="#任意词搜索命中并返回positions信息" class="headerlink" title="任意词搜索命中并返回positions信息"></a>任意词搜索命中并返回positions信息</h4><p>下面再来解决在不存储Field、不存储TermVectors的情况下，如何实现任意词搜索命中并返回positions信息，同时还可以设置slop的值。要实现这些功能就需要用到SpanQuery及其一系列的子类，先来看一张继承关系图，这些都是即将要使用到的类。</p>
<div align=center>
[![SpanQuery And Subclasses](https://raw.githubusercontent.com/shijiebei2009/img/master/blog/spanquery_and_subclasses.jpg "SpanQuery And Subclasses")](https://raw.githubusercontent.com/shijiebei2009/img/master/blog/spanquery_and_subclasses.jpg "SpanQuery And Subclasses")
</div>

<p>SpanQuery的doc注释很简单，就一句话“Base class for span-based queries”，基于跨度查询的基类。而真正具有实际作用的是其各个子类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.lucene.document.Document;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.document.Field;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.document.FieldType;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.document.LongField;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.index.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.search.IndexSearcher;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.search.spans.SpanNearQuery;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.search.spans.SpanTermQuery;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.search.spans.SpanWeight;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.search.spans.Spans;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.store.RAMDirectory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.apache.lucene.search.spans.SpanNearQuery.newOrderedNearQuery;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * Created by wangxu on 2017/10/13 14:29.</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * Description: TODO</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Wang Xu</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> V1.0.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> V1.0.0 &lt;br/&gt;</span></span><br><span class="line"><span class="comment"> * WebSite: http://codepub.cn &lt;br&gt;</span></span><br><span class="line"><span class="comment"> * Licence: Apache v2 License</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpanNearQueryDemo</span> &#123;</span><br><span class="line">    <span class="meta">@org</span>.junit.Test</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">input</span> <span class="operator">=</span> <span class="string">&quot;现有的中文分词算法可分为三大类：基于字符串匹配的类基分词方法、基于理解的分词方法和基于统计的分词方法。&quot;</span>;</span><br><span class="line">        <span class="type">RAMDirectory</span> <span class="variable">ramDirectory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RAMDirectory</span>();</span><br><span class="line">        <span class="type">IndexWriterConfig</span> <span class="variable">indexWriterConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexWriterConfig</span>(<span class="keyword">new</span> <span class="title class_">ReservePunctuationAnalyzer</span>());</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">IndexWriter</span> <span class="variable">indexWriter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexWriter</span>(ramDirectory, indexWriterConfig)) &#123;</span><br><span class="line">            <span class="type">Document</span> <span class="variable">document</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Document</span>();</span><br><span class="line">            <span class="type">FieldType</span> <span class="variable">fieldType</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FieldType</span>();</span><br><span class="line">            fieldType.setIndexOptions(IndexOptions.DOCS_AND_FREQS_AND_POSITIONS);</span><br><span class="line">            <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Field</span>(<span class="string">&quot;title&quot;</span>, input, fieldType);</span><br><span class="line">            <span class="type">LongField</span> <span class="variable">IDX</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LongField</span>(<span class="string">&quot;IDX&quot;</span>, <span class="number">1</span>, Field.Store.YES);</span><br><span class="line">            document.add(field);</span><br><span class="line">            document.add(IDX);</span><br><span class="line">            indexWriter.addDocument(document);</span><br><span class="line"></span><br><span class="line">            input = <span class="string">&quot;计算机算法是很难很复杂滴&quot;</span>;</span><br><span class="line">            document = <span class="keyword">new</span> <span class="title class_">Document</span>();</span><br><span class="line">            field = <span class="keyword">new</span> <span class="title class_">Field</span>(<span class="string">&quot;title&quot;</span>, input, fieldType);</span><br><span class="line">            IDX = <span class="keyword">new</span> <span class="title class_">LongField</span>(<span class="string">&quot;IDX&quot;</span>, <span class="number">2</span>, Field.Store.YES);</span><br><span class="line">            document.add(field);</span><br><span class="line">            document.add(IDX);</span><br><span class="line">            indexWriter.addDocument(document);</span><br><span class="line"></span><br><span class="line">            input = <span class="string">&quot;计算机算法可以大幅度提升程序性能&quot;</span>;</span><br><span class="line">            document = <span class="keyword">new</span> <span class="title class_">Document</span>();</span><br><span class="line">            field = <span class="keyword">new</span> <span class="title class_">Field</span>(<span class="string">&quot;title&quot;</span>, input, fieldType);</span><br><span class="line">            IDX = <span class="keyword">new</span> <span class="title class_">LongField</span>(<span class="string">&quot;IDX&quot;</span>, <span class="number">3</span>, Field.Store.YES);</span><br><span class="line">            document.add(field);</span><br><span class="line">            document.add(IDX);</span><br><span class="line">            indexWriter.addDocument(document);</span><br><span class="line">            indexWriter.commit();</span><br><span class="line"></span><br><span class="line">            <span class="type">IndexSearcher</span> <span class="variable">indexSearcher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexSearcher</span>(DirectoryReader.open(ramDirectory));</span><br><span class="line">            <span class="type">SpanTermQuery</span> <span class="variable">first</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpanTermQuery</span>(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">&quot;title&quot;</span>, <span class="string">&quot;类&quot;</span>));</span><br><span class="line">            <span class="type">SpanTermQuery</span> <span class="variable">second</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpanTermQuery</span>(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">&quot;title&quot;</span>, <span class="string">&quot;基&quot;</span>));</span><br><span class="line">            <span class="type">SpanNearQuery</span> <span class="variable">spanNearQuery</span> <span class="operator">=</span> newOrderedNearQuery(<span class="string">&quot;title&quot;</span>).addClause(first).addClause(second).build();</span><br><span class="line">            <span class="type">SpanWeight</span> <span class="variable">weight</span> <span class="operator">=</span> spanNearQuery.createWeight(indexSearcher, <span class="literal">true</span>);</span><br><span class="line">            List&lt;LeafReaderContext&gt; leaves = indexSearcher.getIndexReader().getContext().leaves();</span><br><span class="line">            <span class="keyword">for</span> (LeafReaderContext leaf : leaves) &#123;</span><br><span class="line">                <span class="type">Spans</span> <span class="variable">spans</span> <span class="operator">=</span> weight.getSpans(leaf, SpanWeight.Postings.POSITIONS);</span><br><span class="line">                <span class="keyword">while</span> (spans.nextDoc() != Spans.NO_MORE_DOCS) &#123;</span><br><span class="line">                    <span class="type">Document</span> <span class="variable">doc</span> <span class="operator">=</span> leaf.reader().document(spans.docID());</span><br><span class="line">                    <span class="keyword">while</span> (spans.nextStartPosition() != Spans.NO_MORE_POSITIONS) &#123;</span><br><span class="line">                        System.out.println(<span class="string">&quot;doc id = &quot;</span> + spans.docID() + <span class="string">&quot;, doc IDX= &quot;</span> + doc.get(<span class="string">&quot;IDX&quot;</span>) + <span class="string">&quot;, start position = &quot;</span> + spans.startPosition() + <span class="string">&quot;, end &quot;</span> +</span><br><span class="line">                                <span class="string">&quot;position = &quot;</span> + spans.endPosition());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//================================================================</span></span><br><span class="line">            <span class="comment">// 输出结果是</span></span><br><span class="line">            <span class="comment">// doc id = 0, doc IDX= 1, start position = 24, end position = 26</span></span><br><span class="line">            <span class="comment">//================================================================</span></span><br><span class="line">            System.out.println();</span><br><span class="line">            <span class="comment">//修改slop，设置1，默认是0</span></span><br><span class="line">            spanNearQuery = newOrderedNearQuery(<span class="string">&quot;title&quot;</span>).addClause(first).addClause(second).setSlop(<span class="number">1</span>).build();</span><br><span class="line">            weight = spanNearQuery.createWeight(indexSearcher, <span class="literal">true</span>);</span><br><span class="line">            leaves = indexSearcher.getIndexReader().getContext().leaves();</span><br><span class="line">            <span class="keyword">for</span> (LeafReaderContext leaf : leaves) &#123;</span><br><span class="line">                <span class="type">Spans</span> <span class="variable">spans</span> <span class="operator">=</span> weight.getSpans(leaf, SpanWeight.Postings.POSITIONS);</span><br><span class="line">                <span class="keyword">while</span> (spans.nextDoc() != spans.NO_MORE_DOCS) &#123;</span><br><span class="line">                    <span class="type">Document</span> <span class="variable">doc</span> <span class="operator">=</span> leaf.reader().document(spans.docID());</span><br><span class="line">                    <span class="keyword">while</span> (spans.nextStartPosition() != spans.NO_MORE_POSITIONS) &#123;</span><br><span class="line">                        System.out.println(<span class="string">&quot;doc id = &quot;</span> + spans.docID() + <span class="string">&quot;, doc IDX= &quot;</span> + doc.get(<span class="string">&quot;IDX&quot;</span>) + <span class="string">&quot;, start position = &quot;</span> + spans.startPosition() + <span class="string">&quot;, end &quot;</span> +</span><br><span class="line">                                <span class="string">&quot;position = &quot;</span> + spans.endPosition());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//================================================================</span></span><br><span class="line">            <span class="comment">// 输出结果是</span></span><br><span class="line">            <span class="comment">// doc id = 0, doc IDX= 1, start position = 14, end position = 17</span></span><br><span class="line">            <span class="comment">// doc id = 0, doc IDX = 1, start position = 24, end position = 26</span></span><br><span class="line">            <span class="comment">//================================================================</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="实现逻辑与查询"><a href="#实现逻辑与查询" class="headerlink" title="实现逻辑与查询"></a>实现逻辑与查询</h4><p>通过上面的图，想必你也知道，Lucene官方并不对SpanAndQuery提供支持，在Lucene的官方讨论组中，有人发起过<a target="_blank" rel="noopener" href="https://issues.apache.org/jira/browse/LUCENE-3371">支持SpanAndQuery的issue</a>，但是一直没有获得官方的回应。不过已经有商业公司实现了这种搜索技术，公司名称是<a target="_blank" rel="noopener" href="https://www.searchtechnologies.com/">SearchTechnologies</a>，API参见<a target="_blank" rel="noopener" href="https://wiki.searchtechnologies.com/javadoc/qpl0.3snap/index.html?com/searchtechnologies/qpl/solr/queryoperators/SpanAndQuery.html">SpanAndQuery</a>，但是并不开源（So Sad），我没有找到其实现的具体源码，如果你知道的话，烦请告知我一下。</p>
<p>既然官方不予支持，那就只能自己造轮子了，逻辑上来讲，也不复杂，有两种方式可以实现。</p>
<p>第一种方式，从词的角度，例如『爱你』和『你中』两个搜索词实现逻辑与，那么只要分别地把每一个搜索词都单独搜一下，最后在命中结果中取交集，就可以实现逻辑与的功能，代码写起来也很简单，在此不予示例。</p>
<p>第二种方式，从Term的角度，例如『爱你』如果按字切分，那么能够切成两个Term，分别是『爱』和『你』，这时候使用SpanNearQuery构造查询语句，加上一个很大的slop，但是不管slop多大，它总是有上限的，万一两个Term之间的距离超过slop，同样无法命中，所以说这种实现方式是存在漏洞的，除非你确定你的两个Term之间的距离不会超过某个具体的slop值，那么可以使用之。</p>
<p>注意在使用SpanNearQuery获取positions信息的时候，你不能够同时保证按字切分，又可以在两个搜索词之间设置slop值，这是因为如果用BooleanQuery去包装两个SpanNearQuery，那么将丢失positions信息。如果不按字切分，那么切出来的某个词就是一个Term，即将『爱你』和『你中』看成是两个Term，这时候是可以设置slop值的。如果按字切分，那么切成『爱|你』和『你|中』，实现逻辑与，如果设置slop值，相当于是『爱|slop值|你|slop值|你|slop值|中』，已经与逻辑与不匹配了，逻辑与的本意是『爱|slop值为0|你|slop为任意值|你|slop值为0|中』，请细细体会。</p>
<h4 id="实现逻辑或查询"><a href="#实现逻辑或查询" class="headerlink" title="实现逻辑或查询"></a>实现逻辑或查询</h4><p>官方已经对或逻辑提供了支持，就是SpanOrQuery，直接操练起来即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.lucene.document.Document;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.document.Field;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.document.FieldType;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.document.LongField;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.index.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.search.IndexSearcher;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.search.spans.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.store.RAMDirectory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.apache.lucene.search.spans.SpanNearQuery.newOrderedNearQuery;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * Created by wangxu on 2017/10/13 14:29.</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * Description: TODO</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Wang Xu</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> V1.0.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> V1.0.0 &lt;br/&gt;</span></span><br><span class="line"><span class="comment"> * WebSite: http://codepub.cn &lt;br&gt;</span></span><br><span class="line"><span class="comment"> * Licence: Apache v2 License</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpanOrQueryDemo</span> &#123;</span><br><span class="line">    <span class="meta">@org</span>.junit.Test</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">input</span> <span class="operator">=</span> <span class="string">&quot;现有的中文分词算法可分为三大类：基于字符串匹配的类基分词方法、基于理解的分词方法和基于统计的分词方法。&quot;</span>;</span><br><span class="line">        <span class="type">RAMDirectory</span> <span class="variable">ramDirectory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RAMDirectory</span>();</span><br><span class="line">        <span class="type">IndexWriterConfig</span> <span class="variable">indexWriterConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexWriterConfig</span>(<span class="keyword">new</span> <span class="title class_">ReservePunctuationAnalyzer</span>());</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">IndexWriter</span> <span class="variable">indexWriter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexWriter</span>(ramDirectory, indexWriterConfig)) &#123;</span><br><span class="line">            <span class="type">Document</span> <span class="variable">document</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Document</span>();</span><br><span class="line">            <span class="type">FieldType</span> <span class="variable">fieldType</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FieldType</span>();</span><br><span class="line">            fieldType.setIndexOptions(IndexOptions.DOCS_AND_FREQS_AND_POSITIONS);</span><br><span class="line">            <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Field</span>(<span class="string">&quot;title&quot;</span>, input, fieldType);</span><br><span class="line">            <span class="type">LongField</span> <span class="variable">IDX</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LongField</span>(<span class="string">&quot;IDX&quot;</span>, <span class="number">1</span>, Field.Store.YES);</span><br><span class="line">            document.add(field);</span><br><span class="line">            document.add(IDX);</span><br><span class="line">            indexWriter.addDocument(document);</span><br><span class="line"></span><br><span class="line">            input = <span class="string">&quot;计算机算法是很难很复杂滴&quot;</span>;</span><br><span class="line">            document = <span class="keyword">new</span> <span class="title class_">Document</span>();</span><br><span class="line">            field = <span class="keyword">new</span> <span class="title class_">Field</span>(<span class="string">&quot;title&quot;</span>, input, fieldType);</span><br><span class="line">            IDX = <span class="keyword">new</span> <span class="title class_">LongField</span>(<span class="string">&quot;IDX&quot;</span>, <span class="number">2</span>, Field.Store.YES);</span><br><span class="line">            document.add(field);</span><br><span class="line">            document.add(IDX);</span><br><span class="line">            indexWriter.addDocument(document);</span><br><span class="line"></span><br><span class="line">            input = <span class="string">&quot;计算机算法可以大幅度提升程序性能&quot;</span>;</span><br><span class="line">            document = <span class="keyword">new</span> <span class="title class_">Document</span>();</span><br><span class="line">            field = <span class="keyword">new</span> <span class="title class_">Field</span>(<span class="string">&quot;title&quot;</span>, input, fieldType);</span><br><span class="line">            IDX = <span class="keyword">new</span> <span class="title class_">LongField</span>(<span class="string">&quot;IDX&quot;</span>, <span class="number">3</span>, Field.Store.YES);</span><br><span class="line">            document.add(field);</span><br><span class="line">            document.add(IDX);</span><br><span class="line">            indexWriter.addDocument(document);</span><br><span class="line">            indexWriter.commit();</span><br><span class="line">            <span class="type">IndexSearcher</span> <span class="variable">indexSearcher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexSearcher</span>(DirectoryReader.open(ramDirectory));</span><br><span class="line"></span><br><span class="line">            <span class="type">SpanTermQuery</span> <span class="variable">first</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpanTermQuery</span>(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">&quot;title&quot;</span>, <span class="string">&quot;类&quot;</span>));</span><br><span class="line">            <span class="type">SpanTermQuery</span> <span class="variable">second</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpanTermQuery</span>(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">&quot;title&quot;</span>, <span class="string">&quot;基&quot;</span>));</span><br><span class="line">            <span class="type">SpanNearQuery</span> <span class="variable">spanNearQueryFirst</span> <span class="operator">=</span> newOrderedNearQuery(<span class="string">&quot;title&quot;</span>).addClause(first).addClause(second).build();</span><br><span class="line"></span><br><span class="line">            first = <span class="keyword">new</span> <span class="title class_">SpanTermQuery</span>(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">&quot;title&quot;</span>, <span class="string">&quot;算&quot;</span>));</span><br><span class="line">            second = <span class="keyword">new</span> <span class="title class_">SpanTermQuery</span>(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">&quot;title&quot;</span>, <span class="string">&quot;法&quot;</span>));</span><br><span class="line">            <span class="type">SpanNearQuery</span> <span class="variable">spanNearQuerySecond</span> <span class="operator">=</span> newOrderedNearQuery(<span class="string">&quot;title&quot;</span>).addClause(first).addClause(second).build();</span><br><span class="line">            <span class="type">SpanOrQuery</span> <span class="variable">spanOrQuery</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpanOrQuery</span>(spanNearQueryFirst, spanNearQuerySecond);</span><br><span class="line"></span><br><span class="line">            <span class="type">SpanWeight</span> <span class="variable">weight</span> <span class="operator">=</span> spanOrQuery.createWeight(indexSearcher, <span class="literal">true</span>);</span><br><span class="line">            List&lt;LeafReaderContext&gt; leaves = indexSearcher.getIndexReader().getContext().leaves();</span><br><span class="line">            <span class="keyword">for</span> (LeafReaderContext leaf : leaves) &#123;</span><br><span class="line">                <span class="type">Spans</span> <span class="variable">spans</span> <span class="operator">=</span> weight.getSpans(leaf, SpanWeight.Postings.POSITIONS);</span><br><span class="line">                <span class="keyword">while</span> (spans.nextDoc() != Spans.NO_MORE_DOCS) &#123;</span><br><span class="line">                    <span class="type">Document</span> <span class="variable">doc</span> <span class="operator">=</span> leaf.reader().document(spans.docID());</span><br><span class="line">                    <span class="keyword">while</span> (spans.nextStartPosition() != Spans.NO_MORE_POSITIONS) &#123;</span><br><span class="line">                        System.out.println(<span class="string">&quot;doc id = &quot;</span> + spans.docID() + <span class="string">&quot;, doc IDX= &quot;</span> + doc.get(<span class="string">&quot;IDX&quot;</span>) + <span class="string">&quot;, start position = &quot;</span> + spans.startPosition() + <span class="string">&quot;, end &quot;</span> +</span><br><span class="line">                                <span class="string">&quot;position = &quot;</span> + spans.endPosition());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//================================================================</span></span><br><span class="line">            <span class="comment">// 输出结果是</span></span><br><span class="line">            <span class="comment">// doc id = 0, doc IDX= 1, start position = 7, end position = 9</span></span><br><span class="line">            <span class="comment">// doc id = 0, doc IDX= 1, start position = 24, end position = 26</span></span><br><span class="line">            <span class="comment">// doc id = 1, doc IDX= 2, start position = 3, end position = 5</span></span><br><span class="line">            <span class="comment">// doc id = 2, doc IDX= 3, start position = 3, end position = 5</span></span><br><span class="line">            <span class="comment">//================================================================</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="实现SpanAllNearQuery"><a href="#实现SpanAllNearQuery" class="headerlink" title="实现SpanAllNearQuery"></a>实现SpanAllNearQuery</h3><p>这是一个附加功能，因为目前还没有碰到这样的需求，但是这种查询实现起来非常有意思，所以在此简单讲解一下。这个问题的来源是有人提了个<a target="_blank" rel="noopener" href="https://issues.apache.org/jira/browse/LUCENE-3371">issue</a>，请求官方支持SpanAllNearQuery，但是同样地，官方不理不睬。果然公益的就是拽啊，完全不倾听用户的需求，不像商业公司，为了赚用户的钱，只要用户有需求，就尽力实现。</p>
<p>那么这个需求是什么样的呢？简单表示如下<code>a WITHIN 5 WORDS OF (b AND c)</code>，还可以把它换一种方式理解<code>(a WITHIN 5 WORDS OF b) AND (a WITHIN 5 WORDS OF c)</code>，就是说我要查询，在a的前面5个或者后面5个token中出现b和c的所有结果集。要实现这个功能，需要借助于SpanNotQuery和SpanOrQuery，SpanOrQuery在实现或逻辑中已经介绍过了，那么SpanNotQuery又是什么意思呢？举例如下</p>
<blockquote>
<p>SpanNotQuery(a, b, 5, 5)表示在a的前5个或者后5个token中不能出现b<br>SpanNotQuery(a, c, 5, 5)表示在a的前5个或者后5个token中不能出现c</p>
</blockquote>
<p>下面先从逻辑上先实现这个需求，要获得在a的前面或后面5个token中出现b和c，需要将其反转理解，先查询在a的前面5个或者后面5个token中不能出现b『SpanNotQuery(a, b, 5, 5)』或者在a的前面5个或者后面5个token中不能出现c的结果『SpanNotQuery(a, c, 5, 5)』，再用SpanOrQuery来组合『SpanNotQuery(a, b, 5, 5)』和『SpanNotQuery(a, c, 5, 5)』实现或逻辑，最后用SpanNotQuery排除掉SpanOrQuery的结果集，那么剩下的就是在a的前面5个或者后面5个能出现b也能出现c的结果。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.lucene.analysis.core.WhitespaceAnalyzer;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.document.Document;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.document.Field;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.document.IntField;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.document.TextField;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.index.DirectoryReader;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.index.IndexWriter;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.index.IndexWriterConfig;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.index.Term;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.search.IndexSearcher;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.search.ScoreDoc;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.search.TopDocs;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.search.spans.SpanNotQuery;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.search.spans.SpanOrQuery;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.search.spans.SpanTermQuery;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.store.RAMDirectory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment">  * Created by wangxu on 2017/06/16 16:02.</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment">  * &lt;p&gt;</span></span><br><span class="line"><span class="comment">  * Description: TODO</span></span><br><span class="line"><span class="comment">  * &lt;/p&gt;</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Wang Xu</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> V1.0.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> V1.0.0 &lt;br/&gt;</span></span><br><span class="line"><span class="comment">  * WebSite: http://codepub.cn &lt;br&gt;</span></span><br><span class="line"><span class="comment">  * Licence: Apache v2 License</span></span><br><span class="line"><span class="comment"> */</span><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpanAllNearQueryDemo</span> &#123;</span><br><span class="line">    <span class="meta">@org</span>.junit.Test</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">RAMDirectory</span> <span class="variable">ramDirectory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RAMDirectory</span>();</span><br><span class="line">  <span class="type">IndexWriter</span> <span class="variable">indexWriter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexWriter</span>(ramDirectory, <span class="keyword">new</span> <span class="title class_">IndexWriterConfig</span>(<span class="keyword">new</span> <span class="title class_">WhitespaceAnalyzer</span>()));</span><br><span class="line">  <span class="type">Document</span> <span class="variable">document</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Document</span>();</span><br><span class="line">  document.add(<span class="keyword">new</span> <span class="title class_">TextField</span>(<span class="string">&quot;key&quot;</span>, <span class="string">&quot;X b X X X X a X X X X c X&quot;</span>, Field.Store.YES));<span class="comment">//命中</span></span><br><span class="line">  document.add(<span class="keyword">new</span> <span class="title class_">IntField</span>(<span class="string">&quot;IDX&quot;</span>, <span class="number">1</span>, Field.Store.YES));</span><br><span class="line">  indexWriter.addDocument(document);</span><br><span class="line"></span><br><span class="line">  document = <span class="keyword">new</span> <span class="title class_">Document</span>();</span><br><span class="line">  document.add(<span class="keyword">new</span> <span class="title class_">TextField</span>(<span class="string">&quot;key&quot;</span>, <span class="string">&quot;X X X X X b a c X X X X X&quot;</span>, Field.Store.YES));<span class="comment">//命中</span></span><br><span class="line">  document.add(<span class="keyword">new</span> <span class="title class_">IntField</span>(<span class="string">&quot;IDX&quot;</span>, <span class="number">2</span>, Field.Store.YES));</span><br><span class="line">  indexWriter.addDocument(document);</span><br><span class="line"></span><br><span class="line">  document = <span class="keyword">new</span> <span class="title class_">Document</span>();</span><br><span class="line">  document.add(<span class="keyword">new</span> <span class="title class_">TextField</span>(<span class="string">&quot;key&quot;</span>, <span class="string">&quot;X b X X X X a a X X X X c&quot;</span>, Field.Store.YES));<span class="comment">//不命中，不能同时以两个a为中心，两个a必选其一</span></span><br><span class="line">  document.add(<span class="keyword">new</span> <span class="title class_">IntField</span>(<span class="string">&quot;IDX&quot;</span>, <span class="number">3</span>, Field.Store.YES));</span><br><span class="line">  indexWriter.addDocument(document);</span><br><span class="line"></span><br><span class="line">  document = <span class="keyword">new</span> <span class="title class_">Document</span>();</span><br><span class="line">  document.add(<span class="keyword">new</span> <span class="title class_">TextField</span>(<span class="string">&quot;key&quot;</span>, <span class="string">&quot;X b X X X X X a X X X X c&quot;</span>, Field.Store.YES));<span class="comment">//不命中</span></span><br><span class="line">  document.add(<span class="keyword">new</span> <span class="title class_">IntField</span>(<span class="string">&quot;IDX&quot;</span>, <span class="number">4</span>, Field.Store.YES));</span><br><span class="line">  indexWriter.addDocument(document);</span><br><span class="line"></span><br><span class="line">  document = <span class="keyword">new</span> <span class="title class_">Document</span>();</span><br><span class="line">  document.add(<span class="keyword">new</span> <span class="title class_">TextField</span>(<span class="string">&quot;key&quot;</span>, <span class="string">&quot;X b X X X X a X X X X X c&quot;</span>, Field.Store.YES));<span class="comment">//不命中</span></span><br><span class="line">  document.add(<span class="keyword">new</span> <span class="title class_">IntField</span>(<span class="string">&quot;IDX&quot;</span>, <span class="number">5</span>, Field.Store.YES));</span><br><span class="line">  indexWriter.addDocument(document);</span><br><span class="line"></span><br><span class="line">  document = <span class="keyword">new</span> <span class="title class_">Document</span>();</span><br><span class="line">  document.add(<span class="keyword">new</span> <span class="title class_">TextField</span>(<span class="string">&quot;key&quot;</span>, <span class="string">&quot;b X X X X X a X X X X X c&quot;</span>, Field.Store.YES));<span class="comment">//不命中</span></span><br><span class="line">  document.add(<span class="keyword">new</span> <span class="title class_">IntField</span>(<span class="string">&quot;IDX&quot;</span>, <span class="number">6</span>, Field.Store.YES));</span><br><span class="line">  indexWriter.addDocument(document);</span><br><span class="line"></span><br><span class="line">  document = <span class="keyword">new</span> <span class="title class_">Document</span>();</span><br><span class="line">  document.add(<span class="keyword">new</span> <span class="title class_">TextField</span>(<span class="string">&quot;key&quot;</span>, <span class="string">&quot;b X X X X X a X X X X X X&quot;</span>, Field.Store.YES));<span class="comment">//不命中</span></span><br><span class="line">  document.add(<span class="keyword">new</span> <span class="title class_">IntField</span>(<span class="string">&quot;IDX&quot;</span>, <span class="number">7</span>, Field.Store.YES));</span><br><span class="line">  indexWriter.addDocument(document);</span><br><span class="line"></span><br><span class="line">  document = <span class="keyword">new</span> <span class="title class_">Document</span>();</span><br><span class="line">  document.add(<span class="keyword">new</span> <span class="title class_">TextField</span>(<span class="string">&quot;key&quot;</span>, <span class="string">&quot;X X X X X X a X X X X X X&quot;</span>, Field.Store.YES));<span class="comment">//不命中</span></span><br><span class="line">  document.add(<span class="keyword">new</span> <span class="title class_">IntField</span>(<span class="string">&quot;IDX&quot;</span>, <span class="number">8</span>, Field.Store.YES));</span><br><span class="line">  indexWriter.addDocument(document);</span><br><span class="line">  indexWriter.commit();</span><br><span class="line"></span><br><span class="line">  <span class="type">IndexSearcher</span> <span class="variable">indexSearcher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexSearcher</span>(DirectoryReader.open(indexWriter));</span><br><span class="line">  <span class="type">SpanTermQuery</span> <span class="variable">a</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpanTermQuery</span>(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">&quot;key&quot;</span>, <span class="string">&quot;a&quot;</span>));</span><br><span class="line">  <span class="type">SpanTermQuery</span> <span class="variable">b</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpanTermQuery</span>(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">&quot;key&quot;</span>, <span class="string">&quot;b&quot;</span>));</span><br><span class="line">  <span class="type">SpanTermQuery</span> <span class="variable">c</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpanTermQuery</span>(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">&quot;key&quot;</span>, <span class="string">&quot;c&quot;</span>));</span><br><span class="line">  <span class="type">SpanOrQuery</span> <span class="variable">exclude</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpanOrQuery</span>(<span class="keyword">new</span> <span class="title class_">SpanNotQuery</span>(a, b, <span class="number">5</span>, <span class="number">5</span>), <span class="keyword">new</span> <span class="title class_">SpanNotQuery</span>(a, c, <span class="number">5</span>, <span class="number">5</span>));</span><br><span class="line">  <span class="comment">//排除在a的前5个或者后5个不能出现b也不能出现c的document，那么剩下的就是在a的前5个token或者后5个token能够出现b和c的document</span></span><br><span class="line">  <span class="type">SpanNotQuery</span> <span class="variable">spanNotQuery</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpanNotQuery</span>(a, exclude);</span><br><span class="line">  <span class="type">TopDocs</span> <span class="variable">search</span> <span class="operator">=</span> indexSearcher.search(spanNotQuery, Integer.MAX_VALUE);</span><br><span class="line">  ScoreDoc[] scoreDocs = search.scoreDocs;</span><br><span class="line"> <span class="keyword">for</span> (ScoreDoc scoreDoc : scoreDocs) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;hist IDX: &quot;</span> + indexSearcher.doc(scoreDoc.doc).get(<span class="string">&quot;IDX&quot;</span>));</span><br><span class="line">  &#125;</span><br><span class="line">        indexSearcher.getIndexReader().close();</span><br><span class="line">  indexWriter.close();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SpanNearQuery实现通配符查询"><a href="#SpanNearQuery实现通配符查询" class="headerlink" title="SpanNearQuery实现通配符查询"></a>SpanNearQuery实现通配符查询</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.yuewen.nrzx.character.analyzer.ReservePunctuationAnalyzer;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.document.Document;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.document.Field;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.document.FieldType;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.document.LongField;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.index.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.search.IndexSearcher;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.search.TopDocs;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.search.WildcardQuery;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.search.spans.SpanMultiTermQueryWrapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.search.spans.SpanNearQuery;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.search.spans.SpanQuery;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.search.spans.SpanTermQuery;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.store.RAMDirectory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpanNearQueryAndWildcardQueryDemo</span> &#123;</span><br><span class="line">    <span class="meta">@org</span>.junit.Test</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">input</span> <span class="operator">=</span> <span class="string">&quot;现有的中文分词算法可分为三大类：基于字符串匹配的类基分词方法、基于理解的分词方法和基于统计的分词方法。&quot;</span>;</span><br><span class="line">        <span class="type">RAMDirectory</span> <span class="variable">ramDirectory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RAMDirectory</span>();</span><br><span class="line">        <span class="type">IndexWriterConfig</span> <span class="variable">indexWriterConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexWriterConfig</span>(<span class="keyword">new</span> <span class="title class_">ReservePunctuationAnalyzer</span>());</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">IndexWriter</span> <span class="variable">indexWriter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexWriter</span>(ramDirectory, indexWriterConfig)) &#123;</span><br><span class="line">            <span class="type">Document</span> <span class="variable">document</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Document</span>();</span><br><span class="line">            <span class="type">FieldType</span> <span class="variable">fieldType</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FieldType</span>();</span><br><span class="line">            fieldType.setIndexOptions(IndexOptions.DOCS_AND_FREQS_AND_POSITIONS);</span><br><span class="line">            <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Field</span>(<span class="string">&quot;title&quot;</span>, input, fieldType);</span><br><span class="line">            <span class="type">LongField</span> <span class="variable">IDX</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LongField</span>(<span class="string">&quot;IDX&quot;</span>, <span class="number">1</span>, Field.Store.YES);</span><br><span class="line">            document.add(field);</span><br><span class="line">            document.add(IDX);</span><br><span class="line">            indexWriter.addDocument(document);</span><br><span class="line"></span><br><span class="line">            input = <span class="string">&quot;计算机算法是很难很复杂滴&quot;</span>;</span><br><span class="line">            document = <span class="keyword">new</span> <span class="title class_">Document</span>();</span><br><span class="line">            field = <span class="keyword">new</span> <span class="title class_">Field</span>(<span class="string">&quot;title&quot;</span>, input, fieldType);</span><br><span class="line">            IDX = <span class="keyword">new</span> <span class="title class_">LongField</span>(<span class="string">&quot;IDX&quot;</span>, <span class="number">2</span>, Field.Store.YES);</span><br><span class="line">            document.add(field);</span><br><span class="line">            document.add(IDX);</span><br><span class="line">            indexWriter.addDocument(document);</span><br><span class="line"></span><br><span class="line">            input = <span class="string">&quot;计算机算法可以大幅度提升程序性能&quot;</span>;</span><br><span class="line">            document = <span class="keyword">new</span> <span class="title class_">Document</span>();</span><br><span class="line">            field = <span class="keyword">new</span> <span class="title class_">Field</span>(<span class="string">&quot;title&quot;</span>, input, fieldType);</span><br><span class="line">            IDX = <span class="keyword">new</span> <span class="title class_">LongField</span>(<span class="string">&quot;IDX&quot;</span>, <span class="number">3</span>, Field.Store.YES);</span><br><span class="line">            document.add(field);</span><br><span class="line">            document.add(IDX);</span><br><span class="line">            indexWriter.addDocument(document);</span><br><span class="line">            indexWriter.commit();</span><br><span class="line">            <span class="type">IndexSearcher</span> <span class="variable">indexSearcher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexSearcher</span>(DirectoryReader.open(ramDirectory));</span><br><span class="line">            <span class="comment">// 用?和*均可以实现SpanNearQuery的通配符查询，但是注意*在通配符查询中表示可以匹配0个或多个字符</span></span><br><span class="line">            <span class="comment">// 但是在SpanQuery中只能匹配相当于slop=1的情形，不能匹配slop大于1的情形</span></span><br><span class="line">            <span class="type">SpanTermQuery</span> <span class="variable">first</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpanTermQuery</span>(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">&quot;title&quot;</span>, <span class="string">&quot;复&quot;</span>));</span><br><span class="line">            <span class="type">SpanQuery</span> <span class="variable">wildcard</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpanMultiTermQueryWrapper</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">WildcardQuery</span>(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">&quot;title&quot;</span>, <span class="string">&quot;?&quot;</span>)));</span><br><span class="line">            <span class="type">SpanTermQuery</span> <span class="variable">last</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpanTermQuery</span>(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">&quot;title&quot;</span>, <span class="string">&quot;滴&quot;</span>));</span><br><span class="line"></span><br><span class="line">            <span class="type">SpanNearQuery</span> <span class="variable">spanNearQuery</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpanNearQuery</span>.Builder(<span class="string">&quot;title&quot;</span>, <span class="literal">true</span>).addClause(first).addClause(wildcard).addClause(last).build();</span><br><span class="line">            <span class="type">TopDocs</span> <span class="variable">search</span> <span class="operator">=</span> indexSearcher.search(spanNearQuery, Integer.MAX_VALUE);</span><br><span class="line">            System.out.println(<span class="string">&quot;IDX: &quot;</span> + indexSearcher.doc(search.scoreDocs[<span class="number">0</span>].doc).get(<span class="string">&quot;IDX&quot;</span>));</span><br><span class="line"></span><br><span class="line">            wildcard = <span class="keyword">new</span> <span class="title class_">SpanMultiTermQueryWrapper</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">WildcardQuery</span>(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">&quot;title&quot;</span>, <span class="string">&quot;*&quot;</span>)));</span><br><span class="line">            spanNearQuery = <span class="keyword">new</span> <span class="title class_">SpanNearQuery</span>.Builder(<span class="string">&quot;title&quot;</span>, <span class="literal">true</span>).addClause(first).addClause(wildcard).addClause(last).build();</span><br><span class="line">            search = indexSearcher.search(spanNearQuery, Integer.MAX_VALUE);</span><br><span class="line">            System.out.println(<span class="string">&quot;IDX: &quot;</span> + indexSearcher.doc(search.scoreDocs[<span class="number">0</span>].doc).get(<span class="string">&quot;IDX&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="实验"><a href="#实验" class="headerlink" title="实验"></a>实验</h3><p>服务器 CPU 以及内存信息</p>
<blockquote>
<p>$ cat &#x2F;proc&#x2F;cpuinfo | grep name | cut -f2 -d: | uniq -c</p>
</blockquote>
<p><code>24  Intel(R) Xeon(R) CPU E5-2420 v2 @ 2.20GHz</code></p>
<blockquote>
<p>$ free -g</p>
</blockquote>
<p>||total|used|free|shared|buffers|cached|<br>|–|–|–|–|–|–|<br>|Mem|62|56|6|0|0|1|<br>|-&#x2F;+ buffers&#x2F;cache|54|8|||||<br>|Swap|1|0|1|||||</p>
<p>在公司内部，仅仅索引了十分之一的文档（Document数量：20023911），鉴于没有存储Field，也没有存储TermVectors，索引不算太大，简单测试了下，如果存储TermVectors的话，索引会从112GB增长到162GB，如果再存储Field的话，那么索引要超过200GB。此处的实验只是简单的单次搜索，没有测试与逻辑和或逻辑情况下的搜索情况。搜索阶段实验的结果如下所示</p>
<table>
<thead>
<tr>
<th>线程数目</th>
<th>搜索总次数</th>
<th>命中次数</th>
<th>搜索总耗时</th>
<th>平均单次耗时</th>
<th>搜索加构建Query耗时</th>
<th>平均单次耗时</th>
<th>索引大小</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>18820</td>
<td>18139</td>
<td>36001,698ms</td>
<td>1912.95ms</td>
<td>36011,989ms</td>
<td>1913.50ms</td>
<td>112GB</td>
</tr>
<tr>
<td>5</td>
<td>18820</td>
<td>18139</td>
<td>30775,283ms</td>
<td>1635.24ms</td>
<td>30785,538ms</td>
<td>1635.79ms</td>
<td>112GB</td>
</tr>
<tr>
<td>10</td>
<td>18820</td>
<td>18139</td>
<td>21637,515ms</td>
<td>1149.71ms</td>
<td>21647,953ms</td>
<td>1150.26ms</td>
<td>112GB</td>
</tr>
<tr>
<td>50</td>
<td>18820</td>
<td>18139</td>
<td>21572,506ms</td>
<td>1146.25ms</td>
<td>21583,101ms</td>
<td>1146.82ms</td>
<td>112GB</td>
</tr>
</tbody></table>
<p>索引阶段并没有做详细完备的实验，只是简单拉取了一点数据，记录如下，仅供参考。索引2080550个Document，统计从数据库拉取数据加更新数据到索引耗时2133s，平均每次耗时0.001s。只计算更新数据到索引中，不计算从数据库拉取数据耗时464s，平均每次耗时0.0002s，可见索引速度也是很快的，这全部得益于Lucene的优良设计。</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Lucene/" rel="tag"># Lucene</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/several-ways-to-get-the-field-values-that-are-not-stored-in-lucene/" rel="prev" title="Lucene 中获取没有存储的字段值的几种方法">
                  <i class="fa fa-angle-left"></i> Lucene 中获取没有存储的字段值的几种方法
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/lucene-group-statistics-detailed/" rel="next" title="Lucene 分组统计详解">
                  Lucene 分组统计详解 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">DJY</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
